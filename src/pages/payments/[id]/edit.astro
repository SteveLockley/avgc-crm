---
import AdminLayout from '../../../layouts/AdminLayout.astro';
import { PAYMENT_METHODS, formatDate } from '../../../lib/db';

const { id } = Astro.params;
const db = Astro.locals.runtime.env.DB;

let error = '';
let success = '';

// Get payment details
const payment = await db.prepare(
  `SELECT p.*, m.first_name, m.surname
   FROM payments p
   JOIN members m ON p.member_id = m.id
   WHERE p.id = ?`
).bind(id).first();

if (!payment) {
  return Astro.redirect('/payments');
}

if (Astro.request.method === 'POST') {
  const formData = await Astro.request.formData();
  const action = formData.get('action');

  if (action === 'delete') {
    await db.prepare('DELETE FROM payments WHERE id = ?').bind(id).run();

    await db.prepare(
      `INSERT INTO audit_log (user_email, action, entity_type, entity_id)
       VALUES (?, 'delete', 'payment', ?)`
    ).bind(Astro.locals.user?.email || 'system', id).run();

    return Astro.redirect(`/members/${payment.member_id}`);
  }

  const amount = parseFloat(formData.get('amount')?.toString() || '0');
  const paymentDate = formData.get('payment_date');
  const paymentMethod = formData.get('payment_method');
  const paymentType = formData.get('payment_type');
  const reference = formData.get('reference');
  const notes = formData.get('notes');

  try {
    await db.prepare(
      `UPDATE payments SET amount = ?, payment_date = ?, payment_method = ?, payment_type = ?, reference = ?, notes = ?
       WHERE id = ?`
    ).bind(
      amount,
      paymentDate,
      paymentMethod || null,
      paymentType || null,
      reference || null,
      notes || null,
      id
    ).run();

    success = 'Payment updated successfully';

    // Refresh payment data
    const updated = await db.prepare(
      `SELECT p.*, m.first_name, m.surname
       FROM payments p
       JOIN members m ON p.member_id = m.id
       WHERE p.id = ?`
    ).bind(id).first();
    if (updated) {
      Object.assign(payment, updated);
    }
  } catch (e: any) {
    error = `Failed to update payment: ${e.message}`;
  }
}

const paymentTypes = [
  { value: 'subscription', label: 'Subscription' },
  { value: 'competition_fee', label: 'Competition Fee' },
  { value: 'bar', label: 'Bar' },
  { value: 'shop', label: 'Shop' },
  { value: 'other', label: 'Other' }
];

function formatDateForInput(dateStr: string | null): string {
  if (!dateStr) return '';
  try {
    if (dateStr.includes('/')) {
      const [day, month, year] = dateStr.split('/');
      return `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
    }
    const date = new Date(dateStr);
    return date.toISOString().split('T')[0];
  } catch {
    return '';
  }
}
---

<AdminLayout title="Edit Payment">
  <div style="display: flex; gap: 1rem; margin-bottom: 1.5rem;">
    <a href={`/members/${payment.member_id}`} class="btn btn-secondary">&larr; Back to Member</a>
  </div>

  {error && <div class="alert alert-error">{error}</div>}
  {success && <div class="alert alert-success">{success}</div>}

  <div class="card">
    <div class="card-header">
      <h3 class="card-title">Edit Payment for {payment.first_name} {payment.surname}</h3>
    </div>

    <form method="POST">
      <div class="form-row">
        <div class="form-group">
          <label class="form-label" for="amount">Amount (Â£) *</label>
          <input type="number" step="0.01" name="amount" id="amount" class="form-input" required
                 value={payment.amount} />
        </div>

        <div class="form-group">
          <label class="form-label" for="payment_date">Payment Date *</label>
          <input type="date" name="payment_date" id="payment_date" class="form-input" required
                 value={formatDateForInput(payment.payment_date as string)} />
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label class="form-label" for="payment_method">Payment Method</label>
          <select name="payment_method" id="payment_method" class="form-input">
            <option value="">-</option>
            {PAYMENT_METHODS.map(pm => (
              <option value={pm} selected={payment.payment_method === pm}>{pm}</option>
            ))}
          </select>
        </div>

        <div class="form-group">
          <label class="form-label" for="payment_type">Payment Type</label>
          <select name="payment_type" id="payment_type" class="form-input">
            <option value="">-</option>
            {paymentTypes.map(pt => (
              <option value={pt.value} selected={payment.payment_type === pt.value}>{pt.label}</option>
            ))}
          </select>
        </div>

        <div class="form-group">
          <label class="form-label" for="reference">Reference</label>
          <input type="text" name="reference" id="reference" class="form-input"
                 value={payment.reference || ''} />
        </div>
      </div>

      <div class="form-group">
        <label class="form-label" for="notes">Notes</label>
        <textarea name="notes" id="notes" class="form-input" rows="2">{payment.notes || ''}</textarea>
      </div>

      <div style="display: flex; gap: 1rem; justify-content: space-between;">
        <form method="POST" style="margin: 0;">
          <input type="hidden" name="action" value="delete" />
          <button type="submit" class="btn btn-danger"
                  onclick="return confirm('Are you sure you want to delete this payment?')">
            Delete Payment
          </button>
        </form>

        <div style="display: flex; gap: 1rem;">
          <a href={`/members/${payment.member_id}`} class="btn btn-secondary">Cancel</a>
          <button type="submit" class="btn btn-primary">Save Changes</button>
        </div>
      </div>
    </form>
  </div>
</AdminLayout>
