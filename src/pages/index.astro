---
import AdminLayout from '../layouts/AdminLayout.astro';
import { formatCurrency, formatDate, calculateEguCategory, type Member } from '../lib/db';

const db = Astro.locals.runtime.env.DB;

// Get member statistics
const totalMembers = await db.prepare(
  'SELECT COUNT(*) as count FROM members'
).first<{ count: number }>();

const activeMembers = await db.prepare(
  `SELECT COUNT(*) as count FROM members
   WHERE date_expires >= date('now') OR date_expires IS NULL`
).first<{ count: number }>();

const expiringMembers = await db.prepare(
  `SELECT COUNT(*) as count FROM members
   WHERE date_expires BETWEEN date('now') AND date('now', '+30 days')`
).first<{ count: number }>();

const expiredMembers = await db.prepare(
  `SELECT COUNT(*) as count FROM members
   WHERE date_expires < date('now')`
).first<{ count: number }>();

// Get subscription type breakdown
const subscriptionBreakdown = await db.prepare(
  `SELECT subscription_template, COUNT(*) as count
   FROM members
   WHERE subscription_template IS NOT NULL AND subscription_template != ''
   GROUP BY subscription_template
   ORDER BY count DESC`
).all<{ subscription_template: string; count: number }>();

// Get all members for EGU category calculation
const allMembersForEgu = await db.prepare(
  `SELECT gender, date_of_birth, home_away, home_club
   FROM members
   WHERE subscription_template IS NOT NULL AND subscription_template != ''`
).all();
const membersData = (allMembersForEgu.results || []) as Pick<Member, 'gender' | 'date_of_birth' | 'home_away' | 'home_club'>[];

// Calculate EGU category counts
const eguCategoryCounts: Record<string, number> = {};
membersData.forEach(member => {
  const eguCat = calculateEguCategory(member);
  if (eguCat) {
    eguCategoryCounts[eguCat] = (eguCategoryCounts[eguCat] || 0) + 1;
  }
});
const eguCategoryBreakdown = Object.entries(eguCategoryCounts)
  .map(([category, count]) => ({ category, count }))
  .sort((a, b) => b.count - a.count);

// Get recent payments with invoice info
const recentPayments = await db.prepare(
  `SELECT p.*, m.first_name, m.surname, i.invoice_number
   FROM payments p
   JOIN members m ON p.member_id = m.id
   LEFT JOIN invoices i ON p.invoice_id = i.id
   ORDER BY p.payment_date DESC
   LIMIT 5`
).all();

// Get total outstanding balance
const outstandingBalance = await db.prepare(
  `SELECT SUM(account_balance) as total FROM members WHERE account_balance < 0`
).first<{ total: number }>();

// Get members expiring soon
const expiringSoon = await db.prepare(
  `SELECT id, first_name, surname, date_expires, subscription_template
   FROM members
   WHERE date_expires BETWEEN date('now') AND date('now', '+30 days')
   ORDER BY date_expires
   LIMIT 10`
).all();
---

<AdminLayout title="Dashboard">
  <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">
    <!-- Member Stats Table -->
    <div class="card">
      <div class="card-header">
        <h3 class="card-title">Member Statistics</h3>
      </div>
      <table>
        <thead>
          <tr>
            <th>Status</th>
            <th style="text-align: right">Count</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>Total Members</td>
            <td style="text-align: right">
              <a href="/members" style="font-weight: 600; font-size: 1.125rem;">
                {totalMembers?.count || 0}
              </a>
            </td>
          </tr>
          <tr>
            <td>Active Members</td>
            <td style="text-align: right">
              <a href="/members?filter=active" style="font-weight: 600; font-size: 1.125rem; color: #28a745;">
                {activeMembers?.count || 0}
              </a>
            </td>
          </tr>
          <tr>
            <td>Expiring in 30 Days</td>
            <td style="text-align: right">
              <a href="/members?filter=expiring" style="font-weight: 600; font-size: 1.125rem; color: #ffc107;">
                {expiringMembers?.count || 0}
              </a>
            </td>
          </tr>
          <tr>
            <td>Expired Members</td>
            <td style="text-align: right">
              <a href="/members?filter=expired" style="font-weight: 600; font-size: 1.125rem; color: #dc3545;">
                {expiredMembers?.count || 0}
              </a>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Members by Subscription Type -->
    <div class="card">
      <div class="card-header">
        <h3 class="card-title">Members by Subscription Type</h3>
      </div>
      <table>
        <thead>
          <tr>
            <th>Subscription Type</th>
            <th style="text-align: right">Count</th>
          </tr>
        </thead>
        <tbody>
          {subscriptionBreakdown.results?.map((sub) => (
            <tr>
              <td>{sub.subscription_template}</td>
              <td style="text-align: right">
                <a href={`/members?subscription_template=${encodeURIComponent(sub.subscription_template)}`} style="font-weight: 500;">
                  {sub.count}
                </a>
              </td>
            </tr>
          ))}
          {(!subscriptionBreakdown.results || subscriptionBreakdown.results.length === 0) && (
            <tr>
              <td colspan="2" style="text-align: center; color: #666;">No data available</td>
            </tr>
          )}
        </tbody>
      </table>
    </div>
  </div>

  <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-top: 1.5rem;">
    <!-- Members by EGU Category -->
    <div class="card">
      <div class="card-header">
        <h3 class="card-title">Members by EGU Category</h3>
      </div>
      <table>
        <thead>
          <tr>
            <th>EGU Category</th>
            <th style="text-align: right">Count</th>
          </tr>
        </thead>
        <tbody>
          {eguCategoryBreakdown.map((cat) => (
            <tr>
              <td style="font-size: 0.875rem;">{cat.category}</td>
              <td style="text-align: right">
                <a href={`/members?egu_category=${encodeURIComponent(cat.category)}`} style="font-weight: 500;">
                  {cat.count}
                </a>
              </td>
            </tr>
          ))}
          {eguCategoryBreakdown.length === 0 && (
            <tr>
              <td colspan="2" style="text-align: center; color: #666;">No data available</td>
            </tr>
          )}
        </tbody>
      </table>
    </div>

    <!-- Expiring Soon -->
    <div class="card">
      <div class="card-header">
        <h3 class="card-title">Expiring Soon</h3>
        <a href="/members?filter=expiring" class="btn btn-secondary btn-sm">View All</a>
      </div>
      <table>
        <thead>
          <tr>
            <th>Name</th>
            <th>Expires</th>
          </tr>
        </thead>
        <tbody>
          {expiringSoon.results?.map((member) => (
            <tr>
              <td>
                <a href={`/members/${member.id}`}>
                  {member.first_name} {member.surname}
                </a>
              </td>
              <td>{formatDate(member.date_expires as string)}</td>
            </tr>
          ))}
          {(!expiringSoon.results || expiringSoon.results.length === 0) && (
            <tr>
              <td colspan="2" style="text-align: center; color: #666;">No members expiring soon</td>
            </tr>
          )}
        </tbody>
      </table>
    </div>
  </div>

  <div class="card" style="margin-top: 1.5rem;">
    <div class="card-header">
      <h3 class="card-title">Recent Payments</h3>
      <a href="/payments" class="btn btn-secondary btn-sm">View All</a>
    </div>
    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>Date</th>
            <th>Member</th>
            <th>Invoice</th>
            <th>Method</th>
            <th style="text-align: right">Amount</th>
          </tr>
        </thead>
        <tbody>
          {recentPayments.results?.map((payment) => (
            <tr>
              <td>{formatDate(payment.payment_date as string)}</td>
              <td>
                <a href={`/members/${payment.member_id}`}>
                  {payment.first_name} {payment.surname}
                </a>
              </td>
              <td>
                {payment.invoice_id ? (
                  <a href={`/invoices/${payment.invoice_id}`} style="font-weight: 500;">
                    {payment.invoice_number}
                  </a>
                ) : (
                  <span style="color: #666;">-</span>
                )}
              </td>
              <td>{payment.payment_method || '-'}</td>
              <td style="text-align: right; font-weight: 500;">{formatCurrency(payment.amount as number)}</td>
            </tr>
          ))}
          {(!recentPayments.results || recentPayments.results.length === 0) && (
            <tr>
              <td colspan="5" style="text-align: center; color: #666;">No recent payments</td>
            </tr>
          )}
        </tbody>
      </table>
    </div>
  </div>

  {outstandingBalance?.total && outstandingBalance.total < 0 && (
    <div class="alert alert-error" style="margin-top: 1.5rem;">
      <strong>Outstanding Balance:</strong> {formatCurrency(Math.abs(outstandingBalance.total))} in member credits/overpayments
    </div>
  )}
</AdminLayout>
