---
// Renewal reminders - members who can be contacted by email
const db = Astro.locals.runtime.env.DB;

const days = parseInt(Astro.url.searchParams.get('days') || '30');

const members = await db.prepare(`
  SELECT surname, first_name, email, category, subscription_template, date_expires
  FROM members
  WHERE date_expires BETWEEN date('now') AND date('now', '+' || ? || ' days')
    AND email IS NOT NULL
    AND email != ''
    AND electronic_communication_consent = 'Yes'
  ORDER BY date_expires, surname
`).bind(days).all();

if (!members.results || members.results.length === 0) {
  return new Response(`No members with email consent expiring in the next ${days} days`, { status: 404 });
}

const columns = ['Surname', 'First Name', 'Email', 'Category', 'Subscription', 'Expires'];

function escapeCSV(value: any): string {
  const str = String(value || '');
  if (str.includes(',') || str.includes('"') || str.includes('\n')) {
    return `"${str.replace(/"/g, '""')}"`;
  }
  return str;
}

let csv = columns.join(',') + '\n';

for (const m of members.results) {
  const row = [
    m.surname,
    m.first_name,
    m.email,
    m.category,
    m.subscription_template,
    m.date_expires
  ].map(escapeCSV);
  csv += row.join(',') + '\n';
}

const filename = `AVGC_Renewal_Reminders_${days}days_${new Date().toISOString().split('T')[0]}.csv`;

return new Response(csv, {
  headers: {
    'Content-Type': 'text/csv; charset=utf-8',
    'Content-Disposition': `attachment; filename="${filename}"`
  }
});
---
