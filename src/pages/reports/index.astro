---
import AdminLayout from '../../layouts/AdminLayout.astro';
import { formatCurrency, formatDate, type PaymentItem } from '../../lib/db';

const db = Astro.locals.runtime.env.DB;

// Subscription type breakdown (category holds subscription type)
const subscriptionStats = await db.prepare(`
  SELECT
    category,
    COUNT(*) as count,
    SUM(CASE WHEN home_away = 'H' THEN 1 ELSE 0 END) as home,
    SUM(CASE WHEN home_away = 'A' THEN 1 ELSE 0 END) as away
  FROM members
  WHERE category IS NOT NULL AND category != ''
  GROUP BY category
  ORDER BY count DESC
`).all();

// Get payment items with revenue from invoices
const paymentItemsResult = await db.prepare(
  `SELECT * FROM payment_items WHERE active = 1 ORDER BY category, name`
).all();
const paymentItems = (paymentItemsResult.results || []) as PaymentItem[];

// Get current year for revenue reporting
const currentYear = new Date().getFullYear();
const currentYearStart = `${currentYear}-01-01`;

// Potential revenue by payment item (all non-cancelled invoices in current year)
const potentialRevenueByItem = await db.prepare(`
  SELECT
    ii.description,
    COUNT(*) as count,
    SUM(ii.line_total) as total_revenue
  FROM invoice_items ii
  JOIN invoices i ON ii.invoice_id = i.id
  WHERE i.status != 'cancelled'
    AND i.period_start >= ?
  GROUP BY ii.description
  ORDER BY total_revenue DESC
`).bind(currentYearStart).all();

// Actual revenue paid by payment item (from payment_line_items table)
const actualRevenueByItem = await db.prepare(`
  SELECT
    pli.description,
    COUNT(*) as count,
    SUM(pli.amount) as total_revenue
  FROM payment_line_items pli
  JOIN payments p ON pli.payment_id = p.id
  JOIN invoices i ON p.invoice_id = i.id
  WHERE i.period_start >= ?
  GROUP BY pli.description
  ORDER BY total_revenue DESC
`).bind(currentYearStart).all();

// Also get total actual payments received for invoices this period
const totalActualPayments = await db.prepare(`
  SELECT SUM(p.amount) as total
  FROM payments p
  JOIN invoices i ON p.invoice_id = i.id
  WHERE i.period_start >= ?
`).bind(currentYearStart).first<{ total: number }>();

// Create a map of actual revenue for easy lookup
const actualRevenueMap: Record<string, { count: number; revenue: number }> = {};
actualRevenueByItem.results?.forEach((item: any) => {
  actualRevenueMap[item.description] = { count: item.count, revenue: item.total_revenue };
});

// Payment statistics - current year (uses currentYear defined above)
const paymentStats = await db.prepare(`
  SELECT
    payment_type,
    COUNT(*) as count,
    SUM(amount) as total
  FROM payments
  WHERE payment_date >= ?
  GROUP BY payment_type
  ORDER BY total DESC
`).bind(`${currentYear}-01-01`).all();

// Monthly payment totals - last 12 months
const monthlyPayments = await db.prepare(`
  SELECT
    strftime('%Y-%m', payment_date) as month,
    SUM(amount) as total,
    COUNT(*) as count
  FROM payments
  WHERE payment_date >= date('now', '-12 months')
  GROUP BY strftime('%Y-%m', payment_date)
  ORDER BY month
`).all();

// Outstanding balances
const outstandingBalances = await db.prepare(`
  SELECT
    SUM(CASE WHEN account_balance < 0 THEN account_balance ELSE 0 END) as credits,
    SUM(CASE WHEN account_balance > 0 THEN account_balance ELSE 0 END) as debits,
    COUNT(CASE WHEN account_balance != 0 THEN 1 END) as members_with_balance
  FROM members
`).first();

// Age group breakdown
const ageStats = await db.prepare(`
  SELECT
    age_group,
    COUNT(*) as count,
    AVG(handicap_index) as avg_handicap
  FROM members
  WHERE age_group IS NOT NULL
  GROUP BY age_group
  ORDER BY count DESC
`).all();

// Recent membership activity
const recentJoins = await db.prepare(`
  SELECT COUNT(*) as count
  FROM members
  WHERE date_joined >= date('now', '-30 days')
`).first();

// Payment method breakdown
const paymentMethodStats = await db.prepare(`
  SELECT
    default_payment_method,
    COUNT(*) as count
  FROM members
  WHERE default_payment_method IS NOT NULL
  GROUP BY default_payment_method
  ORDER BY count DESC
`).all();

// Handicap distribution
const handicapStats = await db.prepare(`
  SELECT
    CASE
      WHEN handicap_index IS NULL THEN 'No Handicap'
      WHEN handicap_index <= 5 THEN '0-5'
      WHEN handicap_index <= 10 THEN '6-10'
      WHEN handicap_index <= 15 THEN '11-15'
      WHEN handicap_index <= 20 THEN '16-20'
      WHEN handicap_index <= 28 THEN '21-28'
      ELSE '29+'
    END as bracket,
    COUNT(*) as count
  FROM members
  GROUP BY bracket
  ORDER BY
    CASE bracket
      WHEN '0-5' THEN 1
      WHEN '6-10' THEN 2
      WHEN '11-15' THEN 3
      WHEN '16-20' THEN 4
      WHEN '21-28' THEN 5
      WHEN '29+' THEN 6
      ELSE 7
    END
`).all();
---

<AdminLayout title="Reports">
  <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">
    <!-- Subscription Type Breakdown -->
    <div class="card">
      <div class="card-header">
        <h3 class="card-title">Members by Subscription Type</h3>
      </div>
      <table>
        <thead>
          <tr>
            <th>Subscription Type</th>
            <th style="text-align: right">Home</th>
            <th style="text-align: right">Away</th>
            <th style="text-align: right">Total</th>
          </tr>
        </thead>
        <tbody>
          {subscriptionStats.results?.map((sub) => (
            <tr>
              <td>{sub.category}</td>
              <td style="text-align: right">{sub.home}</td>
              <td style="text-align: right">{sub.away}</td>
              <td style="text-align: right; font-weight: 600">{sub.count}</td>
            </tr>
          ))}
        </tbody>
      </table>
    </div>

  </div>

  <!-- Revenue by Payment Item -->
  <div class="card" style="margin-top: 1.5rem;">
    <div class="card-header">
      <h3 class="card-title">Revenue by Payment Item ({currentYear}/{currentYear + 1})</h3>
    </div>
    <table>
      <thead>
        <tr>
          <th>Payment Item</th>
          <th style="text-align: right">Invoiced</th>
          <th style="text-align: right">Potential Revenue</th>
          <th style="text-align: right">Paid</th>
          <th style="text-align: right">Actual Revenue</th>
          <th style="text-align: right">Collection %</th>
        </tr>
      </thead>
      <tbody>
        {potentialRevenueByItem.results?.map((item) => {
          const actual = actualRevenueMap[item.description as string] || { count: 0, revenue: 0 };
          const potentialRev = item.total_revenue as number;
          const actualRev = actual.revenue;
          const collectionPct = potentialRev > 0 ? ((actualRev / potentialRev) * 100).toFixed(1) : '0.0';
          return (
            <tr>
              <td>{item.description}</td>
              <td style="text-align: right">{item.count}</td>
              <td style="text-align: right">{formatCurrency(potentialRev)}</td>
              <td style="text-align: right">{actual.count}</td>
              <td style="text-align: right; font-weight: 600; color: #28a745;">{formatCurrency(actualRev)}</td>
              <td style="text-align: right">
                <span class={`badge ${parseFloat(collectionPct) >= 80 ? 'badge-success' : parseFloat(collectionPct) >= 50 ? 'badge-warning' : 'badge-danger'}`}>
                  {collectionPct}%
                </span>
              </td>
            </tr>
          );
        })}
        {(!potentialRevenueByItem.results || potentialRevenueByItem.results.length === 0) && (
          <tr>
            <td colspan="6" style="text-align: center; color: #666;">No invoice data available for current year</td>
          </tr>
        )}
      </tbody>
      {potentialRevenueByItem.results && potentialRevenueByItem.results.length > 0 && (
        <tfoot>
          <tr style="background: #f8f9fa; font-weight: 600;">
            <td>Total</td>
            <td style="text-align: right">{potentialRevenueByItem.results.reduce((sum, item) => sum + (item.count as number), 0)}</td>
            <td style="text-align: right">{formatCurrency(potentialRevenueByItem.results.reduce((sum, item) => sum + (item.total_revenue as number), 0))}</td>
            <td style="text-align: right">{actualRevenueByItem.results?.reduce((sum, item) => sum + (item.count as number), 0) || 0}</td>
            <td style="text-align: right; color: #28a745;">{formatCurrency(actualRevenueByItem.results?.reduce((sum, item) => sum + (item.total_revenue as number), 0) || 0)}</td>
            <td style="text-align: right">
              {(() => {
                const totalPotential = potentialRevenueByItem.results.reduce((sum, item) => sum + (item.total_revenue as number), 0);
                const totalActual = actualRevenueByItem.results?.reduce((sum, item) => sum + (item.total_revenue as number), 0) || 0;
                const pct = totalPotential > 0 ? ((totalActual / totalPotential) * 100).toFixed(1) : '0.0';
                return <span class="badge badge-info">{pct}%</span>;
              })()}
            </td>
          </tr>
        </tfoot>
      )}
    </table>
  </div>

  <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-top: 1.5rem;">
    <!-- Handicap Distribution -->
    <div class="card">
      <div class="card-header">
        <h3 class="card-title">Handicap Distribution</h3>
      </div>
      <table>
        <thead>
          <tr>
            <th>Handicap Range</th>
            <th style="text-align: right">Members</th>
          </tr>
        </thead>
        <tbody>
          {handicapStats.results?.map((h) => (
            <tr>
              <td>{h.bracket}</td>
              <td style="text-align: right">{h.count}</td>
            </tr>
          ))}
        </tbody>
      </table>
    </div>

    <!-- Payment Method Preferences -->
    <div class="card">
      <div class="card-header">
        <h3 class="card-title">Payment Methods</h3>
      </div>
      <table>
        <thead>
          <tr>
            <th>Method</th>
            <th style="text-align: right">Members</th>
          </tr>
        </thead>
        <tbody>
          {paymentMethodStats.results?.map((pm) => (
            <tr>
              <td>{pm.default_payment_method}</td>
              <td style="text-align: right">{pm.count}</td>
            </tr>
          ))}
        </tbody>
      </table>
    </div>
  </div>

  <!-- Financial Overview -->
  <div class="card" style="margin-top: 1.5rem;">
    <div class="card-header">
      <h3 class="card-title">Financial Overview - {currentYear}</h3>
    </div>

    <div class="stats-grid" style="margin-bottom: 1rem;">
      <div class="stat-card">
        <div class="stat-value" style="color: #dc3545">
          {formatCurrency(Math.abs(outstandingBalances?.credits || 0))}
        </div>
        <div class="stat-label">Member Credits (Overpayments)</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" style="color: #28a745">
          {formatCurrency(outstandingBalances?.debits || 0)}
        </div>
        <div class="stat-label">Outstanding Debts</div>
      </div>
      <div class="stat-card">
        <div class="stat-value">{recentJoins?.count || 0}</div>
        <div class="stat-label">New Members (30 days)</div>
      </div>
    </div>

    <h4 style="margin: 1rem 0 0.5rem">Payments by Type ({currentYear})</h4>
    <table>
      <thead>
        <tr>
          <th>Payment Type</th>
          <th style="text-align: right">Count</th>
          <th style="text-align: right">Total</th>
        </tr>
      </thead>
      <tbody>
        {paymentStats.results?.map((pt) => (
          <tr>
            <td>{pt.payment_type || 'Unspecified'}</td>
            <td style="text-align: right">{pt.count}</td>
            <td style="text-align: right; font-weight: 600">{formatCurrency(pt.total as number)}</td>
          </tr>
        ))}
        {(!paymentStats.results || paymentStats.results.length === 0) && (
          <tr>
            <td colspan="3" style="text-align: center; color: #666">No payments recorded this year</td>
          </tr>
        )}
      </tbody>
    </table>
  </div>

  <!-- Monthly Payments Chart (Simple table version) -->
  <div class="card" style="margin-top: 1.5rem;">
    <div class="card-header">
      <h3 class="card-title">Monthly Payment Totals (Last 12 Months)</h3>
    </div>
    <table>
      <thead>
        <tr>
          <th>Month</th>
          <th style="text-align: right">Payments</th>
          <th style="text-align: right">Total</th>
        </tr>
      </thead>
      <tbody>
        {monthlyPayments.results?.map((mp) => (
          <tr>
            <td>{mp.month}</td>
            <td style="text-align: right">{mp.count}</td>
            <td style="text-align: right; font-weight: 600">{formatCurrency(mp.total as number)}</td>
          </tr>
        ))}
        {(!monthlyPayments.results || monthlyPayments.results.length === 0) && (
          <tr>
            <td colspan="3" style="text-align: center; color: #666">No payment data available</td>
          </tr>
        )}
      </tbody>
    </table>
  </div>

  <!-- Export Options -->
  <div class="card" style="margin-top: 1.5rem;">
    <div class="card-header">
      <h3 class="card-title">Export Reports</h3>
    </div>
    <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
      <a href="/members/export" class="btn btn-secondary">Export All Members (CSV)</a>
      <a href="/reports/expiring" class="btn btn-secondary">Expiring Members Report</a>
      <a href="/reports/renewals" class="btn btn-secondary">Renewal Reminders List</a>
      <a href="/reports/clubhouse" class="btn btn-primary">Clubhouse Financials</a>
    </div>
  </div>
</AdminLayout>
