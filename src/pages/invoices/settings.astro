---
import AdminLayout from '../../layouts/AdminLayout.astro';
import { formatCurrency, type PaymentItem, type InvoiceSetting } from '../../lib/db';

const db = Astro.locals.runtime.env.DB;
const user = Astro.locals.user;
const env = Astro.locals.runtime.env;

let error = '';
let success = '';

// Handle form submissions
if (Astro.request.method === 'POST') {
  const formData = await Astro.request.formData();
  const action = formData.get('action');

  if (action === 'update_settings') {
    // Update invoice settings
    const settingKeys = ['bank_name', 'sort_code', 'account_number', 'account_name',
                         'direct_debit_instructions', 'pay_at_club_instructions',
                         'payment_due_days', 'default_custom_message'];

    for (const key of settingKeys) {
      const value = formData.get(key) as string || '';
      await db.prepare(
        `INSERT INTO invoice_settings (setting_key, setting_value, updated_at)
         VALUES (?, ?, datetime('now'))
         ON CONFLICT(setting_key) DO UPDATE SET setting_value = ?, updated_at = datetime('now')`
      ).bind(key, value, value).run();
    }

    success = 'Settings updated successfully';

    // Log to audit
    await db.prepare(
      `INSERT INTO audit_log (user_email, action, entity_type, details)
       VALUES (?, 'update_settings', 'invoice_settings', ?)`
    ).bind(user?.email || 'system', JSON.stringify({ updated: settingKeys })).run();

  } else if (action === 'update_payment_item') {
    const itemId = formData.get('item_id');
    const fee = parseFloat(formData.get('fee') as string) || 0;

    await db.prepare(
      `UPDATE payment_items SET fee = ? WHERE id = ?`
    ).bind(fee, itemId).run();

    success = 'Payment item updated';

  } else if (action === 'add_payment_item') {
    const category = formData.get('category') as string;
    const name = formData.get('name') as string;
    const fee = parseFloat(formData.get('fee') as string) || 0;
    const description = formData.get('description') as string;

    if (!category || !name) {
      error = 'Category and name are required';
    } else {
      await db.prepare(
        `INSERT INTO payment_items (category, name, fee, description)
         VALUES (?, ?, ?, ?)`
      ).bind(category, name, fee, description || null).run();

      success = 'Payment item added';
    }

  } else if (action === 'toggle_payment_item') {
    const itemId = formData.get('item_id');
    const active = formData.get('active') === '1' ? 0 : 1;

    await db.prepare(
      `UPDATE payment_items SET active = ? WHERE id = ?`
    ).bind(active, itemId).run();

    success = active ? 'Payment item activated' : 'Payment item deactivated';
  }
}

// Get current settings
const settingsResult = await db.prepare(
  `SELECT * FROM invoice_settings`
).all();
const settings: Record<string, string> = {};
settingsResult.results?.forEach((row: any) => {
  settings[row.setting_key] = row.setting_value;
});

// Get payment items
const paymentItemsResult = await db.prepare(
  `SELECT * FROM payment_items ORDER BY category, name`
).all();
const paymentItems = (paymentItemsResult.results || []) as PaymentItem[];

const subscriptionItems = paymentItems.filter(p => p.category === 'Subscription');
const feeItems = paymentItems.filter(p => p.category === 'Fee');

// Check if email is configured
import { isEmailConfigured, getEmailConfigStatus } from '../../lib/email';
const emailStatus = getEmailConfigStatus(env);
const emailConfigured = emailStatus.configured;
---

<AdminLayout title="Invoice Settings">
  {error && (
    <div class="alert alert-error">{error}</div>
  )}

  {success && (
    <div class="alert alert-success">{success}</div>
  )}

  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
    <div>
      <a href="/invoices" class="btn btn-secondary">&larr; Back to Invoices</a>
    </div>
  </div>

  <!-- Email Configuration Status -->
  <div class="card">
    <div class="card-header">
      <h3 class="card-title">Email Configuration</h3>
      <span class={`badge ${emailConfigured ? 'badge-success' : 'badge-danger'}`}>
        {emailConfigured ? 'Configured' : 'Not Configured'}
      </span>
    </div>

    {emailConfigured ? (
      <div>
        <p style="margin: 0 0 0.5rem 0; color: #28a745;">
          Email sending is configured and ready to use.
        </p>
        <p style="margin: 0; font-size: 0.875rem; color: #666;">
          Method: {emailStatus.details}
        </p>
      </div>
    ) : (
      <div>
        <p style="margin: 0 0 1rem 0; color: #dc3545;">
          Email sending is not configured. {emailStatus.details}
        </p>

        <details style="background: #f8f9fa; padding: 1rem; border-radius: 4px; margin-bottom: 1rem;" open>
          <summary style="cursor: pointer; font-weight: 600;">Option 1: Service Account (Recommended for Shared Mailboxes)</summary>
          <div style="margin-top: 1rem; font-size: 0.875rem;">
            <p style="margin: 0 0 1rem 0;">
              Use a licensed M365 user account that has "Send As" permission on the shared mailbox
              (subscriptions@AlnmouthVillage.Golf).
            </p>
            <ol style="margin: 0; padding-left: 1.5rem;">
              <li style="margin-bottom: 0.5rem;">
                Go to <a href="https://portal.azure.com" target="_blank">Azure Portal</a> &rarr; Azure Active Directory &rarr; App registrations
              </li>
              <li style="margin-bottom: 0.5rem;">
                Create new registration: "AVGC Invoice Sender"
              </li>
              <li style="margin-bottom: 0.5rem;">
                Under Authentication, enable "Allow public client flows" (for ROPC)
              </li>
              <li style="margin-bottom: 0.5rem;">
                Add API permission: Microsoft Graph &rarr; <strong>Delegated</strong> permissions &rarr; <code>Mail.Send</code>
              </li>
              <li style="margin-bottom: 0.5rem;">
                In Exchange Admin, grant the service account "Send As" permission on the shared mailbox
              </li>
              <li style="margin-bottom: 0.5rem;">
                Add secrets to Cloudflare:
                <pre style="background: #333; color: #fff; padding: 0.5rem; border-radius: 4px; margin-top: 0.5rem; overflow-x: auto;">npx wrangler secret put AZURE_TENANT_ID
npx wrangler secret put AZURE_CLIENT_ID
npx wrangler secret put AZURE_SERVICE_USER
npx wrangler secret put AZURE_SERVICE_PASSWORD</pre>
              </li>
            </ol>
          </div>
        </details>

        <details style="background: #f8f9fa; padding: 1rem; border-radius: 4px;">
          <summary style="cursor: pointer; font-weight: 600;">Option 2: Application Permissions (Requires Exchange Admin)</summary>
          <div style="margin-top: 1rem; font-size: 0.875rem;">
            <p style="margin: 0 0 1rem 0;">
              Use application-level permissions. Requires additional Exchange Online configuration for shared mailboxes.
            </p>
            <ol style="margin: 0; padding-left: 1.5rem;">
              <li style="margin-bottom: 0.5rem;">
                Go to <a href="https://portal.azure.com" target="_blank">Azure Portal</a> &rarr; Azure Active Directory &rarr; App registrations
              </li>
              <li style="margin-bottom: 0.5rem;">
                Create new registration: "AVGC Invoice Sender"
              </li>
              <li style="margin-bottom: 0.5rem;">
                Note the Application (client) ID and Directory (tenant) ID
              </li>
              <li style="margin-bottom: 0.5rem;">
                Add API permission: Microsoft Graph &rarr; <strong>Application</strong> permissions &rarr; <code>Mail.Send</code>
              </li>
              <li style="margin-bottom: 0.5rem;">
                Grant admin consent for the organization
              </li>
              <li style="margin-bottom: 0.5rem;">
                Create a client secret (certificates & secrets section)
              </li>
              <li style="margin-bottom: 0.5rem;">
                Add secrets to Cloudflare:
                <pre style="background: #333; color: #fff; padding: 0.5rem; border-radius: 4px; margin-top: 0.5rem; overflow-x: auto;">
npx wrangler secret put AZURE_TENANT_ID
npx wrangler secret put AZURE_CLIENT_ID
npx wrangler secret put AZURE_CLIENT_SECRET</pre>
              </li>
            </ol>
          </div>
        </details>
      </div>
    )}
  </div>

  <!-- Payment Instructions Settings -->
  <div class="card">
    <div class="card-header">
      <h3 class="card-title">Payment Instructions</h3>
    </div>

    <form method="POST">
      <input type="hidden" name="action" value="update_settings" />

      <h4 style="margin: 0 0 1rem 0; font-size: 1rem; color: #333;">Bank Transfer Details</h4>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Bank Name</label>
          <input type="text" name="bank_name" class="form-input" value={settings.bank_name || ''} />
        </div>
        <div class="form-group">
          <label class="form-label">Account Name</label>
          <input type="text" name="account_name" class="form-input" value={settings.account_name || 'Alnmouth Village Golf Club'} />
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Sort Code</label>
          <input type="text" name="sort_code" class="form-input" value={settings.sort_code || ''} placeholder="00-00-00" />
        </div>
        <div class="form-group">
          <label class="form-label">Account Number</label>
          <input type="text" name="account_number" class="form-input" value={settings.account_number || ''} placeholder="00000000" />
        </div>
        <div class="form-group">
          <label class="form-label">Payment Due (Days)</label>
          <input type="number" name="payment_due_days" class="form-input" value={settings.payment_due_days || '30'} min="1" max="90" />
        </div>
      </div>

      <h4 style="margin: 1.5rem 0 1rem 0; font-size: 1rem; color: #333;">Payment Method Instructions</h4>

      <div class="form-group">
        <label class="form-label">Direct Debit Instructions</label>
        <textarea
          name="direct_debit_instructions"
          class="form-input"
          rows="3"
          placeholder="Instructions for members paying by Direct Debit..."
        >{settings.direct_debit_instructions || ''}</textarea>
      </div>

      <div class="form-group">
        <label class="form-label">Pay at Club Instructions</label>
        <textarea
          name="pay_at_club_instructions"
          class="form-input"
          rows="3"
          placeholder="Instructions for members paying at the club..."
        >{settings.pay_at_club_instructions || ''}</textarea>
      </div>

      <h4 style="margin: 1.5rem 0 1rem 0; font-size: 1rem; color: #333;">Default Message</h4>

      <div class="form-group">
        <label class="form-label">Default Custom Message</label>
        <textarea
          name="default_custom_message"
          class="form-input"
          rows="3"
          placeholder="Default message to include in invoices..."
        >{settings.default_custom_message || ''}</textarea>
      </div>

      <button type="submit" class="btn btn-primary">Save Settings</button>
    </form>
  </div>

  <!-- Subscription Fees -->
  <div class="card">
    <div class="card-header">
      <h3 class="card-title">Subscription Fees</h3>
    </div>

    <p style="margin: 0 0 1rem 0; font-size: 0.875rem; color: #666;">
      Set the annual subscription fee for each membership type. These will be applied when generating invoices.
    </p>

    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>Subscription Type</th>
            <th style="width: 150px;">Fee</th>
            <th>Status</th>
            <th style="width: 150px;">Actions</th>
          </tr>
        </thead>
        <tbody>
          {subscriptionItems.map((item) => (
            <tr style={item.active ? '' : 'opacity: 0.5;'}>
              <td>
                <strong>{item.name}</strong>
                {item.subscription_template && (
                  <div style="font-size: 0.75rem; color: #666;">{item.subscription_template}</div>
                )}
                {item.description && (
                  <div style="font-size: 0.75rem; color: #999;">{item.description}</div>
                )}
              </td>
              <td>
                <form method="POST" style="display: flex; gap: 0.5rem;">
                  <input type="hidden" name="action" value="update_payment_item" />
                  <input type="hidden" name="item_id" value={item.id} />
                  <input
                    type="number"
                    name="fee"
                    class="form-input"
                    value={item.fee}
                    step="0.01"
                    min="0"
                    style="width: 100px;"
                  />
                  <button type="submit" class="btn btn-secondary btn-sm">Save</button>
                </form>
              </td>
              <td>
                <span class={`badge ${item.active ? 'badge-success' : 'badge-danger'}`}>
                  {item.active ? 'Active' : 'Inactive'}
                </span>
              </td>
              <td>
                <form method="POST" style="display: inline;">
                  <input type="hidden" name="action" value="toggle_payment_item" />
                  <input type="hidden" name="item_id" value={item.id} />
                  <input type="hidden" name="active" value={item.active ? '1' : '0'} />
                  <button type="submit" class="btn btn-secondary btn-sm">
                    {item.active ? 'Deactivate' : 'Activate'}
                  </button>
                </form>
              </td>
            </tr>
          ))}
        </tbody>
      </table>
    </div>
  </div>

  <!-- Additional Fees -->
  <div class="card">
    <div class="card-header">
      <h3 class="card-title">Additional Fees</h3>
    </div>

    <p style="margin: 0 0 1rem 0; font-size: 0.875rem; color: #666;">
      These fees are automatically added to invoices based on member eligibility rules.
    </p>

    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>Fee Name</th>
            <th style="width: 150px;">Amount</th>
            <th>Description</th>
            <th>Status</th>
            <th style="width: 150px;">Actions</th>
          </tr>
        </thead>
        <tbody>
          {feeItems.map((item) => (
            <tr style={item.active ? '' : 'opacity: 0.5;'}>
              <td><strong>{item.name}</strong></td>
              <td>
                <form method="POST" style="display: flex; gap: 0.5rem;">
                  <input type="hidden" name="action" value="update_payment_item" />
                  <input type="hidden" name="item_id" value={item.id} />
                  <input
                    type="number"
                    name="fee"
                    class="form-input"
                    value={item.fee}
                    step="0.01"
                    min="0"
                    style="width: 80px;"
                  />
                  <button type="submit" class="btn btn-secondary btn-sm">Save</button>
                </form>
              </td>
              <td style="font-size: 0.875rem; color: #666;">{item.description || '-'}</td>
              <td>
                <span class={`badge ${item.active ? 'badge-success' : 'badge-danger'}`}>
                  {item.active ? 'Active' : 'Inactive'}
                </span>
              </td>
              <td>
                <form method="POST" style="display: inline;">
                  <input type="hidden" name="action" value="toggle_payment_item" />
                  <input type="hidden" name="item_id" value={item.id} />
                  <input type="hidden" name="active" value={item.active ? '1' : '0'} />
                  <button type="submit" class="btn btn-secondary btn-sm">
                    {item.active ? 'Deactivate' : 'Activate'}
                  </button>
                </form>
              </td>
            </tr>
          ))}
        </tbody>
      </table>
    </div>

    <!-- Add New Fee -->
    <div style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid #ddd;">
      <h4 style="margin: 0 0 1rem 0; font-size: 1rem;">Add New Fee</h4>
      <form method="POST">
        <input type="hidden" name="action" value="add_payment_item" />
        <input type="hidden" name="category" value="Fee" />

        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Fee Name</label>
            <input type="text" name="name" class="form-input" required placeholder="e.g., Competition Levy" />
          </div>
          <div class="form-group">
            <label class="form-label">Amount</label>
            <input type="number" name="fee" class="form-input" step="0.01" min="0" required placeholder="0.00" />
          </div>
          <div class="form-group">
            <label class="form-label">Description</label>
            <input type="text" name="description" class="form-input" placeholder="Optional description" />
          </div>
          <div class="form-group" style="display: flex; align-items: flex-end;">
            <button type="submit" class="btn btn-primary">Add Fee</button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <!-- Fee Rules Reference -->
  <div class="card">
    <div class="card-header">
      <h3 class="card-title">Fee Application Rules</h3>
    </div>

    <div style="font-size: 0.875rem;">
      <table>
        <thead>
          <tr>
            <th>Member Type</th>
            <th>Fees Applied</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>Home member with CDH number (not out of county)</td>
            <td>Subscription + England Golf + Northumberland County</td>
          </tr>
          <tr>
            <td>Out of county member with CDH + home handicap</td>
            <td>Subscription + England Golf</td>
          </tr>
          <tr>
            <td>Member without CDH number</td>
            <td>Subscription only</td>
          </tr>
          <tr>
            <td>Any member with locker number assigned</td>
            <td>+ Locker fee</td>
          </tr>
        </tbody>
      </table>

      <p style="margin: 1rem 0 0 0; color: #666;">
        <strong>CDH Number:</strong> The member's <code>national_id</code> field (Central Database of Handicaps number).<br>
        <strong>Home Handicap:</strong> The member's <code>handicap_index</code> field is not null.
      </p>
    </div>
  </div>
</AdminLayout>
