---
import AdminLayout from '../../../layouts/AdminLayout.astro';
import { formatDate, type Member } from '../../../lib/db';

const db = Astro.locals.runtime.env.DB;

interface FieldDiscrepancy {
  field: string;
  eguValue: string;
  crmValue: string;
}

interface ConsolidationResult {
  matched: Array<{
    cdhNumber: string;
    eguName: string;
    crmId: number;
    crmName: string;
    discrepancies: FieldDiscrepancy[];
    hasDiscrepancies: boolean;
  }>;
  eguNotInCrm: Array<{
    cdhNumber: string;
    name: string;
    email: string;
    homeSecondary: string;
    status: string;
  }>;
  crmNotInEgu: Array<{
    crmId: number;
    crmName: string;
    cdhNumber: string;
    crmSubscription: string | null;
  }>;
  totalDiscrepancies: number;
  errors: string[];
}

let result: ConsolidationResult | null = null;
let error = '';
let lastImport: { imported_at: string; imported_by: string | null } | null = null;

// Load previously saved consolidation data
const savedData = await db.prepare(
  `SELECT * FROM egu_consolidation ORDER BY imported_at DESC LIMIT 1`
).first<{
  id: number;
  imported_at: string;
  imported_by: string | null;
  matched_count: number;
  egu_not_in_crm_count: number;
  crm_not_in_egu_count: number;
  total_discrepancies: number;
  matched_json: string | null;
  egu_not_in_crm_json: string | null;
  crm_not_in_egu_json: string | null;
  errors_json: string | null;
}>().catch(() => null);

if (savedData) {
  lastImport = { imported_at: savedData.imported_at, imported_by: savedData.imported_by };
  result = {
    matched: savedData.matched_json ? JSON.parse(savedData.matched_json) : [],
    eguNotInCrm: savedData.egu_not_in_crm_json ? JSON.parse(savedData.egu_not_in_crm_json) : [],
    crmNotInEgu: savedData.crm_not_in_egu_json ? JSON.parse(savedData.crm_not_in_egu_json) : [],
    totalDiscrepancies: savedData.total_discrepancies,
    errors: savedData.errors_json ? JSON.parse(savedData.errors_json) : []
  };
}

// Parse semicolon-separated CSV line handling quoted fields
function parseCSVLine(line: string, separator: string = ';'): string[] {
  const values: string[] = [];
  let current = '';
  let inQuotes = false;

  for (let i = 0; i < line.length; i++) {
    const char = line[i];
    if (char === '"') {
      inQuotes = !inQuotes;
    } else if (char === separator && !inQuotes) {
      values.push(current.trim());
      current = '';
    } else {
      current += char;
    }
  }
  values.push(current.trim());
  return values;
}

// Normalize name for comparison
function normalizeName(name: string | null): string {
  if (!name) return '';
  return name.toLowerCase().trim().replace(/[^a-z]/g, '');
}

// Normalize email for comparison
function normalizeEmail(email: string | null): string {
  if (!email) return '';
  return email.toLowerCase().trim();
}

// Parse EGU name format "Surname, FirstName"
function parseEguName(name: string): { surname: string; firstName: string } {
  const parts = name.split(',').map(p => p.trim());
  const surname = parts[0] || '';
  const firstName = parts[1] || '';
  return { surname, firstName };
}

// Convert EGU Home/Secondary to CRM home_away format
function eguHomeStatusToCrm(homeSecondary: string): string {
  if (homeSecondary.toLowerCase() === 'home') return 'H';
  if (homeSecondary.toLowerCase() === 'secondary') return 'A';
  return homeSecondary;
}

if (Astro.request.method === 'POST') {
  const formData = await Astro.request.formData();
  const file = formData.get('egufile') as File;

  if (!file || file.size === 0) {
    error = 'Please select an EGU member list CSV file';
  } else {
    try {
      const text = await file.text();
      const lines = text.split(/\r?\n/).filter(line => line.trim());

      if (lines.length < 2) {
        error = 'CSV file appears to be empty or has no data rows';
      } else {
        // Check for separator hint and determine separator
        let separator = ';';
        let startLine = 0;
        if (lines[0].toLowerCase().startsWith('sep=')) {
          separator = lines[0].substring(4).trim();
          startLine = 1;
        }

        const header = parseCSVLine(lines[startLine], separator);

        // Find column indices (case-insensitive)
        const findCol = (names: string[]) => header.findIndex(h =>
          names.some(n => h.toLowerCase().replace(/\s+/g, ' ').trim() === n.toLowerCase())
        );

        const membershipIdx = findCol(['membership number', 'member number', 'cdh number']);
        const nameIdx = findCol(['name']);
        const emailIdx = findCol(['email', 'e-mail']);
        const homeSecondaryIdx = findCol(['home secondary', 'home/secondary', 'home_secondary']);
        const statusIdx = findCol(['status']);
        const dobIdx = findCol(['date of birth', 'dob', 'birth date']);

        if (membershipIdx === -1 || nameIdx === -1) {
          error = 'CSV file must contain "Membership Number" and "Name" columns';
        } else {
          // Parse EGU records
          const eguRecords: Array<{
            cdhNumber: string;
            name: string;
            parsedSurname: string;
            parsedFirstName: string;
            email: string;
            homeSecondary: string;
            status: string;
            dob: string;
          }> = [];

          for (let i = startLine + 1; i < lines.length; i++) {
            const values = parseCSVLine(lines[i], separator);
            if (values.length > Math.max(membershipIdx, nameIdx)) {
              const cdhNumber = values[membershipIdx]?.trim();
              const name = values[nameIdx]?.trim();
              const email = emailIdx >= 0 ? values[emailIdx]?.trim() || '' : '';
              const homeSecondary = homeSecondaryIdx >= 0 ? values[homeSecondaryIdx]?.trim() || '' : '';
              const status = statusIdx >= 0 ? values[statusIdx]?.trim() || '' : '';
              const dob = dobIdx >= 0 ? values[dobIdx]?.trim() || '' : '';

              if (cdhNumber && name) {
                const parsed = parseEguName(name);
                eguRecords.push({
                  cdhNumber,
                  name,
                  parsedSurname: parsed.surname,
                  parsedFirstName: parsed.firstName,
                  email,
                  homeSecondary,
                  status,
                  dob
                });
              }
            }
          }

          // Get all CRM members with CDH number (national_id)
          const crmMembersResult = await db.prepare(
            `SELECT id, first_name, surname, national_id, email, date_of_birth, home_away, subscription_template
             FROM members
             WHERE national_id IS NOT NULL AND national_id != ''
             ORDER BY surname, first_name`
          ).all();
          const crmMembers = (crmMembersResult.results || []) as Array<{
            id: number;
            first_name: string;
            surname: string;
            national_id: string;
            email: string | null;
            date_of_birth: string | null;
            home_away: string | null;
            subscription_template: string | null;
          }>;

          // Create lookup map for CRM members by CDH number
          const crmByCdh = new Map<string, typeof crmMembers[0]>();
          for (const member of crmMembers) {
            crmByCdh.set(member.national_id, member);
          }

          // Track which CRM members are matched
          const matchedCrmIds = new Set<number>();

          // Build results
          result = {
            matched: [],
            eguNotInCrm: [],
            crmNotInEgu: [],
            totalDiscrepancies: 0,
            errors: []
          };

          // Process EGU records
          for (const egu of eguRecords) {
            const crm = crmByCdh.get(egu.cdhNumber);

            if (crm) {
              matchedCrmIds.add(crm.id);

              // Check for discrepancies
              const discrepancies: FieldDiscrepancy[] = [];

              // Name comparison
              const eguNormalizedSurname = normalizeName(egu.parsedSurname);
              const eguNormalizedFirst = normalizeName(egu.parsedFirstName);
              const crmNormalizedSurname = normalizeName(crm.surname);
              const crmNormalizedFirst = normalizeName(crm.first_name);

              if (eguNormalizedSurname !== crmNormalizedSurname ||
                  eguNormalizedFirst !== crmNormalizedFirst) {
                discrepancies.push({
                  field: 'Name',
                  eguValue: egu.name,
                  crmValue: `${crm.first_name} ${crm.surname}`
                });
              }

              // Email comparison
              const eguEmail = normalizeEmail(egu.email);
              const crmEmail = normalizeEmail(crm.email);
              if (eguEmail && crmEmail && eguEmail !== crmEmail) {
                discrepancies.push({
                  field: 'Email',
                  eguValue: egu.email,
                  crmValue: crm.email || ''
                });
              } else if (eguEmail && !crmEmail) {
                discrepancies.push({
                  field: 'Email',
                  eguValue: egu.email,
                  crmValue: '(not set)'
                });
              } else if (!eguEmail && crmEmail) {
                discrepancies.push({
                  field: 'Email',
                  eguValue: '(not set)',
                  crmValue: crm.email || ''
                });
              }

              // Date of birth comparison (if available in EGU file)
              if (egu.dob && crm.date_of_birth) {
                // Normalize dates for comparison
                const eguDob = egu.dob.trim();
                const crmDob = crm.date_of_birth;
                // Try to compare - EGU might be DD/MM/YYYY, CRM is YYYY-MM-DD
                let eguDobNormalized = eguDob;
                if (eguDob.includes('/')) {
                  const parts = eguDob.split('/');
                  if (parts.length === 3) {
                    eguDobNormalized = `${parts[2]}-${parts[1].padStart(2, '0')}-${parts[0].padStart(2, '0')}`;
                  }
                }
                if (eguDobNormalized !== crmDob) {
                  discrepancies.push({
                    field: 'Date of Birth',
                    eguValue: egu.dob,
                    crmValue: formatDate(crm.date_of_birth)
                  });
                }
              }

              // Home/Secondary status comparison
              if (egu.homeSecondary) {
                const eguHomeStatus = eguHomeStatusToCrm(egu.homeSecondary);
                const crmHomeStatus = crm.home_away || '';
                if (eguHomeStatus !== crmHomeStatus) {
                  discrepancies.push({
                    field: 'Home Status',
                    eguValue: egu.homeSecondary,
                    crmValue: crm.home_away === 'H' ? 'Home' : crm.home_away === 'A' ? 'Secondary/Away' : crm.home_away || '(not set)'
                  });
                }
              }

              result.matched.push({
                cdhNumber: egu.cdhNumber,
                eguName: egu.name,
                crmId: crm.id,
                crmName: `${crm.first_name} ${crm.surname}`,
                discrepancies,
                hasDiscrepancies: discrepancies.length > 0
              });

              result.totalDiscrepancies += discrepancies.length;
            } else {
              result.eguNotInCrm.push({
                cdhNumber: egu.cdhNumber,
                name: egu.name,
                email: egu.email,
                homeSecondary: egu.homeSecondary,
                status: egu.status
              });
            }
          }

          // Find CRM members with CDH not in EGU file
          for (const crm of crmMembers) {
            if (!matchedCrmIds.has(crm.id)) {
              result.crmNotInEgu.push({
                crmId: crm.id,
                crmName: `${crm.first_name} ${crm.surname}`,
                cdhNumber: crm.national_id,
                crmSubscription: crm.subscription_template
              });
            }
          }

          // Save the results to database for persistence
          await db.prepare(
            `INSERT INTO egu_consolidation (
              matched_count, egu_not_in_crm_count, crm_not_in_egu_count, total_discrepancies,
              matched_json, egu_not_in_crm_json, crm_not_in_egu_json, errors_json
            ) VALUES (?, ?, ?, ?, ?, ?, ?, ?)`
          ).bind(
            result.matched.length,
            result.eguNotInCrm.length,
            result.crmNotInEgu.length,
            result.totalDiscrepancies,
            JSON.stringify(result.matched),
            JSON.stringify(result.eguNotInCrm),
            JSON.stringify(result.crmNotInEgu),
            JSON.stringify(result.errors)
          ).run();

          lastImport = { imported_at: new Date().toISOString(), imported_by: null };
        }
      }
    } catch (e: any) {
      error = `Failed to process file: ${e.message}`;
    }
  }
}

// Get current stats
const crmWithCdhCount = await db.prepare(
  `SELECT COUNT(*) as count FROM members WHERE national_id IS NOT NULL AND national_id != ''`
).first<{ count: number }>();

// Calculate if there are discrepancies
const hasDiscrepancies = result ? (
  result.eguNotInCrm.length > 0 ||
  result.crmNotInEgu.length > 0 ||
  result.totalDiscrepancies > 0
) : false;

const discrepancyReasons: string[] = [];
if (result) {
  if (result.eguNotInCrm.length > 0) {
    discrepancyReasons.push(`${result.eguNotInCrm.length} EGU members not found in CRM`);
  }
  if (result.crmNotInEgu.length > 0) {
    discrepancyReasons.push(`${result.crmNotInEgu.length} CRM members with CDH not in EGU file`);
  }
  if (result.totalDiscrepancies > 0) {
    const membersWithDiscrepancies = result.matched.filter(m => m.hasDiscrepancies).length;
    discrepancyReasons.push(`${result.totalDiscrepancies} field discrepancies across ${membersWithDiscrepancies} members`);
  }
}
---

<AdminLayout title="EGU Member Consolidation">
  <style>
    .stats-row {
      display: flex;
      gap: 1.5rem;
      margin-bottom: 1.5rem;
    }
    .stat-box {
      background: #fff;
      border-radius: 8px;
      padding: 1.5rem;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      flex: 1;
    }
    .stat-box h4 {
      font-size: 0.875rem;
      color: #666;
      margin: 0 0 0.5rem 0;
    }
    .stat-box .value {
      font-size: 2rem;
      font-weight: 700;
      color: #1e5631;
    }
    .result-section {
      margin-top: 1.5rem;
    }
    .result-section h3 {
      font-size: 1rem;
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .result-section .count {
      background: #e0e0e0;
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      font-size: 0.875rem;
    }
    .result-section.success h3 .count { background: #d4edda; color: #155724; }
    .result-section.warning h3 .count { background: #fff3cd; color: #856404; }
    .result-section.danger h3 .count { background: #f8d7da; color: #721c24; }
    .result-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.875rem;
    }
    .result-table th, .result-table td {
      padding: 0.5rem;
      text-align: left;
      border-bottom: 1px solid #eee;
    }
    .result-table th {
      background: #f4f4f4;
      font-weight: 600;
    }
    .badge-correct { background: #d4edda; color: #155724; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; }
    .badge-incorrect { background: #f8d7da; color: #721c24; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; }
    .badge-warning { background: #fff3cd; color: #856404; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; }
    .max-height-table {
      max-height: 400px;
      overflow-y: auto;
    }
    .discrepancy-list {
      margin: 0;
      padding-left: 1rem;
      font-size: 0.75rem;
    }
    .discrepancy-list li {
      margin-bottom: 0.25rem;
    }
    .discrepancy-field {
      font-weight: 600;
      color: #721c24;
    }
  </style>

  <div style="display: flex; gap: 1rem; margin-bottom: 1.5rem;">
    <a href="/admin/members" class="btn btn-secondary">&larr; Back to Members</a>
  </div>

  {error && <div class="alert alert-error">{error}</div>}

  <div class="stats-row">
    <div class="stat-box">
      <h4>CRM Members with CDH Number</h4>
      <div class="value">{crmWithCdhCount?.count || 0}</div>
    </div>
  </div>

  <div class="card">
    <div class="card-header">
      <h3 class="card-title">Import EGU Member List</h3>
    </div>

    {lastImport && (
      <div style="margin-bottom: 1rem; padding: 0.75rem; background: #e8f4ea; border-radius: 4px; font-size: 0.875rem;">
        <strong>Last imported:</strong> {new Date(lastImport.imported_at).toLocaleString('en-GB')}
        {lastImport.imported_by && <span> by {lastImport.imported_by}</span>}
      </div>
    )}

    <p style="margin-bottom: 1rem; color: #666;">
      Upload the England Golf member list CSV file to consolidate with the CRM.
      Members are matched by <strong>CDH Number (Membership Number = CRM National ID)</strong>.
      Discrepancies in name, email, date of birth, and home status are identified.
    </p>

    <form method="POST" enctype="multipart/form-data">
      <div class="form-group">
        <label class="form-label" for="egufile">EGU Member List CSV File</label>
        <input type="file" name="egufile" id="egufile" accept=".csv" class="form-input" required />
      </div>

      {hasDiscrepancies && (
        <div class="alert alert-warning" style="margin-bottom: 1rem;">
          <strong>Discrepancies found</strong> - these must be resolved before data is considered synchronized:
          <ul style="margin: 0.5rem 0 0 1rem;">
            {discrepancyReasons.map(reason => <li>{reason}</li>)}
          </ul>
        </div>
      )}

      {result && !hasDiscrepancies && (
        <div class="alert alert-success" style="margin-bottom: 1rem;">
          <strong>No discrepancies found.</strong> EGU and CRM member data is fully synchronized.
        </div>
      )}

      <button type="submit" class="btn btn-primary">Run Consolidation</button>
    </form>
  </div>

  {result && (
    <div class="card" style="margin-top: 1.5rem;">
      <div class="card-header">
        <h3 class="card-title">Consolidation Results</h3>
      </div>

      {result.errors.length > 0 && (
        <div class="alert alert-error" style="margin-bottom: 1rem;">
          <strong>Errors:</strong>
          <ul style="margin: 0.5rem 0 0 1rem;">
            {result.errors.map(err => <li>{err}</li>)}
          </ul>
        </div>
      )}

      <!-- Members with Discrepancies -->
      {result.matched.filter(m => m.hasDiscrepancies).length > 0 && (
        <div class="result-section warning">
          <h3>
            Members with Field Discrepancies
            <span class="count">{result.matched.filter(m => m.hasDiscrepancies).length}</span>
          </h3>
          <p style="color: #856404; font-size: 0.875rem; margin-bottom: 0.5rem;">
            These members were matched by CDH number but have differences in their data fields.
            Update either the CRM or EGU to resolve.
          </p>
          <div class="max-height-table">
            <table class="result-table">
              <thead>
                <tr>
                  <th>CDH Number</th>
                  <th>EGU Name</th>
                  <th>CRM Name</th>
                  <th>Discrepancies</th>
                  <th>Action</th>
                </tr>
              </thead>
              <tbody>
                {result.matched.filter(m => m.hasDiscrepancies).map(m => (
                  <tr>
                    <td><code>{m.cdhNumber}</code></td>
                    <td>{m.eguName}</td>
                    <td>
                      <a href={`/admin/members/${m.crmId}`}>{m.crmName}</a>
                    </td>
                    <td>
                      <ul class="discrepancy-list">
                        {m.discrepancies.map(d => (
                          <li>
                            <span class="discrepancy-field">{d.field}:</span>{' '}
                            EGU: "{d.eguValue}" vs CRM: "{d.crmValue}"
                          </li>
                        ))}
                      </ul>
                    </td>
                    <td>
                      <a href={`/admin/members/${m.crmId}/edit`} class="btn btn-secondary btn-sm">Edit CRM</a>
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        </div>
      )}

      <!-- Matched Members (no discrepancies) -->
      <div class="result-section success">
        <h3>
          Matched Members (No Discrepancies)
          <span class="count">{result.matched.filter(m => !m.hasDiscrepancies).length}</span>
        </h3>
        {result.matched.filter(m => !m.hasDiscrepancies).length > 0 ? (
          <div class="max-height-table">
            <table class="result-table">
              <thead>
                <tr>
                  <th>CDH Number</th>
                  <th>Name</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody>
                {result.matched.filter(m => !m.hasDiscrepancies).map(m => (
                  <tr>
                    <td><code>{m.cdhNumber}</code></td>
                    <td>
                      <a href={`/admin/members/${m.crmId}`}>{m.crmName}</a>
                    </td>
                    <td><span class="badge-correct">Synchronized</span></td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        ) : (
          <p style="color: #666;">No members without discrepancies.</p>
        )}
      </div>

      <!-- EGU Not in CRM -->
      <div class="result-section danger">
        <h3>
          EGU Members Not Found in CRM
          <span class="count">{result.eguNotInCrm.length}</span>
        </h3>
        {result.eguNotInCrm.length > 0 ? (
          <>
            <p style="color: #721c24; font-size: 0.875rem; margin-bottom: 0.5rem;">
              These EGU members have no matching CDH number in the CRM.
              They may need to be added to the CRM or their CDH number corrected.
            </p>
            <div class="max-height-table">
              <table class="result-table">
                <thead>
                  <tr>
                    <th>CDH Number</th>
                    <th>Name</th>
                    <th>Email</th>
                    <th>Home/Secondary</th>
                    <th>Status</th>
                  </tr>
                </thead>
                <tbody>
                  {result.eguNotInCrm.map(m => (
                    <tr>
                      <td><code>{m.cdhNumber}</code></td>
                      <td>{m.name}</td>
                      <td>{m.email || '-'}</td>
                      <td>{m.homeSecondary || '-'}</td>
                      <td>{m.status || '-'}</td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          </>
        ) : (
          <p style="color: #666;">All EGU members were found in the CRM.</p>
        )}
      </div>

      <!-- CRM Not in EGU -->
      <div class="result-section danger">
        <h3>
          CRM Members Not in EGU File
          <span class="count">{result.crmNotInEgu.length}</span>
        </h3>
        {result.crmNotInEgu.length > 0 ? (
          <>
            <p style="color: #721c24; font-size: 0.875rem; margin-bottom: 0.5rem;">
              These CRM members have a CDH number but were not found in the EGU export.
              They may need to be added to England Golf or their membership reviewed.
            </p>
            <div class="max-height-table">
              <table class="result-table">
                <thead>
                  <tr>
                    <th>CDH Number</th>
                    <th>Name</th>
                    <th>Subscription</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  {result.crmNotInEgu.map(m => (
                    <tr>
                      <td><code>{m.cdhNumber}</code></td>
                      <td>
                        <a href={`/admin/members/${m.crmId}`}>{m.crmName}</a>
                      </td>
                      <td>{m.crmSubscription || '-'}</td>
                      <td>
                        <a href={`/admin/members/${m.crmId}`} class="btn btn-secondary btn-sm">View</a>
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          </>
        ) : (
          <p style="color: #666;">All CRM members with CDH numbers were found in the EGU file.</p>
        )}
      </div>

      <!-- Summary -->
      <div style="margin-top: 1.5rem; padding: 1rem; background: #f4f4f4; border-radius: 4px;">
        <h4 style="margin: 0 0 0.5rem 0;">Summary</h4>
        <ul style="margin: 0; padding-left: 1.5rem;">
          <li><strong>{result.matched.length}</strong> EGU members matched with CRM by CDH number</li>
          <li><strong>{result.matched.filter(m => !m.hasDiscrepancies).length}</strong> fully synchronized (no discrepancies)</li>
          <li><strong>{result.matched.filter(m => m.hasDiscrepancies).length}</strong> with field discrepancies</li>
          <li><strong>{result.totalDiscrepancies}</strong> total field discrepancies</li>
          <li><strong>{result.eguNotInCrm.length}</strong> EGU members not found in CRM</li>
          <li><strong>{result.crmNotInEgu.length}</strong> CRM members (with CDH) not in EGU file</li>
        </ul>

        {!hasDiscrepancies && result.matched.length > 0 && (
          <div style="margin-top: 1rem; padding: 0.75rem; background: #d4edda; border-radius: 4px; color: #155724;">
            <strong>Data is synchronized.</strong> All members match between EGU and CRM with no discrepancies.
          </div>
        )}

        {hasDiscrepancies && (
          <div style="margin-top: 1rem; padding: 0.75rem; background: #f8d7da; border-radius: 4px; color: #721c24;">
            <strong>Data is NOT synchronized.</strong> Resolve all discrepancies above before considering data complete.
          </div>
        )}
      </div>
    </div>
  )}

  <div class="card" style="margin-top: 1.5rem;">
    <div class="card-header">
      <h3 class="card-title">Expected CSV Format</h3>
    </div>
    <p style="font-size: 0.875rem; color: #666;">
      The EGU member list CSV file should contain these columns:
    </p>
    <ul style="font-size: 0.875rem; color: #666; margin: 0.5rem 0 0 1.5rem;">
      <li><strong>Membership Number</strong> - The CDH number (matches CRM National ID)</li>
      <li><strong>Name</strong> - Member name in format "Surname, FirstName"</li>
      <li><strong>Email</strong> - Member's email address</li>
      <li><strong>Home Secondary</strong> - "Home" or "Secondary" status</li>
      <li><strong>Date of Birth</strong> (optional) - Member's date of birth</li>
    </ul>
    <p style="font-size: 0.875rem; color: #666; margin-top: 1rem;">
      Export this file from the England Golf Club Portal: Members â†’ Export Full Member Listing
    </p>

    <h4 style="margin-top: 1.5rem; font-size: 0.875rem;">Fields Compared:</h4>
    <ul style="font-size: 0.875rem; color: #666; margin: 0.5rem 0 0 1.5rem;">
      <li><strong>Name</strong> - First name and surname must match</li>
      <li><strong>Email</strong> - Email addresses must match (case-insensitive)</li>
      <li><strong>Date of Birth</strong> - Must match (if present in EGU file)</li>
      <li><strong>Home Status</strong> - EGU "Home"/"Secondary" must match CRM "H"/"A"</li>
    </ul>
  </div>
</AdminLayout>
