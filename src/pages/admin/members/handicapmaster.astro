---
import AdminLayout from '../../../layouts/AdminLayout.astro';
import { formatDate, type Member } from '../../../lib/db';

const db = Astro.locals.runtime.env.DB;

interface HMRecord {
  surname: string;
  middleInitials: string;
  firstName: string;
  gender: string;
  ageGroup: string;
  handicapIndex: string;
  homeAway: string;
  homeClub: string;
  pin: string;
  title: string;
  address1: string;
  address2: string;
  address3: string;
  address4: string;
  address5: string;
  telephone1: string;
  telephone2: string;
  telephone3: string;
  email: string;
  clubNumber: string;
  category: string;
  dateJoined: string;
  dateRenewed: string;
  dateExpires: string;
  dateSubscriptionPaid: string;
  nationalIdCountry: string;
  nationalId: string;
  dateOfBirth: string;
  lockerNumber: string;
  defaultPaymentMethod: string;
  subscriptionTemplate: string;
  accountBalance: string;
  sendInvoiceBy: string;
}

interface ConsolidationResult {
  matched: Array<{
    hmRecord: HMRecord;
    crmId: number;
    crmName: string;
    crmPin: string;
    differences: string[];
  }>;
  hmNotInCrm: Array<HMRecord>;
  crmNotInHm: Array<{
    crmId: number;
    crmName: string;
    crmPin: string;
    crmCategory: string | null;
  }>;
  errors: string[];
}

let result: ConsolidationResult | null = null;
let error = '';
let successMessage = '';
let lastImport: { imported_at: string; imported_by: string | null } | null = null;

// Load previously saved consolidation data
const savedData = await db.prepare(
  `SELECT * FROM handicapmaster_consolidation ORDER BY imported_at DESC LIMIT 1`
).first<{
  id: number;
  imported_at: string;
  imported_by: string | null;
  matched_count: number;
  hm_not_in_crm_count: number;
  crm_not_in_hm_count: number;
  matched_json: string | null;
  hm_not_in_crm_json: string | null;
  crm_not_in_hm_json: string | null;
  errors_json: string | null;
}>().catch(() => null);

if (savedData) {
  lastImport = { imported_at: savedData.imported_at, imported_by: savedData.imported_by };
  result = {
    matched: savedData.matched_json ? JSON.parse(savedData.matched_json) : [],
    hmNotInCrm: savedData.hm_not_in_crm_json ? JSON.parse(savedData.hm_not_in_crm_json) : [],
    crmNotInHm: savedData.crm_not_in_hm_json ? JSON.parse(savedData.crm_not_in_hm_json) : [],
    errors: savedData.errors_json ? JSON.parse(savedData.errors_json) : []
  };
}

// Parse CSV line handling quoted fields
function parseCSVLine(line: string): string[] {
  const values: string[] = [];
  let current = '';
  let inQuotes = false;

  for (let i = 0; i < line.length; i++) {
    const char = line[i];
    if (char === '"') {
      inQuotes = !inQuotes;
    } else if (char === ',' && !inQuotes) {
      values.push(current.trim());
      current = '';
    } else {
      current += char;
    }
  }
  values.push(current.trim());
  return values;
}

// Parse full CSV handling multi-line quoted fields
function parseCSV(text: string): string[][] {
  const rows: string[][] = [];
  let current = '';
  let inQuotes = false;

  for (let i = 0; i < text.length; i++) {
    const char = text[i];

    if (char === '"') {
      inQuotes = !inQuotes;
      current += char;
    } else if ((char === '\n' || char === '\r') && !inQuotes) {
      if (current.trim()) {
        rows.push(parseCSVLine(current));
      }
      current = '';
      if (char === '\r' && text[i + 1] === '\n') {
        i++;
      }
    } else {
      current += char;
    }
  }

  if (current.trim()) {
    rows.push(parseCSVLine(current));
  }

  return rows;
}

// Normalize name for comparison
function normalizeName(name: string | null): string {
  if (!name) return '';
  return name.toLowerCase().trim().replace(/[^a-z]/g, '');
}

// Parse date from DD/MM/YYYY format to YYYY-MM-DD
function parseDate(dateStr: string): string | null {
  if (!dateStr) return null;
  const parts = dateStr.split('/');
  if (parts.length === 3) {
    const [day, month, year] = parts;
    return `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
  }
  return null;
}

// Parse currency value
function parseCurrency(value: string): number {
  if (!value) return 0;
  // Remove currency symbols and handle negative values
  const cleaned = value.replace(/[£$,]/g, '').replace('−', '-').replace('–', '-');
  return parseFloat(cleaned) || 0;
}

// Get column value safely
function getCol(values: string[], idx: number): string {
  return idx >= 0 && idx < values.length ? values[idx]?.trim() || '' : '';
}

if (Astro.request.method === 'POST') {
  const formData = await Astro.request.formData();
  const action = formData.get('action');

  if (action === 'import') {
    // Import a single member from HandicapMaster
    const hmData = formData.get('hmData') as string;
    try {
      const hm: HMRecord = JSON.parse(hmData);

      // Check if member already exists by PIN or name
      let existingMember = null;
      if (hm.pin) {
        existingMember = await db.prepare(
          'SELECT id FROM members WHERE pin = ?'
        ).bind(hm.pin).first<{ id: number }>();
      }

      if (!existingMember) {
        // Try to find by name
        existingMember = await db.prepare(
          'SELECT id FROM members WHERE LOWER(surname) = LOWER(?) AND LOWER(first_name) = LOWER(?)'
        ).bind(hm.surname, hm.firstName).first<{ id: number }>();
      }

      if (existingMember) {
        error = `Member ${hm.firstName} ${hm.surname} already exists in CRM (ID: ${existingMember.id})`;
      } else {
        // Insert new member
        const result = await db.prepare(`
          INSERT INTO members (
            surname, middle_initials, first_name, gender, age_group, handicap_index,
            home_away, home_club, pin, title, address_1, address_2, address_3, address_4, address_5,
            telephone_1, telephone_2, telephone_3, email, club_number, category,
            date_joined, date_renewed, date_expires, date_subscription_paid,
            national_id_country, national_id, date_of_birth, locker_number,
            default_payment_method, subscription_template, account_balance, send_invoice_by
          ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
        `).bind(
          hm.surname,
          hm.middleInitials || null,
          hm.firstName,
          hm.gender || null,
          hm.ageGroup || null,
          hm.handicapIndex ? parseFloat(hm.handicapIndex) : null,
          hm.homeAway || null,
          hm.homeClub || null,
          hm.pin || null,
          hm.title || null,
          hm.address1 || null,
          hm.address2 || null,
          hm.address3 || null,
          hm.address4 || null,
          hm.address5 || null,
          hm.telephone1 || null,
          hm.telephone2 || null,
          hm.telephone3 || null,
          hm.email || null,
          hm.clubNumber || null,
          hm.category || null,
          parseDate(hm.dateJoined),
          parseDate(hm.dateRenewed),
          parseDate(hm.dateExpires),
          parseDate(hm.dateSubscriptionPaid),
          hm.nationalIdCountry || null,
          hm.nationalId || null,
          parseDate(hm.dateOfBirth),
          hm.lockerNumber || null,
          hm.defaultPaymentMethod || null,
          hm.subscriptionTemplate || null,
          parseCurrency(hm.accountBalance),
          hm.sendInvoiceBy || null
        ).run();

        successMessage = `Successfully imported ${hm.firstName} ${hm.surname}`;

        // Reload saved data to update the list
        const updatedData = await db.prepare(
          `SELECT * FROM handicapmaster_consolidation ORDER BY imported_at DESC LIMIT 1`
        ).first<any>().catch(() => null);

        if (updatedData) {
          // Remove the imported member from hmNotInCrm
          const hmNotInCrm = updatedData.hm_not_in_crm_json ? JSON.parse(updatedData.hm_not_in_crm_json) : [];
          const filteredHmNotInCrm = hmNotInCrm.filter((m: HMRecord) =>
            !(m.surname === hm.surname && m.firstName === hm.firstName && m.pin === hm.pin)
          );

          // Update the stored data
          await db.prepare(
            `UPDATE handicapmaster_consolidation SET hm_not_in_crm_json = ?, hm_not_in_crm_count = ? WHERE id = ?`
          ).bind(JSON.stringify(filteredHmNotInCrm), filteredHmNotInCrm.length, updatedData.id).run();

          result = {
            matched: updatedData.matched_json ? JSON.parse(updatedData.matched_json) : [],
            hmNotInCrm: filteredHmNotInCrm,
            crmNotInHm: updatedData.crm_not_in_hm_json ? JSON.parse(updatedData.crm_not_in_hm_json) : [],
            errors: updatedData.errors_json ? JSON.parse(updatedData.errors_json) : []
          };
          lastImport = { imported_at: updatedData.imported_at, imported_by: updatedData.imported_by };
        }
      }
    } catch (e: any) {
      error = `Failed to import member: ${e.message}`;
    }
  } else {
    // Process uploaded file
    const file = formData.get('hmfile') as File;

    if (!file || file.size === 0) {
      error = 'Please select a HandicapMaster export CSV file';
    } else {
      try {
        const text = await file.text();
        const rows = parseCSV(text);

        if (rows.length < 2) {
          error = 'CSV file appears to be empty or has no data rows';
        } else {
          const header = rows[0].map(h => h.toUpperCase());

          // Find column indices
          const colMap: Record<string, number> = {};
          const columns = [
            'SURNAME', 'MIDDLE INITIALS', 'FIRST NAME', 'GENDER', 'AGE GROUP',
            'HANDICAP INDEX', 'HOME/AWAY/VISITOR', 'HOME CLUB', 'PIN', 'TITLE',
            'ADDRESS 1', 'ADDRESS 2', 'ADDRESS 3', 'ADDRESS 4', 'ADDRESS 5',
            'TELEPHONE 1', 'TELEPHONE 2', 'TELEPHONE 3', 'E-MAIL ADDRESS',
            'CLUB NUMBER', 'CATEGORY', 'DATE JOINED', 'DATE RENEWED', 'DATE EXPIRES',
            'DATE SUBSCRIPTION PAID', 'NATIONAL ID COUNTRY', 'NATIONAL ID',
            'DATE OF BIRTH', 'LOCKER NUMBER', 'DEFAULT PAYMENT METHOD',
            'SUBSCRIPTION TEMPLATE', 'ACCOUNT BALANCE', 'SEND INVOICE BY'
          ];

          for (const col of columns) {
            colMap[col] = header.findIndex(h => h === col);
          }

          if (colMap['SURNAME'] === -1 || colMap['FIRST NAME'] === -1) {
            error = 'CSV file must contain "SURNAME" and "FIRST NAME" columns';
          } else {
            // Parse HandicapMaster records
            const hmRecords: HMRecord[] = [];

            for (let i = 1; i < rows.length; i++) {
              const values = rows[i];
              const surname = getCol(values, colMap['SURNAME']);
              const firstName = getCol(values, colMap['FIRST NAME']);

              if (surname && firstName) {
                hmRecords.push({
                  surname,
                  middleInitials: getCol(values, colMap['MIDDLE INITIALS']),
                  firstName,
                  gender: getCol(values, colMap['GENDER']),
                  ageGroup: getCol(values, colMap['AGE GROUP']),
                  handicapIndex: getCol(values, colMap['HANDICAP INDEX']),
                  homeAway: getCol(values, colMap['HOME/AWAY/VISITOR']),
                  homeClub: getCol(values, colMap['HOME CLUB']),
                  pin: getCol(values, colMap['PIN']),
                  title: getCol(values, colMap['TITLE']),
                  address1: getCol(values, colMap['ADDRESS 1']),
                  address2: getCol(values, colMap['ADDRESS 2']),
                  address3: getCol(values, colMap['ADDRESS 3']),
                  address4: getCol(values, colMap['ADDRESS 4']),
                  address5: getCol(values, colMap['ADDRESS 5']),
                  telephone1: getCol(values, colMap['TELEPHONE 1']),
                  telephone2: getCol(values, colMap['TELEPHONE 2']),
                  telephone3: getCol(values, colMap['TELEPHONE 3']),
                  email: getCol(values, colMap['E-MAIL ADDRESS']),
                  clubNumber: getCol(values, colMap['CLUB NUMBER']),
                  category: getCol(values, colMap['CATEGORY']),
                  dateJoined: getCol(values, colMap['DATE JOINED']),
                  dateRenewed: getCol(values, colMap['DATE RENEWED']),
                  dateExpires: getCol(values, colMap['DATE EXPIRES']),
                  dateSubscriptionPaid: getCol(values, colMap['DATE SUBSCRIPTION PAID']),
                  nationalIdCountry: getCol(values, colMap['NATIONAL ID COUNTRY']),
                  nationalId: getCol(values, colMap['NATIONAL ID']),
                  dateOfBirth: getCol(values, colMap['DATE OF BIRTH']),
                  lockerNumber: getCol(values, colMap['LOCKER NUMBER']),
                  defaultPaymentMethod: getCol(values, colMap['DEFAULT PAYMENT METHOD']),
                  subscriptionTemplate: getCol(values, colMap['SUBSCRIPTION TEMPLATE']),
                  accountBalance: getCol(values, colMap['ACCOUNT BALANCE']),
                  sendInvoiceBy: getCol(values, colMap['SEND INVOICE BY'])
                });
              }
            }

            // Get all CRM members
            const crmMembersResult = await db.prepare(
              `SELECT id, first_name, surname, middle_initials, pin, category, email,
                      handicap_index, date_expires, telephone_1, address_1
               FROM members
               ORDER BY surname, first_name`
            ).all();
            const crmMembers = (crmMembersResult.results || []) as Array<{
              id: number;
              first_name: string;
              surname: string;
              middle_initials: string | null;
              pin: string | null;
              category: string | null;
              email: string | null;
              handicap_index: number | null;
              date_expires: string | null;
              telephone_1: string | null;
              address_1: string | null;
            }>;

            // Create lookup maps
            const crmByPin = new Map<string, typeof crmMembers[0]>();
            const crmByName = new Map<string, typeof crmMembers[0]>();
            for (const member of crmMembers) {
              if (member.pin) {
                crmByPin.set(member.pin, member);
              }
              const nameKey = `${normalizeName(member.surname)}|${normalizeName(member.first_name)}`;
              crmByName.set(nameKey, member);
            }

            // Track matched CRM IDs
            const matchedCrmIds = new Set<number>();

            // Build results
            result = {
              matched: [],
              hmNotInCrm: [],
              crmNotInHm: [],
              errors: []
            };

            // Process HandicapMaster records
            for (const hm of hmRecords) {
              let crm = hm.pin ? crmByPin.get(hm.pin) : null;

              // If no PIN match, try name match
              if (!crm) {
                const nameKey = `${normalizeName(hm.surname)}|${normalizeName(hm.firstName)}`;
                crm = crmByName.get(nameKey);
              }

              if (crm) {
                matchedCrmIds.add(crm.id);

                // Check for differences
                const differences: string[] = [];

                if (hm.pin && crm.pin && hm.pin !== crm.pin) {
                  differences.push(`PIN: HM="${hm.pin}" vs CRM="${crm.pin}"`);
                }
                if (hm.email && crm.email && hm.email.toLowerCase() !== crm.email.toLowerCase()) {
                  differences.push(`Email differs`);
                }
                if (hm.handicapIndex && crm.handicap_index !== null) {
                  const hmHcap = parseFloat(hm.handicapIndex);
                  if (!isNaN(hmHcap) && Math.abs(hmHcap - crm.handicap_index) > 0.1) {
                    differences.push(`Handicap: HM="${hm.handicapIndex}" vs CRM="${crm.handicap_index}"`);
                  }
                }
                if (hm.category && crm.category && hm.category !== crm.category) {
                  differences.push(`Category: HM="${hm.category}" vs CRM="${crm.category}"`);
                }

                result.matched.push({
                  hmRecord: hm,
                  crmId: crm.id,
                  crmName: `${crm.first_name} ${crm.surname}`,
                  crmPin: crm.pin || '',
                  differences
                });
              } else {
                result.hmNotInCrm.push(hm);
              }
            }

            // Find CRM members not in HandicapMaster
            for (const crm of crmMembers) {
              if (!matchedCrmIds.has(crm.id)) {
                result.crmNotInHm.push({
                  crmId: crm.id,
                  crmName: `${crm.first_name} ${crm.surname}`,
                  crmPin: crm.pin || '',
                  crmCategory: crm.category
                });
              }
            }

            // Save results to database
            await db.prepare(
              `INSERT INTO handicapmaster_consolidation (
                matched_count, hm_not_in_crm_count, crm_not_in_hm_count,
                matched_json, hm_not_in_crm_json, crm_not_in_hm_json, errors_json
              ) VALUES (?, ?, ?, ?, ?, ?, ?)`
            ).bind(
              result.matched.length,
              result.hmNotInCrm.length,
              result.crmNotInHm.length,
              JSON.stringify(result.matched),
              JSON.stringify(result.hmNotInCrm),
              JSON.stringify(result.crmNotInHm),
              JSON.stringify(result.errors)
            ).run();

            lastImport = { imported_at: new Date().toISOString(), imported_by: null };
          }
        }
      } catch (e: any) {
        error = `Failed to process file: ${e.message}`;
      }
    }
  }
}

// Get current CRM stats
const crmTotalCount = await db.prepare(
  `SELECT COUNT(*) as count FROM members`
).first<{ count: number }>();

const crmWithPinCount = await db.prepare(
  `SELECT COUNT(*) as count FROM members WHERE pin IS NOT NULL AND pin != ''`
).first<{ count: number }>();

// Calculate discrepancies
const hasDiscrepancies = result ? (
  result.hmNotInCrm.length > 0 ||
  result.crmNotInHm.length > 0 ||
  result.matched.some(m => m.differences.length > 0)
) : false;
---

<AdminLayout title="HandicapMaster Consolidation">
  <div class="page-header">
    <div class="header-content">
      <h1>HandicapMaster Consolidation</h1>
      <p class="subtitle">Compare and sync with HandicapMaster export data</p>
    </div>
    <div class="header-actions">
      <a href="/admin/members" class="btn btn-secondary">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polyline points="15 18 9 12 15 6"/>
        </svg>
        Back to Members
      </a>
    </div>
  </div>

  {error && <div class="alert alert-error">{error}</div>}
  {successMessage && <div class="alert alert-success">{successMessage}</div>}

  <!-- Stats Row -->
  <div class="stats-row">
    <div class="stat-card">
      <div class="stat-icon">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
          <circle cx="9" cy="7" r="4"/>
          <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
          <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
        </svg>
      </div>
      <div class="stat-content">
        <span class="stat-value">{crmTotalCount?.count || 0}</span>
        <span class="stat-label">CRM Members</span>
      </div>
    </div>

    <div class="stat-card stat-success">
      <div class="stat-icon">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
          <path d="M7 11V7a5 5 0 0 1 10 0v4"/>
        </svg>
      </div>
      <div class="stat-content">
        <span class="stat-value">{crmWithPinCount?.count || 0}</span>
        <span class="stat-label">With PIN</span>
      </div>
    </div>

    {result && (
      <div class="stat-card stat-info">
        <div class="stat-icon">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/>
          </svg>
        </div>
        <div class="stat-content">
          <span class="stat-value">{result.matched.length}</span>
          <span class="stat-label">Matched</span>
        </div>
      </div>
    )}
  </div>

  <!-- Upload Card -->
  <div class="m3-card">
    <div class="card-header">
      <div class="card-title">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
          <polyline points="17 8 12 3 7 8"/>
          <line x1="12" y1="3" x2="12" y2="15"/>
        </svg>
        <span>Import HandicapMaster Export</span>
      </div>
      {lastImport && (
        <span class="card-badge">
          Last: {new Date(lastImport.imported_at).toLocaleDateString('en-GB')}
        </span>
      )}
    </div>
    <div class="card-content" style="padding: 1.25rem;">
      <p style="margin-bottom: 1rem; color: #666; font-size: 0.9rem;">
        Upload the HandicapMaster member export CSV file to compare with the CRM.
        Members are matched by <strong>PIN</strong> first, then by <strong>name</strong> if no PIN match is found.
      </p>

      <form method="POST" enctype="multipart/form-data">
        <div class="form-group">
          <label class="form-label" for="hmfile">HandicapMaster Export CSV</label>
          <input type="file" name="hmfile" id="hmfile" accept=".csv" class="form-input" required />
        </div>

        <button type="submit" class="btn btn-primary">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/>
          </svg>
          Run Consolidation
        </button>
      </form>
    </div>
  </div>

  {result && (
    <>
      <!-- Summary Alert -->
      {hasDiscrepancies ? (
        <div class="alert alert-warning" style="margin-top: 1.5rem;">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
            <line x1="12" y1="9" x2="12" y2="13"/>
            <line x1="12" y1="17" x2="12.01" y2="17"/>
          </svg>
          <div>
            <strong>Discrepancies found</strong>
            <ul style="margin: 0.5rem 0 0 1rem; font-size: 0.9rem;">
              {result.hmNotInCrm.length > 0 && <li>{result.hmNotInCrm.length} HandicapMaster members not in CRM</li>}
              {result.crmNotInHm.length > 0 && <li>{result.crmNotInHm.length} CRM members not in HandicapMaster</li>}
              {result.matched.filter(m => m.differences.length > 0).length > 0 && (
                <li>{result.matched.filter(m => m.differences.length > 0).length} matched members with field differences</li>
              )}
            </ul>
          </div>
        </div>
      ) : (
        <div class="alert alert-success" style="margin-top: 1.5rem;">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
            <polyline points="22 4 12 14.01 9 11.01"/>
          </svg>
          <strong>All records matched!</strong> No discrepancies found.
        </div>
      )}

      <!-- HandicapMaster Not in CRM -->
      {result.hmNotInCrm.length > 0 && (
        <div class="m3-card" style="margin-top: 1.5rem;">
          <div class="card-header">
            <div class="card-title">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                <circle cx="8.5" cy="7" r="4"/>
                <line x1="20" y1="8" x2="20" y2="14"/>
                <line x1="23" y1="11" x2="17" y2="11"/>
              </svg>
              <span>HandicapMaster Members Not in CRM</span>
            </div>
            <span class="card-badge badge-warning">{result.hmNotInCrm.length} to import</span>
          </div>
          <div class="card-content">
            <p style="color: #856404; font-size: 0.875rem; margin-bottom: 1rem; padding: 0 1.25rem;">
              These members exist in HandicapMaster but were not found in the CRM. Click "Import" to add them.
            </p>
            <div class="table-container">
              <table class="m3-table">
                <thead>
                  <tr>
                    <th>PIN</th>
                    <th>Name</th>
                    <th>Category</th>
                    <th>Email</th>
                    <th>Expires</th>
                    <th class="actions-col">Action</th>
                  </tr>
                </thead>
                <tbody>
                  {result.hmNotInCrm.map(hm => (
                    <tr>
                      <td><code>{hm.pin || '-'}</code></td>
                      <td><strong>{hm.firstName} {hm.surname}</strong></td>
                      <td>{hm.category || '-'}</td>
                      <td>{hm.email || '-'}</td>
                      <td>{hm.dateExpires || '-'}</td>
                      <td class="actions-col">
                        <form method="POST" style="display: inline;">
                          <input type="hidden" name="action" value="import" />
                          <input type="hidden" name="hmData" value={JSON.stringify(hm)} />
                          <button type="submit" class="btn btn-primary btn-sm">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 14px; height: 14px;">
                              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                              <polyline points="7 10 12 15 17 10"/>
                              <line x1="12" y1="15" x2="12" y2="3"/>
                            </svg>
                            Import
                          </button>
                        </form>
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      )}

      <!-- CRM Members Not in HandicapMaster -->
      {result.crmNotInHm.length > 0 && (
        <div class="m3-card" style="margin-top: 1.5rem;">
          <div class="card-header">
            <div class="card-title">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                <circle cx="8.5" cy="7" r="4"/>
                <line x1="18" y1="8" x2="23" y2="13"/>
                <line x1="23" y1="8" x2="18" y2="13"/>
              </svg>
              <span>CRM Members Not in HandicapMaster</span>
            </div>
            <span class="card-badge badge-danger">{result.crmNotInHm.length} missing</span>
          </div>
          <div class="card-content">
            <p style="color: #721c24; font-size: 0.875rem; margin-bottom: 1rem; padding: 0 1.25rem;">
              These members exist in the CRM but were not found in the HandicapMaster export.
            </p>
            <div class="table-container" style="max-height: 400px; overflow-y: auto;">
              <table class="m3-table">
                <thead>
                  <tr>
                    <th>PIN</th>
                    <th>Name</th>
                    <th>Category</th>
                    <th class="actions-col">Action</th>
                  </tr>
                </thead>
                <tbody>
                  {result.crmNotInHm.map(crm => (
                    <tr>
                      <td><code>{crm.crmPin || '-'}</code></td>
                      <td>
                        <a href={`/members/${crm.crmId}`} class="table-link">{crm.crmName}</a>
                      </td>
                      <td>{crm.crmCategory || '-'}</td>
                      <td class="actions-col">
                        <a href={`/members/${crm.crmId}`} class="btn btn-secondary btn-sm">View</a>
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      )}

      <!-- Matched with Differences -->
      {result.matched.filter(m => m.differences.length > 0).length > 0 && (
        <div class="m3-card" style="margin-top: 1.5rem;">
          <div class="card-header">
            <div class="card-title">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
                <line x1="12" y1="9" x2="12" y2="13"/>
                <line x1="12" y1="17" x2="12.01" y2="17"/>
              </svg>
              <span>Matched Members with Differences</span>
            </div>
            <span class="card-badge badge-warning">{result.matched.filter(m => m.differences.length > 0).length}</span>
          </div>
          <div class="card-content">
            <div class="table-container" style="max-height: 400px; overflow-y: auto;">
              <table class="m3-table">
                <thead>
                  <tr>
                    <th>PIN</th>
                    <th>Name</th>
                    <th>Differences</th>
                    <th class="actions-col">Action</th>
                  </tr>
                </thead>
                <tbody>
                  {result.matched.filter(m => m.differences.length > 0).map(m => (
                    <tr>
                      <td><code>{m.hmRecord.pin || m.crmPin || '-'}</code></td>
                      <td>
                        <a href={`/members/${m.crmId}`} class="table-link">{m.crmName}</a>
                      </td>
                      <td>
                        <ul style="margin: 0; padding-left: 1rem; font-size: 0.85rem; color: #856404;">
                          {m.differences.map(d => <li>{d}</li>)}
                        </ul>
                      </td>
                      <td class="actions-col">
                        <a href={`/members/${m.crmId}/edit`} class="btn btn-secondary btn-sm">Edit</a>
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      )}

      <!-- All Matched Members -->
      <div class="m3-card" style="margin-top: 1.5rem;">
        <div class="card-header">
          <div class="card-title">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
              <polyline points="22 4 12 14.01 9 11.01"/>
            </svg>
            <span>All Matched Members</span>
          </div>
          <span class="card-badge">{result.matched.length} matched</span>
        </div>
        <div class="card-content">
          <div class="table-container" style="max-height: 400px; overflow-y: auto;">
            <table class="m3-table">
              <thead>
                <tr>
                  <th>PIN</th>
                  <th>HM Name</th>
                  <th>CRM Name</th>
                  <th>Category</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody>
                {result.matched.map(m => (
                  <tr>
                    <td><code>{m.hmRecord.pin || m.crmPin || '-'}</code></td>
                    <td>{m.hmRecord.firstName} {m.hmRecord.surname}</td>
                    <td>
                      <a href={`/members/${m.crmId}`} class="table-link">{m.crmName}</a>
                    </td>
                    <td>{m.hmRecord.category || '-'}</td>
                    <td>
                      {m.differences.length === 0 ? (
                        <span class="status-badge status-success">Match</span>
                      ) : (
                        <span class="status-badge status-warning">{m.differences.length} diff</span>
                      )}
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Summary -->
      <div class="m3-card" style="margin-top: 1.5rem;">
        <div class="card-header">
          <div class="card-title">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="18" y1="20" x2="18" y2="10"/>
              <line x1="12" y1="20" x2="12" y2="4"/>
              <line x1="6" y1="20" x2="6" y2="14"/>
            </svg>
            <span>Summary</span>
          </div>
        </div>
        <div class="card-content" style="padding: 1.25rem;">
          <ul style="margin: 0; padding-left: 1.5rem;">
            <li><strong>{result.matched.length}</strong> members matched between HandicapMaster and CRM</li>
            <li><strong>{result.matched.filter(m => m.differences.length === 0).length}</strong> with identical data</li>
            <li><strong>{result.matched.filter(m => m.differences.length > 0).length}</strong> with field differences</li>
            <li><strong>{result.hmNotInCrm.length}</strong> HandicapMaster members not in CRM</li>
            <li><strong>{result.crmNotInHm.length}</strong> CRM members not in HandicapMaster</li>
          </ul>
        </div>
      </div>
    </>
  )}

  <style>
    .page-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 2rem;
      flex-wrap: wrap;
      gap: 1rem;
    }

    .header-content h1 {
      margin: 0;
      font-size: 1.75rem;
      font-weight: 600;
      color: #1a1a1a;
    }

    .subtitle {
      margin: 0.25rem 0 0 0;
      color: #666;
      font-size: 0.95rem;
    }

    .header-actions .btn {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
    }

    .header-actions .btn svg {
      width: 18px;
      height: 18px;
    }

    /* Stats Row */
    .stats-row {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 1rem;
      margin-bottom: 1.5rem;
    }

    .stat-card {
      background: #fff;
      border-radius: 16px;
      padding: 1.25rem;
      display: flex;
      align-items: center;
      gap: 1rem;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
      border: 1px solid #e8e8e8;
    }

    .stat-icon {
      width: 48px;
      height: 48px;
      border-radius: 12px;
      background: linear-gradient(135deg, #1e5631 0%, #2d7a45 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }

    .stat-icon svg {
      width: 24px;
      height: 24px;
      color: #fff;
    }

    .stat-success .stat-icon { background: linear-gradient(135deg, #28a745 0%, #34ce57 100%); }
    .stat-info .stat-icon { background: linear-gradient(135deg, #0d6efd 0%, #3d8bfd 100%); }

    .stat-content {
      display: flex;
      flex-direction: column;
    }

    .stat-value {
      font-size: 1.75rem;
      font-weight: 700;
      color: #1a1a1a;
      line-height: 1;
    }

    .stat-label {
      font-size: 0.85rem;
      color: #666;
      margin-top: 0.25rem;
    }

    /* Alert */
    .alert {
      display: flex;
      align-items: flex-start;
      gap: 0.75rem;
      padding: 1rem 1.25rem;
      border-radius: 12px;
      margin-bottom: 1.5rem;
    }

    .alert svg {
      width: 20px;
      height: 20px;
      flex-shrink: 0;
      margin-top: 0.125rem;
    }

    .alert-warning {
      background: #fff3cd;
      color: #856404;
      border: 1px solid #ffeeba;
    }

    .alert-success {
      background: #e8f5e9;
      color: #1e5631;
      border: 1px solid #c8e6c9;
    }

    .alert-error {
      background: #ffebee;
      color: #c62828;
      border: 1px solid #ffcdd2;
    }

    /* M3 Card */
    .m3-card {
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
      border: 1px solid #e8e8e8;
      overflow: hidden;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem 1.25rem;
      border-bottom: 1px solid #f0f0f0;
      background: #fafafa;
    }

    .card-title {
      display: flex;
      align-items: center;
      gap: 0.625rem;
      font-weight: 600;
      color: #1a1a1a;
      font-size: 1rem;
    }

    .card-title svg {
      width: 20px;
      height: 20px;
      color: #1e5631;
    }

    .card-badge {
      font-size: 0.75rem;
      padding: 0.25rem 0.625rem;
      background: #e8f5e9;
      color: #1e5631;
      border-radius: 20px;
      font-weight: 500;
    }

    .card-badge.badge-warning {
      background: #fff3cd;
      color: #856404;
    }

    .card-badge.badge-danger {
      background: #f8d7da;
      color: #721c24;
    }

    .card-content {
      padding: 0;
    }

    /* Table */
    .table-container {
      overflow-x: auto;
    }

    .m3-table {
      width: 100%;
      border-collapse: collapse;
    }

    .m3-table th {
      text-align: left;
      padding: 0.875rem 1.25rem;
      font-weight: 600;
      font-size: 0.8rem;
      color: #666;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      background: #fafafa;
      border-bottom: 2px solid #e8e8e8;
      white-space: nowrap;
    }

    .m3-table td {
      padding: 0.75rem 1.25rem;
      font-size: 0.9rem;
      color: #333;
      border-bottom: 1px solid #f0f0f0;
      vertical-align: middle;
    }

    .m3-table tbody tr:hover {
      background: #f8faf8;
    }

    .m3-table tbody tr:last-child td {
      border-bottom: none;
    }

    .table-link {
      color: #1e5631;
      text-decoration: none;
      font-weight: 500;
    }

    .table-link:hover {
      text-decoration: underline;
    }

    .actions-col {
      width: 100px;
      text-align: right;
    }

    /* Status Badge */
    .status-badge {
      display: inline-block;
      padding: 0.25rem 0.5rem;
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: 600;
    }

    .status-success {
      background: #d4edda;
      color: #155724;
    }

    .status-warning {
      background: #fff3cd;
      color: #856404;
    }

    /* Responsive */
    @media (max-width: 900px) {
      .stats-row {
        grid-template-columns: 1fr;
      }
    }

    @media (max-width: 600px) {
      .page-header {
        flex-direction: column;
        align-items: flex-start;
      }
    }
  </style>
</AdminLayout>
