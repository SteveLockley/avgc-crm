---
import AdminLayout from '../../../layouts/AdminLayout.astro';
import { isEmailConfigured, getEmailConfigStatus } from '../../../lib/email';

const db = Astro.locals.runtime.env.DB;
const env = Astro.locals.runtime.env;
const user = Astro.locals.user;

const currentYear = new Date().getFullYear();

// Check email config
const emailConfigured = isEmailConfigured(env);
const emailStatus = getEmailConfigStatus(env);

// Count members in each group
// Exclude Winter members from all April renewal counts (Winter renews 1st October separately)
const allWithEmail = await db.prepare(
  `SELECT COUNT(*) as count FROM members WHERE email IS NOT NULL AND email <> '' AND LOWER(category) <> 'winter'`
).first<{ count: number }>();

const ddPayers = await db.prepare(
  `SELECT COUNT(*) as count FROM members
   WHERE default_payment_method = 'Clubwise Direct Debit'
     AND LOWER(category) <> 'winter'
     AND family_payer_id IS NULL
     AND email IS NOT NULL AND email <> ''`
).first<{ count: number }>();

const bacsPayers = await db.prepare(
  `SELECT COUNT(*) as count FROM members
   WHERE default_payment_method IN ('BACS', 'Over the Till', 'Standing Order', 'Cheque')
     AND LOWER(category) NOT LIKE '%social%'
     AND LOWER(category) <> 'winter'
     AND email IS NOT NULL AND email <> ''`
).first<{ count: number }>();

const socialMembers = await db.prepare(
  `SELECT COUNT(*) as count FROM members
   WHERE LOWER(category) LIKE '%social%'
     AND email IS NOT NULL AND email <> ''`
).first<{ count: number }>();

// Members with no email
const noEmailMembers = await db.prepare(
  `SELECT club_number, title, first_name, surname, category
   FROM members
   WHERE email IS NULL OR email = ''
   ORDER BY surname, first_name`
).all();

// Members who have not consented to electronic communication
const noConsentMembers = await db.prepare(
  `SELECT club_number, title, first_name, surname, category, email
   FROM members
   WHERE electronic_communication_consent <> 'Yes'
     AND email IS NOT NULL AND email <> ''
   ORDER BY surname, first_name`
).all();

const adminEmail = user?.email || '';

// Count members eligible for invoice generation (sent email but no invoice yet)
const periodStart = `${currentYear}-04-01`;
const periodEnd = `${currentYear + 1}-03-31`;

const ddInvoiceEligible = await db.prepare(
  `SELECT COUNT(DISTINCT m.id) as count
   FROM sent_emails se
   INNER JOIN members m ON m.id = se.member_id
   LEFT JOIN invoices inv ON inv.member_id = m.id AND inv.period_start = ? AND inv.period_end = ? AND inv.status != 'cancelled'
   WHERE se.email_type = 'dd_renewal' AND se.year = ? AND se.status = 'sent' AND inv.id IS NULL`
).bind(periodStart, periodEnd, currentYear).first<{ count: number }>();

const bacsInvoiceEligible = await db.prepare(
  `SELECT COUNT(DISTINCT m.id) as count
   FROM sent_emails se
   INNER JOIN members m ON m.id = se.member_id
   LEFT JOIN invoices inv ON inv.member_id = m.id AND inv.period_start = ? AND inv.period_end = ? AND inv.status != 'cancelled'
   WHERE se.email_type = 'bacs_renewal' AND se.year = ? AND se.status = 'sent' AND inv.id IS NULL`
).bind(periodStart, periodEnd, currentYear).first<{ count: number }>();

const socialInvoiceEligible = await db.prepare(
  `SELECT COUNT(DISTINCT m.id) as count
   FROM sent_emails se
   INNER JOIN members m ON m.id = se.member_id
   LEFT JOIN invoices inv ON inv.member_id = m.id AND inv.period_start = ? AND inv.period_end = ? AND inv.status != 'cancelled'
   WHERE se.email_type = 'social_renewal' AND se.year = ? AND se.status = 'sent' AND inv.id IS NULL`
).bind(periodStart, periodEnd, currentYear).first<{ count: number }>();

// Count already-created invoices for this period
const existingInvoices = await db.prepare(
  `SELECT COUNT(*) as count FROM invoices WHERE period_start = ? AND period_end = ? AND status != 'cancelled'`
).bind(periodStart, periodEnd).first<{ count: number }>();
---

<AdminLayout title="Subscription Renewals">
  <div class="page-header">
    <div class="header-left">
      <a href="/admin/members" class="back-link">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15 18 9 12 15 6"/></svg>
        Members
      </a>
      <h1>Subscription Renewals</h1>
    </div>
    <div class="header-right">
      <a href="/admin/members/email-log" class="btn btn-secondary btn-sm">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:16px;height:16px;">
          <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
          <polyline points="14 2 14 8 20 8"/>
          <line x1="16" y1="13" x2="8" y2="13"/>
          <line x1="16" y1="17" x2="8" y2="17"/>
          <polyline points="10 9 9 9 8 9"/>
        </svg>
        Email Log
      </a>
      <label class="year-label">
        Year
        <input type="number" id="renewal-year" value={currentYear} min="2024" max="2030" class="year-input" />
      </label>
    </div>
  </div>

  {!emailConfigured && (
    <div class="alert alert-warning">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
        <line x1="12" y1="9" x2="12" y2="13"/>
        <line x1="12" y1="17" x2="12.01" y2="17"/>
      </svg>
      Email is not configured. {emailStatus.details}
    </div>
  )}

  {adminEmail ? (
    <div class="alert alert-info">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="12" cy="12" r="10"/>
        <line x1="12" y1="16" x2="12" y2="12"/>
        <line x1="12" y1="8" x2="12.01" y2="8"/>
      </svg>
      Test emails will be sent to: <strong>{adminEmail}</strong>
    </div>
  ) : (
    <div class="alert alert-warning">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
        <line x1="12" y1="9" x2="12" y2="13"/>
        <line x1="12" y1="17" x2="12.01" y2="17"/>
      </svg>
      Could not detect your email address — test sends will not work. Check Cloudflare Access login.
    </div>
  )}

  <!-- Inbox Status -->
  <div class="inbox-card" id="inbox-card">
    <div class="inbox-content">
      <a href="#" id="owa-link" target="_blank" class="btn btn-secondary inbox-btn">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
          <polyline points="22,6 12,13 2,6"/>
        </svg>
        Open Inbox
      </a>
      <div class="inbox-stats">
        <span class="inbox-stat" id="unread-stat">
          <span class="stat-num" id="unread-count">-</span> Unread
        </span>
        <span class="inbox-stat bounced" id="bounced-stat">
          <span class="stat-num" id="bounced-count">-</span> Bounced
        </span>
      </div>
    </div>
  </div>

  <!-- Data Quality Warnings -->
  {(noEmailMembers.results?.length > 0 || noConsentMembers.results?.length > 0) && (
    <div class="warnings-section">

      {noEmailMembers.results?.length > 0 && (
        <details class="warning-card warning-no-email">
          <summary class="warning-header">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
              <polyline points="22,6 12,13 2,6"/>
              <line x1="1" y1="1" x2="23" y2="23" stroke-width="2.5"/>
            </svg>
            <span class="warning-title">
              <strong>{noEmailMembers.results.length} member{noEmailMembers.results.length !== 1 ? 's' : ''} with no email address</strong>
              <span class="warning-subtitle">These members will not receive any renewal emails</span>
            </span>
          </summary>
          <div class="warning-body">
            <table class="warning-table">
              <thead>
                <tr>
                  <th>No.</th>
                  <th>Name</th>
                  <th>Category</th>
                </tr>
              </thead>
              <tbody>
                {noEmailMembers.results.map((m: any) => (
                  <tr>
                    <td>{m.club_number || '—'}</td>
                    <td>{[m.title, m.first_name, m.surname].filter(Boolean).join(' ')}</td>
                    <td>{m.category || '—'}</td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        </details>
      )}

      {noConsentMembers.results?.length > 0 && (
        <details class="warning-card warning-no-consent">
          <summary class="warning-header">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
              <line x1="12" y1="8" x2="12" y2="12"/>
              <line x1="12" y1="16" x2="12.01" y2="16"/>
            </svg>
            <span class="warning-title">
              <strong>{noConsentMembers.results.length} member{noConsentMembers.results.length !== 1 ? 's' : ''} without GDPR consent</strong>
              <span class="warning-subtitle">Have email but have not consented to electronic communication</span>
            </span>
          </summary>
          <div class="warning-body">
            <table class="warning-table">
              <thead>
                <tr>
                  <th>No.</th>
                  <th>Name</th>
                  <th>Category</th>
                  <th>Email</th>
                </tr>
              </thead>
              <tbody>
                {noConsentMembers.results.map((m: any) => (
                  <tr>
                    <td>{m.club_number || '—'}</td>
                    <td>{[m.title, m.first_name, m.surname].filter(Boolean).join(' ')}</td>
                    <td>{m.category || '—'}</td>
                    <td>{m.email}</td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        </details>
      )}

    </div>
  )}

  <!-- Batch Cards -->
  <div class="batch-cards">

    <!-- 1. General Fees Notice -->
    <div class="batch-card" id="batch-fees">
      <div class="batch-header">
        <div class="batch-number">1</div>
        <div class="batch-info">
          <h3>General Fees Notice</h3>
          <p>All members with email ({allWithEmail?.count || 0} members)</p>
        </div>
        <div class="batch-status" id="status-fees">Idle</div>
      </div>
      <div class="batch-progress" id="progress-fees" style="display:none;">
        <div class="progress-bar"><div class="progress-fill" id="fill-fees"></div></div>
        <span class="progress-text" id="text-fees"></span>
      </div>
      <div class="batch-actions">
        <button class="btn btn-secondary btn-sm" onclick="sendBatch('fees', 'test')" {!emailConfigured && 'disabled'}>
          Send Test
        </button>
        <button class="btn btn-primary btn-sm" onclick="sendBatch('fees', 'bulk')" {!emailConfigured && 'disabled'}>
          Send to All
        </button>
      </div>
    </div>

    <!-- 2. DD Renewal Notices -->
    <div class="batch-card" id="batch-dd">
      <div class="batch-header">
        <div class="batch-number">2</div>
        <div class="batch-info">
          <h3>DD Renewal Notices</h3>
          <p>Clubwise Direct Debit payers ({ddPayers?.count || 0} members)</p>
        </div>
        <div class="batch-status" id="status-dd">Idle</div>
      </div>
      <div class="batch-progress" id="progress-dd" style="display:none;">
        <div class="progress-bar"><div class="progress-fill" id="fill-dd"></div></div>
        <span class="progress-text" id="text-dd"></span>
      </div>
      <div class="batch-actions">
        <button class="btn btn-secondary btn-sm" onclick="sendBatch('dd', 'test')" {!emailConfigured && 'disabled'}>
          Send Test
        </button>
        <button class="btn btn-outline btn-sm" onclick="sendBatch('dd', 'sample')" {!emailConfigured && 'disabled'}>
          Send Sample (1 per category)
        </button>
        <button class="btn btn-primary btn-sm" onclick="sendBatch('dd', 'bulk')" {!emailConfigured && 'disabled'}>
          Send to All
        </button>
      </div>
    </div>

    <!-- 3. BACS / Other Payment Renewal -->
    <div class="batch-card" id="batch-bacs">
      <div class="batch-header">
        <div class="batch-number">3</div>
        <div class="batch-info">
          <h3>BACS / Other Payment Renewal</h3>
          <p>BACS, OTT, Standing Order, Cheque ({bacsPayers?.count || 0} members)</p>
        </div>
        <div class="batch-status" id="status-bacs">Idle</div>
      </div>
      <div class="batch-progress" id="progress-bacs" style="display:none;">
        <div class="progress-bar"><div class="progress-fill" id="fill-bacs"></div></div>
        <span class="progress-text" id="text-bacs"></span>
      </div>
      <div class="batch-actions">
        <button class="btn btn-secondary btn-sm" onclick="sendBatch('bacs', 'test')" {!emailConfigured && 'disabled'}>
          Send Test
        </button>
        <button class="btn btn-outline btn-sm" onclick="sendBatch('bacs', 'sample')" {!emailConfigured && 'disabled'}>
          Send Sample (1 per category)
        </button>
        <button class="btn btn-primary btn-sm" onclick="sendBatch('bacs', 'bulk')" {!emailConfigured && 'disabled'}>
          Send to All
        </button>
        <a href="/documents/dd-mandate-form.pdf" target="_blank" class="btn btn-secondary btn-sm dd-mandate-link">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:14px;height:14px;">
            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
            <polyline points="14 2 14 8 20 8"/>
            <line x1="16" y1="13" x2="8" y2="13"/>
            <line x1="16" y1="17" x2="8" y2="17"/>
          </svg>
          DD Mandate Form
        </a>
      </div>
    </div>

    <!-- 4. Social Membership Renewal -->
    <div class="batch-card" id="batch-social">
      <div class="batch-header">
        <div class="batch-number">4</div>
        <div class="batch-info">
          <h3>Social Membership Renewal</h3>
          <p>Social members ({socialMembers?.count || 0} members)</p>
        </div>
        <div class="batch-status" id="status-social">Idle</div>
      </div>
      <div class="batch-progress" id="progress-social" style="display:none;">
        <div class="progress-bar"><div class="progress-fill" id="fill-social"></div></div>
        <span class="progress-text" id="text-social"></span>
      </div>
      <div class="batch-actions">
        <button class="btn btn-secondary btn-sm" onclick="sendBatch('social', 'test')" {!emailConfigured && 'disabled'}>
          Send Test
        </button>
        <button class="btn btn-outline btn-sm" onclick="sendBatch('social', 'sample')" {!emailConfigured && 'disabled'}>
          Send Sample (1 per category)
        </button>
        <button class="btn btn-primary btn-sm" onclick="sendBatch('social', 'bulk')" {!emailConfigured && 'disabled'}>
          Send to All
        </button>
      </div>
    </div>

  </div>

  <!-- Invoice Generation -->
  <h2 class="section-heading">Invoice Generation</h2>
  <p class="section-desc">
    Generate draft invoices for members who have been sent renewal emails.
    {existingInvoices?.count ? `${existingInvoices.count} invoices already exist for ${currentYear}/${currentYear + 1}.` : ''}
    <a href="/admin/invoices" class="inline-link">View all invoices</a>
  </p>

  <div class="batch-cards">
    <!-- DD Invoices -->
    <div class="batch-card" id="batch-inv-dd">
      <div class="batch-header">
        <div class="batch-number inv-number">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:18px;height:18px;">
            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
            <polyline points="14 2 14 8 20 8"/>
            <line x1="16" y1="13" x2="8" y2="13"/>
            <line x1="16" y1="17" x2="8" y2="17"/>
          </svg>
        </div>
        <div class="batch-info">
          <h3>DD Member Invoices</h3>
          <p><span id="inv-dd-eligible">{ddInvoiceEligible?.count || 0}</span> members eligible</p>
        </div>
        <div class="batch-status" id="status-inv-dd">Idle</div>
      </div>
      <div class="batch-progress" id="progress-inv-dd" style="display:none;">
        <div class="progress-bar"><div class="progress-fill" id="fill-inv-dd"></div></div>
        <span class="progress-text" id="text-inv-dd"></span>
      </div>
      <div class="batch-actions">
        <button class="btn btn-primary btn-sm" onclick="generateInvoices('dd_renewal')" id="btn-inv-dd">
          Generate Invoices
        </button>
      </div>
    </div>

    <!-- BACS Invoices -->
    <div class="batch-card" id="batch-inv-bacs">
      <div class="batch-header">
        <div class="batch-number inv-number">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:18px;height:18px;">
            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
            <polyline points="14 2 14 8 20 8"/>
            <line x1="16" y1="13" x2="8" y2="13"/>
            <line x1="16" y1="17" x2="8" y2="17"/>
          </svg>
        </div>
        <div class="batch-info">
          <h3>BACS / Other Payment Invoices</h3>
          <p><span id="inv-bacs-eligible">{bacsInvoiceEligible?.count || 0}</span> members eligible</p>
        </div>
        <div class="batch-status" id="status-inv-bacs">Idle</div>
      </div>
      <div class="batch-progress" id="progress-inv-bacs" style="display:none;">
        <div class="progress-bar"><div class="progress-fill" id="fill-inv-bacs"></div></div>
        <span class="progress-text" id="text-inv-bacs"></span>
      </div>
      <div class="batch-actions">
        <button class="btn btn-primary btn-sm" onclick="generateInvoices('bacs_renewal')" id="btn-inv-bacs">
          Generate Invoices
        </button>
      </div>
    </div>

    <!-- Social Invoices -->
    <div class="batch-card" id="batch-inv-social">
      <div class="batch-header">
        <div class="batch-number inv-number">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:18px;height:18px;">
            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
            <polyline points="14 2 14 8 20 8"/>
            <line x1="16" y1="13" x2="8" y2="13"/>
            <line x1="16" y1="17" x2="8" y2="17"/>
          </svg>
        </div>
        <div class="batch-info">
          <h3>Social Member Invoices</h3>
          <p><span id="inv-social-eligible">{socialInvoiceEligible?.count || 0}</span> members eligible</p>
        </div>
        <div class="batch-status" id="status-inv-social">Idle</div>
      </div>
      <div class="batch-progress" id="progress-inv-social" style="display:none;">
        <div class="progress-bar"><div class="progress-fill" id="fill-inv-social"></div></div>
        <span class="progress-text" id="text-inv-social"></span>
      </div>
      <div class="batch-actions">
        <button class="btn btn-primary btn-sm" onclick="generateInvoices('social_renewal')" id="btn-inv-social">
          Generate Invoices
        </button>
      </div>
    </div>
  </div>

  <style>
    .page-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
      flex-wrap: wrap;
      gap: 1rem;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .back-link {
      display: flex;
      align-items: center;
      gap: 0.25rem;
      color: #666;
      text-decoration: none;
      font-size: 0.9rem;
      transition: color 0.2s;
    }

    .back-link:hover { color: #1e5631; }

    .back-link svg {
      width: 18px;
      height: 18px;
    }

    .page-header h1 {
      margin: 0;
      font-size: 1.75rem;
      font-weight: 600;
      color: #1a1a1a;
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .year-label {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.9rem;
      font-weight: 500;
      color: #666;
    }

    .year-input {
      width: 90px;
      padding: 0.5rem 0.75rem;
      border: 1px solid #ddd;
      border-radius: 10px;
      font-size: 1rem;
      font-weight: 600;
      text-align: center;
    }

    .year-input:focus {
      outline: none;
      border-color: #1e5631;
      box-shadow: 0 0 0 3px rgba(30, 86, 49, 0.1);
    }

    /* Alert */
    .alert {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 1rem 1.25rem;
      border-radius: 12px;
      margin-bottom: 1.5rem;
      font-size: 0.9rem;
    }

    .alert svg {
      width: 20px;
      height: 20px;
      flex-shrink: 0;
    }

    .alert-warning {
      background: #fff3e0;
      color: #e65100;
      border: 1px solid #ffcc80;
    }

    .alert-info {
      background: #e3f2fd;
      color: #1565c0;
      border: 1px solid #90caf9;
    }

    /* Inbox Card */
    .inbox-card {
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
      border: 1px solid #e8e8e8;
      padding: 1rem 1.25rem;
      margin-bottom: 1.5rem;
    }

    .inbox-content {
      display: flex;
      align-items: center;
      gap: 1.5rem;
      flex-wrap: wrap;
    }

    .inbox-btn {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
    }

    .inbox-btn svg {
      width: 18px;
      height: 18px;
    }

    .inbox-stats {
      display: flex;
      gap: 1.5rem;
    }

    .inbox-stat {
      display: flex;
      align-items: center;
      gap: 0.375rem;
      font-size: 0.9rem;
      color: #666;
    }

    .stat-num {
      font-weight: 700;
      font-size: 1.1rem;
      color: #1a1a1a;
    }

    .inbox-stat.bounced .stat-num {
      color: #c62828;
    }

    /* Data Quality Warnings */
    .warnings-section {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
      margin-bottom: 1.5rem;
    }

    .warning-card {
      background: #fff;
      border-radius: 12px;
      border: 1px solid #e8e8e8;
      overflow: hidden;
    }

    .warning-header {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 1rem 1.25rem;
      cursor: pointer;
      list-style: none;
      user-select: none;
    }

    .warning-header::-webkit-details-marker {
      display: none;
    }

    .warning-header svg {
      width: 22px;
      height: 22px;
      flex-shrink: 0;
    }

    .warning-no-email .warning-header {
      background: #fff8e1;
    }

    .warning-no-email .warning-header svg {
      color: #f57f17;
    }

    .warning-no-consent .warning-header {
      background: #fce4ec;
    }

    .warning-no-consent .warning-header svg {
      color: #c62828;
    }

    .warning-title {
      display: flex;
      flex-direction: column;
      gap: 0.125rem;
    }

    .warning-title strong {
      font-size: 0.9rem;
      color: #1a1a1a;
    }

    .warning-subtitle {
      font-size: 0.8rem;
      color: #666;
    }

    .warning-body {
      border-top: 1px solid #e8e8e8;
      max-height: 300px;
      overflow-y: auto;
    }

    .warning-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.85rem;
    }

    .warning-table th {
      text-align: left;
      padding: 0.5rem 1rem;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: #666;
      background: #fafafa;
      border-bottom: 1px solid #e8e8e8;
      position: sticky;
      top: 0;
    }

    .warning-table td {
      padding: 0.4rem 1rem;
      border-bottom: 1px solid #f0f0f0;
      color: #333;
    }

    .warning-table tr:last-child td {
      border-bottom: none;
    }

    .warning-table tbody tr:hover {
      background: #f9f9f9;
    }

    /* Batch Cards */
    .batch-cards {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .batch-card {
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
      border: 1px solid #e8e8e8;
      padding: 1.25rem;
    }

    .batch-header {
      display: flex;
      align-items: center;
      gap: 1rem;
      margin-bottom: 0.75rem;
    }

    .batch-number {
      width: 36px;
      height: 36px;
      border-radius: 10px;
      background: linear-gradient(135deg, #1e5631 0%, #2d7a45 100%);
      color: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 1rem;
      flex-shrink: 0;
    }

    .batch-info {
      flex: 1;
    }

    .batch-info h3 {
      margin: 0;
      font-size: 1rem;
      font-weight: 600;
      color: #1a1a1a;
    }

    .batch-info p {
      margin: 0.125rem 0 0 0;
      font-size: 0.85rem;
      color: #666;
    }

    .batch-status {
      padding: 0.25rem 0.75rem;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 500;
      background: #f0f0f0;
      color: #666;
      white-space: nowrap;
    }

    .batch-status.sending {
      background: #e3f2fd;
      color: #1565c0;
    }

    .batch-status.done {
      background: #e8f5e9;
      color: #2e7d32;
    }

    .batch-status.error {
      background: #ffebee;
      color: #c62828;
    }

    .batch-progress {
      margin-bottom: 0.75rem;
    }

    .progress-bar {
      height: 6px;
      background: #e8e8e8;
      border-radius: 3px;
      overflow: hidden;
      margin-bottom: 0.375rem;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #1e5631, #2d7a45);
      border-radius: 3px;
      transition: width 0.3s ease;
      width: 0%;
    }

    .progress-text {
      font-size: 0.8rem;
      color: #666;
    }

    .batch-actions {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
    }

    .btn-outline {
      background: #fff;
      color: #1e5631;
      border: 1.5px solid #1e5631;
    }

    .btn-outline:hover {
      background: #f0f7f2;
    }

    .dd-mandate-link {
      display: inline-flex;
      align-items: center;
      gap: 0.375rem;
      margin-left: auto;
    }

    /* Invoice Generation Section */
    .section-heading {
      font-size: 1.35rem;
      font-weight: 600;
      color: #1a1a1a;
      margin: 2.5rem 0 0.25rem 0;
    }

    .section-desc {
      font-size: 0.9rem;
      color: #666;
      margin: 0 0 1rem 0;
    }

    .inline-link {
      color: #1e5631;
      text-decoration: none;
      font-weight: 500;
    }

    .inline-link:hover {
      text-decoration: underline;
    }

    .inv-number {
      background: linear-gradient(135deg, #1565c0 0%, #1e88e5 100%);
    }

    @media (max-width: 600px) {
      .page-header {
        flex-direction: column;
        align-items: flex-start;
      }

      .batch-header {
        flex-wrap: wrap;
      }

      .batch-actions {
        flex-direction: column;
      }

      .dd-mandate-link {
        margin-left: 0;
      }
    }
  </style>

  <script is:inline define:vars={{ adminEmail }}>
    const ENDPOINTS = {
      fees: '/api/send-fees-notification',
      dd: '/api/send-dd-renewal',
      bacs: '/api/send-bacs-renewal',
      social: '/api/send-social-renewal',
    };

    function getYear() {
      return parseInt(document.getElementById('renewal-year').value) || new Date().getFullYear();
    }

    // Get all buttons in a batch card
    function setBatchButtons(type, disabled) {
      const card = document.getElementById('batch-' + type);
      if (!card) return;
      card.querySelectorAll('button').forEach(function(btn) {
        btn.disabled = disabled;
        if (disabled) btn.style.opacity = '0.6';
        else btn.style.opacity = '';
      });
    }

    // Load inbox status
    async function loadInboxStatus() {
      try {
        const res = await fetch('/api/inbox-status');
        const data = await res.json();
        document.getElementById('unread-count').textContent = data.unreadCount ?? '-';
        document.getElementById('bounced-count').textContent = data.bouncedCount ?? '-';
        if (data.owaLink) {
          document.getElementById('owa-link').href = data.owaLink;
        }
      } catch (e) {
        // Silently fail - inbox status is non-critical
      }
    }
    loadInboxStatus();

    window.sendBatch = sendBatch;
    async function sendBatch(type, mode) {
      // mode: 'test', 'sample', or 'bulk'
      const year = getYear();
      const endpoint = ENDPOINTS[type];
      if (!endpoint) return;

      const statusEl = document.getElementById('status-' + type);
      const progressEl = document.getElementById('progress-' + type);
      const fillEl = document.getElementById('fill-' + type);
      const textEl = document.getElementById('text-' + type);

      if (mode === 'test' || mode === 'sample') {
        // Check we have an admin email
        if (!adminEmail) {
          await m3Alert('Could not determine your email address. Please check you are logged in via Cloudflare Access.', { title: 'No Email', type: 'error' });
          return;
        }

        const isSample = mode === 'sample';
        const label = isSample ? 'Sending samples...' : 'Sending test...';

        setBatchButtons(type, true);
        statusEl.textContent = label;
        statusEl.className = 'batch-status sending';

        try {
          const payload = { testEmail: adminEmail, year };
          if (isSample) payload.sample = true;

          const res = await fetch(endpoint, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload),
          });
          const data = await res.json();

          if (data.success || data.sentTo) {
            statusEl.className = 'batch-status done';

            if (isSample && data.categories) {
              statusEl.textContent = data.failed > 0 ? `${data.sent} sent, ${data.failed} failed` : `${data.sent} samples sent`;
              statusEl.className = data.failed > 0 ? 'batch-status error' : 'batch-status done';
              const catList = data.categories.join(', ');
              let msg = `Sent ${data.sent} sample email(s) to ${adminEmail}.\n\nCategories: ${catList}`;
              if (data.failed > 0) {
                msg += `\n\n${data.failed} failed:`;
                if (data.errors && data.errors.length > 0) {
                  msg += '\n' + data.errors.join('\n');
                } else {
                  msg += '\nCategory with no subscription fee configured (check payment_items table)';
                }
              }
              await m3Alert(msg, { title: data.failed > 0 ? 'Samples Sent (with errors)' : 'Sample Emails Sent', type: data.failed > 0 ? 'warning' : 'success' });
            } else {
              statusEl.textContent = 'Test sent';
              const msg = data.sampleMember
                ? `Test sent to ${adminEmail} using ${data.sampleMember}'s data`
                : `Test sent to ${adminEmail}`;
              await m3Alert(msg, { title: 'Test Email Sent', type: 'success' });
            }
          } else {
            statusEl.textContent = isSample ? 'Sample failed' : 'Test failed';
            statusEl.className = 'batch-status error';
            await m3Alert(data.error || 'Unknown error', { title: 'Failed', type: 'error' });
          }
        } catch (e) {
          statusEl.textContent = 'Error';
          statusEl.className = 'batch-status error';
          await m3Alert(e.message, { title: 'Error', type: 'error' });
        } finally {
          setBatchButtons(type, false);
        }

        return;
      }

      // Bulk mode - confirm first
      const typeLabels = {
        fees: 'general fees notification',
        dd: 'DD renewal notice',
        bacs: 'BACS/OTT renewal notice',
        social: 'Social renewal notice',
      };

      const confirmed = await m3Confirm(
        `This will send the ${typeLabels[type]} to ALL eligible members for ${year}. Already-sent members will be skipped automatically. This cannot be undone.`,
        {
          title: 'Send to All?',
          type: 'warning',
          confirmText: 'Send to All',
          cancelText: 'Cancel',
        }
      );

      if (!confirmed) return;

      setBatchButtons(type, true);
      statusEl.textContent = 'Sending...';
      statusEl.className = 'batch-status sending';
      progressEl.style.display = 'block';
      fillEl.style.width = '5%';
      textEl.textContent = 'Starting batch send...';

      let totalSent = 0;
      let totalFailed = 0;
      let allErrors = [];
      let batchNum = 0;

      try {
        while (true) {
          batchNum++;
          statusEl.textContent = `Sending batch ${batchNum}...`;

          const res = await fetch(endpoint, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ year }),
          });
          const data = await res.json();

          if (data.error && data.sent === undefined) {
            // Fatal error
            textEl.textContent = data.error;
            statusEl.textContent = 'Error';
            statusEl.className = 'batch-status error';
            break;
          }

          totalSent += (data.sent || 0);
          totalFailed += (data.failed || 0);
          if (data.errors) allErrors = allErrors.concat(data.errors);

          const processed = totalSent + totalFailed;
          const grandTotal = processed + (data.remaining || 0);

          if (grandTotal > 0) {
            const pct = Math.min(Math.round((processed / grandTotal) * 100), 100);
            fillEl.style.width = pct + '%';
          }
          textEl.textContent = `${totalSent} sent, ${totalFailed} failed of ${processed + (data.remaining || 0)}`;

          if (!data.remaining || data.remaining <= 0) {
            // All done
            fillEl.style.width = '100%';
            if (totalFailed > 0) {
              statusEl.textContent = `Done (${totalFailed} errors)`;
              statusEl.className = 'batch-status error';
            } else if (totalSent === 0) {
              statusEl.textContent = 'All already sent';
              statusEl.className = 'batch-status done';
              textEl.textContent = 'All members have already been emailed for this year';
            } else {
              statusEl.textContent = 'Done';
              statusEl.className = 'batch-status done';
            }
            break;
          }
        }
      } catch (e) {
        fillEl.style.width = '100%';
        fillEl.style.background = '#c62828';
        textEl.textContent = `${totalSent} sent, ${totalFailed} failed — error: ${e.message}`;
        statusEl.textContent = 'Error (can resume)';
        statusEl.className = 'batch-status error';
      } finally {
        setBatchButtons(type, false);
      }
    }

    // Invoice generation
    const INV_TYPE_MAP = {
      dd_renewal: 'inv-dd',
      bacs_renewal: 'inv-bacs',
      social_renewal: 'inv-social',
    };

    const INV_LABELS = {
      dd_renewal: 'DD',
      bacs_renewal: 'BACS/Other',
      social_renewal: 'Social',
    };

    window.generateInvoices = generateInvoices;
    async function generateInvoices(emailType) {
      const key = INV_TYPE_MAP[emailType];
      if (!key) return;

      const year = getYear();
      const statusEl = document.getElementById('status-' + key);
      const progressEl = document.getElementById('progress-' + key);
      const fillEl = document.getElementById('fill-' + key);
      const textEl = document.getElementById('text-' + key);
      const btn = document.getElementById('btn-' + key);

      const label = INV_LABELS[emailType];
      const confirmed = await m3Confirm(
        `This will generate draft invoices for all ${label} members who received a renewal email for ${year} and don't already have an invoice. Continue?`,
        {
          title: 'Generate Invoices?',
          type: 'info',
          confirmText: 'Generate',
          cancelText: 'Cancel',
        }
      );
      if (!confirmed) return;

      btn.disabled = true;
      btn.style.opacity = '0.6';
      statusEl.textContent = 'Generating...';
      statusEl.className = 'batch-status sending';
      progressEl.style.display = 'block';
      fillEl.style.width = '5%';
      textEl.textContent = 'Starting invoice generation...';

      let totalCreated = 0;
      let totalFailed = 0;
      let allErrors = [];
      let batchNum = 0;

      try {
        while (true) {
          batchNum++;
          statusEl.textContent = `Generating batch ${batchNum}...`;

          const res = await fetch('/api/generate-renewal-invoices', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ emailType, year }),
          });
          const data = await res.json();

          if (data.error && data.created === undefined) {
            textEl.textContent = data.error;
            statusEl.textContent = 'Error';
            statusEl.className = 'batch-status error';
            break;
          }

          totalCreated += (data.created || 0);
          totalFailed += (data.failed || 0);
          if (data.errors) allErrors = allErrors.concat(data.errors);

          const processed = totalCreated + totalFailed;
          const grandTotal = processed + (data.remaining || 0);

          if (grandTotal > 0) {
            const pct = Math.min(Math.round((processed / grandTotal) * 100), 100);
            fillEl.style.width = pct + '%';
          }
          textEl.textContent = `${totalCreated} created, ${totalFailed} failed` + (data.remaining > 0 ? ` (${data.remaining} remaining)` : '');

          if (!data.remaining || data.remaining <= 0) {
            fillEl.style.width = '100%';
            if (totalFailed > 0) {
              statusEl.textContent = `Done (${totalFailed} errors)`;
              statusEl.className = 'batch-status error';
            } else if (totalCreated === 0) {
              statusEl.textContent = 'All invoiced';
              statusEl.className = 'batch-status done';
              textEl.textContent = 'All members already have invoices for this period';
            } else {
              statusEl.textContent = 'Done';
              statusEl.className = 'batch-status done';
            }
            break;
          }
        }
      } catch (e) {
        fillEl.style.width = '100%';
        fillEl.style.background = '#c62828';
        textEl.textContent = `${totalCreated} created, ${totalFailed} failed — error: ${e.message}`;
        statusEl.textContent = 'Error (can resume)';
        statusEl.className = 'batch-status error';
      } finally {
        btn.disabled = false;
        btn.style.opacity = '';
      }

      // Update eligible counts
      document.getElementById('inv-dd-eligible').textContent = '...';
      document.getElementById('inv-bacs-eligible').textContent = '...';
      document.getElementById('inv-social-eligible').textContent = '...';
    }
  </script>
</AdminLayout>
