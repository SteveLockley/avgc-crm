---
import AdminLayout from '../../../layouts/AdminLayout.astro';
import { PAYMENT_METHODS, AGE_GROUPS, FEE_TEMPLATES, ZERO_COST_SUBSCRIPTIONS } from '../../../lib/db';

const db = Astro.locals.runtime.env.DB;

// Load subscription types from payment_items
const subscriptionTypesResult = await db.prepare(
  `SELECT name FROM payment_items WHERE category = 'Subscription' AND active = 1 ORDER BY name`
).all();
const subscriptionTypes = (subscriptionTypesResult.results || []).map((r: any) => r.name as string);

let error = '';

if (Astro.request.method === 'POST') {
  const formData = await Astro.request.formData();

  const member: Record<string, any> = {};
  const fields = [
    'surname', 'first_name', 'middle_initials', 'title', 'gender', 'date_of_birth',
    'address_1', 'address_2', 'address_3', 'address_4', 'address_5',
    'telephone_1', 'telephone_2', 'telephone_3', 'email',
    'category', 'age_group', 'home_away', 'home_club', 'subscription_template',
    'handicap_index', 'national_id', 'national_id_country',
    'date_joined', 'date_renewed', 'date_expires', 'date_subscription_paid',
    'default_payment_method', 'send_invoice_by',
    'locker_number', 'pin', 'club_number',
    'electronic_communication_consent'
  ];

  for (const field of fields) {
    const value = formData.get(field);
    if (value !== null && value !== '') {
      member[field] = value;
    }
  }

  // Convert numeric fields
  if (member.handicap_index) {
    member.handicap_index = parseFloat(member.handicap_index) || null;
  }

  // For zero-cost subscriptions, auto-calculate the fee template
  const category = member.category || '';
  if (ZERO_COST_SUBSCRIPTIONS.includes(category as any)) {
    const hasNationalId = member.national_id && member.national_id.trim() !== '';
    const isHomeClub = member.home_away === 'H';
    const hasLocker = member.locker_number && member.locker_number.trim() !== '';

    if (hasNationalId && isHomeClub && hasLocker) {
      member.subscription_template = 'England Golf and County Fees and Locker';
    } else if (hasNationalId && isHomeClub) {
      member.subscription_template = 'England Golf and County Fees';
    } else if (hasLocker) {
      member.subscription_template = 'Locker';
    } else {
      member.subscription_template = null;
    }
  } else {
    // Non-zero-cost subscriptions don't use fee templates
    member.subscription_template = null;
  }

  // Set defaults
  member.account_balance = 0;
  member.competition_fee_purse = 0;
  member.home_club = member.home_club || 'Alnmouth Village';

  const columns = Object.keys(member);
  const placeholders = columns.map(() => '?').join(', ');
  const values = Object.values(member);

  try {
    const result = await db.prepare(
      `INSERT INTO members (${columns.join(', ')}) VALUES (${placeholders})`
    ).bind(...values).run();

    const newId = result.meta.last_row_id;

    // Log the creation
    await db.prepare(
      `INSERT INTO audit_log (user_email, action, entity_type, entity_id, details)
       VALUES (?, 'create', 'member', ?, ?)`
    ).bind(Astro.locals.user?.email || 'system', newId, JSON.stringify(member)).run();

    return Astro.redirect(`/admin/members/${newId}`);
  } catch (e: any) {
    error = `Failed to create member: ${e.message}`;
  }
}

// Set default date joined to today
const today = new Date().toISOString().split('T')[0];
---

<AdminLayout title="New Member">
  <div style="display: flex; gap: 1rem; margin-bottom: 1.5rem;">
    <button type="button" onclick="handleBack()" class="btn btn-secondary">&larr; Back to Members</button>
  </div>

  {error && <div class="alert alert-error">{error}</div>}

  <form method="POST">
    <div class="card">
      <div class="card-header">
        <h3 class="card-title">Personal Information</h3>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label class="form-label" for="title">Title</label>
          <select name="title" id="title" class="form-input">
            <option value="">-</option>
            <option value="Mr">Mr</option>
            <option value="Mrs">Mrs</option>
            <option value="Ms">Ms</option>
            <option value="Miss">Miss</option>
            <option value="Dr">Dr</option>
            <option value="Prof">Prof</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label" for="first_name">First Name *</label>
          <input type="text" name="first_name" id="first_name" class="form-input" required />
        </div>
        <div class="form-group">
          <label class="form-label" for="middle_initials">Middle Initials</label>
          <input type="text" name="middle_initials" id="middle_initials" class="form-input" />
        </div>
        <div class="form-group">
          <label class="form-label" for="surname">Surname *</label>
          <input type="text" name="surname" id="surname" class="form-input" required />
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label class="form-label" for="gender">Gender</label>
          <select name="gender" id="gender" class="form-input">
            <option value="">-</option>
            <option value="M">Male</option>
            <option value="F">Female</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label" for="date_of_birth">Date of Birth</label>
          <input type="date" name="date_of_birth" id="date_of_birth" class="form-input" />
        </div>
        <div class="form-group">
          <label class="form-label" for="age_group">Age Group</label>
          <select name="age_group" id="age_group" class="form-input">
            <option value="">-</option>
            {AGE_GROUPS.map(ag => (
              <option value={ag}>{ag}</option>
            ))}
          </select>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="card-header">
        <h3 class="card-title">Contact Information</h3>
      </div>

      <div class="form-group">
        <label class="form-label" for="email">Email</label>
        <input type="email" name="email" id="email" class="form-input" />
      </div>

      <div class="form-row">
        <div class="form-group">
          <label class="form-label" for="telephone_1">Telephone 1</label>
          <input type="tel" name="telephone_1" id="telephone_1" class="form-input" />
        </div>
        <div class="form-group">
          <label class="form-label" for="telephone_2">Telephone 2</label>
          <input type="tel" name="telephone_2" id="telephone_2" class="form-input" />
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label class="form-label" for="address_1">Address Line 1</label>
          <input type="text" name="address_1" id="address_1" class="form-input" />
        </div>
        <div class="form-group">
          <label class="form-label" for="address_2">Address Line 2</label>
          <input type="text" name="address_2" id="address_2" class="form-input" />
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label class="form-label" for="address_3">Town/City</label>
          <input type="text" name="address_3" id="address_3" class="form-input" />
        </div>
        <div class="form-group">
          <label class="form-label" for="address_4">County</label>
          <input type="text" name="address_4" id="address_4" class="form-input" />
        </div>
        <div class="form-group">
          <label class="form-label" for="address_5">Postcode</label>
          <input type="text" name="address_5" id="address_5" class="form-input" />
        </div>
      </div>
    </div>

    <div class="card">
      <div class="card-header">
        <h3 class="card-title">Membership</h3>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label class="form-label" for="category">Subscription Type *</label>
          <select name="category" id="category" class="form-input" required>
            <option value="">Select subscription type...</option>
            {subscriptionTypes.map(sub => (
              <option value={sub}>{sub}</option>
            ))}
          </select>
        </div>
        <div class="form-group">
          <label class="form-label" for="home_away">Home/Away</label>
          <select name="home_away" id="home_away" class="form-input">
            <option value="">-</option>
            <option value="H" selected>Home</option>
            <option value="A">Away</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label" for="home_club">Home Club</label>
          <input type="text" name="home_club" id="home_club" class="form-input" value="Alnmouth Village" />
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label class="form-label" for="date_joined">Date Joined</label>
          <input type="date" name="date_joined" id="date_joined" class="form-input" value={today} />
        </div>
        <div class="form-group">
          <label class="form-label" for="date_expires">Date Expires</label>
          <input type="date" name="date_expires" id="date_expires" class="form-input" />
        </div>
      </div>

      <div id="fee-template-section" class="form-group" style="display: none;">
        <label class="form-label" for="subscription_template">Fee Template</label>
        <select name="subscription_template" id="subscription_template" class="form-input">
          <option value="">No additional fees</option>
          {FEE_TEMPLATES.map(ft => (
            <option value={ft}>{ft}</option>
          ))}
        </select>
        <small style="color: #666; display: block; margin-top: 0.25rem;">
          For Life/Honorary/Gratis members who still owe EGU, County, or Locker fees
        </small>
      </div>
    </div>

    <div class="card">
      <div class="card-header">
        <h3 class="card-title">Golf/WHS</h3>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label class="form-label" for="handicap_index">Handicap Index</label>
          <input type="number" step="0.1" name="handicap_index" id="handicap_index" class="form-input" />
        </div>
        <div class="form-group">
          <label class="form-label" for="national_id">CDH Number</label>
          <input type="text" name="national_id" id="national_id" class="form-input" />
        </div>
        <div class="form-group">
          <label class="form-label" for="national_id_country">Country</label>
          <input type="text" name="national_id_country" id="national_id_country" class="form-input" value="England" />
        </div>
      </div>
    </div>

    <div class="card">
      <div class="card-header">
        <h3 class="card-title">Payment & Admin</h3>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label class="form-label" for="default_payment_method">Payment Method</label>
          <select name="default_payment_method" id="default_payment_method" class="form-input">
            <option value="">-</option>
            {PAYMENT_METHODS.map(pm => (
              <option value={pm}>{pm}</option>
            ))}
          </select>
        </div>
        <div class="form-group">
          <label class="form-label" for="send_invoice_by">Send Invoice By</label>
          <select name="send_invoice_by" id="send_invoice_by" class="form-input">
            <option value="Email" selected>Email</option>
            <option value="Letter">Letter</option>
          </select>
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label class="form-label" for="pin">PIN</label>
          <input type="text" name="pin" id="pin" class="form-input" />
        </div>
        <div class="form-group">
          <label class="form-label" for="locker_number">Locker Number</label>
          <input type="text" name="locker_number" id="locker_number" class="form-input" />
        </div>
      </div>

      <div class="form-group">
        <label class="form-label" for="electronic_communication_consent">Electronic Communication Consent</label>
        <select name="electronic_communication_consent" id="electronic_communication_consent" class="form-input">
          <option value="">-</option>
          <option value="Yes">Yes</option>
          <option value="No">No</option>
        </select>
      </div>
    </div>

    <div style="display: flex; gap: 1rem; justify-content: flex-end;">
      <button type="button" onclick="handleBack()" class="btn btn-secondary">Cancel</button>
      <button type="submit" class="btn btn-primary">Create Member</button>
    </div>
  </form>

  <!-- M3 Unsaved Changes Dialog -->
  <div id="unsaved-dialog" class="m3-dialog-overlay" style="display: none;">
    <div class="m3-dialog">
      <div class="m3-dialog-icon">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
          <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z" fill="currentColor"/>
        </svg>
      </div>
      <h2 class="m3-dialog-title">Unsaved changes</h2>
      <p class="m3-dialog-content">You have unsaved changes. Are you sure you want to leave this page?</p>
      <div class="m3-dialog-actions">
        <button type="button" id="dialog-cancel" class="m3-btn m3-btn-text">Stay</button>
        <button type="button" id="dialog-confirm" class="m3-btn m3-btn-filled">Leave</button>
      </div>
    </div>
  </div>

  <style>
    .m3-dialog-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.32);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      animation: fadeIn 0.15s ease-out;
    }
    .m3-dialog {
      background: #fff;
      border-radius: 28px;
      padding: 24px;
      min-width: 280px;
      max-width: 400px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.24);
      animation: scaleIn 0.15s ease-out;
    }
    .m3-dialog-icon {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      background: #fef3e0;
      color: #f59e0b;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 16px;
    }
    .m3-dialog-title {
      font-size: 1.25rem;
      font-weight: 500;
      margin: 0 0 8px 0;
      color: #1c1b1f;
    }
    .m3-dialog-content {
      font-size: 0.875rem;
      color: #49454f;
      margin: 0 0 24px 0;
      line-height: 1.5;
    }
    .m3-dialog-actions {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
    }
    .m3-btn {
      font-size: 0.875rem;
      font-weight: 500;
      padding: 10px 24px;
      border-radius: 20px;
      border: none;
      cursor: pointer;
      transition: all 0.15s ease;
    }
    .m3-btn-text {
      background: transparent;
      color: #1e5631;
    }
    .m3-btn-text:hover {
      background: rgba(30, 86, 49, 0.08);
    }
    .m3-btn-filled {
      background: #1e5631;
      color: #fff;
    }
    .m3-btn-filled:hover {
      background: #164023;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
    }
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    @keyframes scaleIn {
      from { transform: scale(0.9); opacity: 0; }
      to { transform: scale(1); opacity: 1; }
    }
  </style>

  <script is:inline define:vars={{ zeroCostSubscriptions: ZERO_COST_SUBSCRIPTIONS }}>
    const dobInput = document.getElementById('date_of_birth');
    const homeAwayInput = document.getElementById('home_away');
    const categoryInput = document.getElementById('category');
    const dateJoinedInput = document.getElementById('date_joined');
    const feeTemplateSection = document.getElementById('fee-template-section');
    const feeTemplateInput = document.getElementById('subscription_template');
    const nationalIdInput = document.getElementById('national_id');
    const lockerInput = document.getElementById('locker_number');

    // Show/hide fee template section based on subscription type
    function updateFeeTemplateVisibility() {
      const category = categoryInput.value;
      const isZeroCost = zeroCostSubscriptions.includes(category);
      feeTemplateSection.style.display = isZeroCost ? 'block' : 'none';
      if (!isZeroCost) {
        feeTemplateInput.value = '';
      }
    }

    // Auto-calculate fee template for zero-cost subscriptions
    function calculateFeeTemplate() {
      const category = categoryInput.value;
      if (!zeroCostSubscriptions.includes(category)) return;

      const hasNationalId = nationalIdInput.value.trim() !== '';
      const isHomeClub = homeAwayInput.value === 'H';
      const hasLocker = lockerInput.value.trim() !== '';

      if (hasNationalId && isHomeClub && hasLocker) {
        feeTemplateInput.value = 'England Golf and County Fees and Locker';
      } else if (hasNationalId && isHomeClub) {
        feeTemplateInput.value = 'England Golf and County Fees';
      } else if (hasLocker) {
        feeTemplateInput.value = 'Locker';
      } else {
        feeTemplateInput.value = '';
      }
    }

    function getApril1stOfCurrentYear() {
      const now = new Date();
      return new Date(now.getFullYear(), 3, 1);
    }

    function calculateAgeOnDate(dateOfBirth, asOfDate) {
      if (!dateOfBirth) return null;
      const dob = new Date(dateOfBirth);
      let age = asOfDate.getFullYear() - dob.getFullYear();
      const monthDiff = asOfDate.getMonth() - dob.getMonth();
      if (monthDiff < 0 || (monthDiff === 0 && asOfDate.getDate() < dob.getDate())) {
        age--;
      }
      return age;
    }

    function calculateYearsOfMembership(dateJoined, asOfDate) {
      if (!dateJoined) return null;
      const joined = new Date(dateJoined);
      let years = asOfDate.getFullYear() - joined.getFullYear();
      const monthDiff = asOfDate.getMonth() - joined.getMonth();
      if (monthDiff < 0 || (monthDiff === 0 && asOfDate.getDate() < joined.getDate())) {
        years--;
      }
      return Math.max(0, years);
    }

    function calculateDefaultSubscription() {
      const dob = dobInput.value;
      const homeAway = homeAwayInput.value || 'H';
      const dateJoined = dateJoinedInput.value;

      if (!dob) return;

      const april1st = getApril1stOfCurrentYear();
      const now = new Date();
      const currentYear = now.getFullYear();

      const ageOnApril1 = calculateAgeOnDate(dob, april1st);
      const yearsOfMembership = calculateYearsOfMembership(dateJoined, now);
      const yearsInYear = dateJoined ? calculateYearsOfMembership(dateJoined, new Date(currentYear, 11, 31)) : null;

      if (ageOnApril1 === null) return;

      let subscriptionType;
      const suffix = homeAway === 'A' ? ' Away' : ' Home';

      // Life: 50+ years
      if (yearsInYear !== null && yearsInYear >= 50) {
        subscriptionType = 'Life';
      }
      // Over 80
      else if (ageOnApril1 >= 80) {
        subscriptionType = 'Over 80' + suffix;
      }
      // Senior Loyalty: 65+ with 25+ years
      else if (ageOnApril1 >= 65 && yearsOfMembership !== null && yearsOfMembership >= 25) {
        subscriptionType = 'Senior Loyalty' + suffix;
      }
      // Full: 30+
      else if (ageOnApril1 >= 30) {
        subscriptionType = 'Full' + suffix;
      }
      // Under 30: 21-29
      else if (ageOnApril1 >= 21) {
        subscriptionType = 'Under 30' + suffix;
      }
      // Intermediate: 18-20
      else if (ageOnApril1 >= 18) {
        subscriptionType = 'Intermediate' + suffix;
      }
      // Junior: under 18
      else {
        subscriptionType = 'Junior' + suffix;
      }

      // Find and select the matching option
      const options = categoryInput.options;
      for (let i = 0; i < options.length; i++) {
        if (options[i].value === subscriptionType) {
          categoryInput.selectedIndex = i;
          categoryInput.style.backgroundColor = '#e8f4ea';
          setTimeout(() => {
            categoryInput.style.backgroundColor = '';
          }, 2000);
          updateFeeTemplateVisibility();
          break;
        }
      }
    }

    // Add event listeners
    dobInput.addEventListener('change', calculateDefaultSubscription);
    homeAwayInput.addEventListener('change', () => {
      calculateDefaultSubscription();
      calculateFeeTemplate();
    });
    dateJoinedInput.addEventListener('change', calculateDefaultSubscription);
    categoryInput.addEventListener('change', () => {
      updateFeeTemplateVisibility();
      calculateFeeTemplate();
    });
    nationalIdInput.addEventListener('change', calculateFeeTemplate);
    lockerInput.addEventListener('change', calculateFeeTemplate);

    // Initial state
    updateFeeTemplateVisibility();

    // Unsaved changes detection
    const form = document.querySelector('form');
    let initialFormData = null;
    let pendingNavigation = null;

    function captureInitialState() {
      if (form) {
        initialFormData = new FormData(form);
      }
    }

    function checkForChanges() {
      if (!form || !initialFormData) return false;
      const currentData = new FormData(form);

      for (const [key, value] of currentData.entries()) {
        const initial = initialFormData.get(key) || '';
        if (value !== initial) return true;
      }

      return false;
    }

    function showDialog(onConfirm) {
      const dialog = document.getElementById('unsaved-dialog');
      if (dialog) dialog.style.display = 'flex';
      pendingNavigation = onConfirm;
    }

    function hideDialog() {
      const dialog = document.getElementById('unsaved-dialog');
      if (dialog) dialog.style.display = 'none';
      pendingNavigation = null;
    }

    window.handleBack = function() {
      if (checkForChanges()) {
        showDialog(() => history.back());
      } else {
        history.back();
      }
    };

    document.getElementById('dialog-cancel')?.addEventListener('click', hideDialog);

    document.getElementById('dialog-confirm')?.addEventListener('click', () => {
      hideDialog();
      if (pendingNavigation) {
        pendingNavigation();
      }
    });

    document.addEventListener('click', (e) => {
      const link = e.target.closest('a');
      if (link && link.href && checkForChanges()) {
        e.preventDefault();
        showDialog(() => window.location.href = link.href);
      }
    });

    window.addEventListener('popstate', () => {
      if (checkForChanges()) {
        history.pushState(null, '', window.location.href);
        showDialog(() => history.back());
      }
    });

    window.addEventListener('beforeunload', (e) => {
      if (checkForChanges()) {
        e.preventDefault();
        e.returnValue = '';
      }
    });

    form?.addEventListener('submit', () => {
      initialFormData = null;
    });

    captureInitialState();
    history.pushState(null, '', window.location.href);
  </script>
</AdminLayout>
