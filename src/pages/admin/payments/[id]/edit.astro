---
import AdminLayout from '../../../../layouts/AdminLayout.astro';
import { formatDate, formatCurrency } from '../../../../lib/db';

const { id } = Astro.params;
const db = Astro.locals.runtime.env.DB;

// Get payment details with line items
const payment = await db.prepare(
  `SELECT p.*, m.first_name, m.surname, m.id as member_id,
          i.invoice_number
   FROM payments p
   JOIN members m ON p.member_id = m.id
   LEFT JOIN invoices i ON p.invoice_id = i.id
   WHERE p.id = ?`
).bind(id).first();

if (!payment) {
  return Astro.redirect('/admin/payments');
}

// Get payment line items
const lineItemsResult = await db.prepare(
  `SELECT pli.*, pi.name as item_name
   FROM payment_line_items pli
   LEFT JOIN payment_items pi ON pli.payment_item_id = pi.id
   WHERE pli.payment_id = ?
   ORDER BY pli.id`
).bind(id).all();
const lineItems = (lineItemsResult.results || []) as any[];
---

<AdminLayout title="View Payment">
  <div style="max-width: 800px; margin: 0 auto;">
    <!-- Header -->
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
      <a href="/admin/payments" class="btn btn-secondary">&larr; Back to Payments</a>
      <a href={`/admin/members/${payment.member_id}`} class="btn btn-secondary">View Member</a>
    </div>

    <!-- Payment Summary -->
    <div class="card">
      <div class="card-header">
        <h3 class="card-title">Payment Details</h3>
        <span class="badge badge-success" style="font-size: 1rem; padding: 0.5rem 1rem;">
          {formatCurrency(payment.amount as number)}
        </span>
      </div>

      <div class="form-row">
        <div>
          <label class="form-label">Member</label>
          <p style="margin: 0; font-size: 1.125rem; font-weight: 600;">
            <a href={`/admin/members/${payment.member_id}`}>{payment.first_name} {payment.surname}</a>
          </p>
        </div>
        <div>
          <label class="form-label">Payment Date</label>
          <p style="margin: 0;">{formatDate(payment.payment_date as string)}</p>
        </div>
        <div>
          <label class="form-label">Amount</label>
          <p style="margin: 0; font-weight: 600;">{formatCurrency(payment.amount as number)}</p>
        </div>
      </div>

      <div class="form-row" style="margin-top: 1rem;">
        <div>
          <label class="form-label">Payment Method</label>
          <p style="margin: 0;">{payment.payment_method || '-'}</p>
        </div>
        <div>
          <label class="form-label">Payment Type</label>
          <p style="margin: 0;">{payment.payment_type || '-'}</p>
        </div>
        <div>
          <label class="form-label">Reference</label>
          <p style="margin: 0;">{payment.reference || '-'}</p>
        </div>
      </div>

      {payment.invoice_number && (
        <div style="margin-top: 1rem;">
          <label class="form-label">Invoice</label>
          <p style="margin: 0;">
            <a href={`/admin/invoices/${payment.invoice_id}`}>{payment.invoice_number}</a>
          </p>
        </div>
      )}

      {payment.notes && (
        <div style="margin-top: 1rem; padding: 1rem; background: #f8f9fa; border-radius: 4px;">
          <label class="form-label">Notes</label>
          <p style="margin: 0;">{payment.notes}</p>
        </div>
      )}
    </div>

    <!-- Line Items -->
    {lineItems.length > 0 && (
      <div class="card">
        <div class="card-header">
          <h3 class="card-title">Line Items</h3>
        </div>
        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>Description</th>
                <th style="text-align: right;">Amount</th>
              </tr>
            </thead>
            <tbody>
              {lineItems.map((item: any) => (
                <tr>
                  <td>{item.description || item.item_name || '-'}</td>
                  <td style="text-align: right; font-weight: 500;">{formatCurrency(item.amount)}</td>
                </tr>
              ))}
            </tbody>
            <tfoot>
              <tr style="background: #f8f9fa;">
                <td style="text-align: right; font-weight: 600;">Total</td>
                <td style="text-align: right; font-weight: 600;">{formatCurrency(payment.amount as number)}</td>
              </tr>
            </tfoot>
          </table>
        </div>
      </div>
    )}

    <!-- Audit Info -->
    <div class="card">
      <div class="card-header">
        <h3 class="card-title">Audit</h3>
      </div>
      <p style="margin: 0 0 0.5rem 0; font-size: 0.875rem;">
        <strong>Recorded by:</strong> {payment.recorded_by || '-'}
      </p>
      {payment.created_at && (
        <p style="margin: 0; font-size: 0.875rem;">
          <strong>Created:</strong> {formatDate(payment.created_at as string)}
        </p>
      )}
    </div>
  </div>
</AdminLayout>
