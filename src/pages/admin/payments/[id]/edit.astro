---
import AdminLayout from '../../../../layouts/AdminLayout.astro';
import { PAYMENT_METHODS, formatDate } from '../../../../lib/db';

const { id } = Astro.params;
const db = Astro.locals.runtime.env.DB;

let error = '';
let success = '';

// Get payment details
const payment = await db.prepare(
  `SELECT p.*, m.first_name, m.surname
   FROM payments p
   JOIN members m ON p.member_id = m.id
   WHERE p.id = ?`
).bind(id).first();

if (!payment) {
  return Astro.redirect('/admin/payments');
}

if (Astro.request.method === 'POST') {
  const formData = await Astro.request.formData();
  const action = formData.get('action');

  if (action === 'delete') {
    await db.prepare('DELETE FROM payments WHERE id = ?').bind(id).run();

    await db.prepare(
      `INSERT INTO audit_log (user_email, action, entity_type, entity_id)
       VALUES (?, 'delete', 'payment', ?)`
    ).bind(Astro.locals.user?.email || 'system', id).run();

    return Astro.redirect(`/admin/members/${payment.member_id}`);
  }

  const amount = parseFloat(formData.get('amount')?.toString() || '0');
  const paymentDate = formData.get('payment_date');
  const paymentMethod = formData.get('payment_method');
  const paymentType = formData.get('payment_type');
  const reference = formData.get('reference');
  const notes = formData.get('notes');

  try {
    await db.prepare(
      `UPDATE payments SET amount = ?, payment_date = ?, payment_method = ?, payment_type = ?, reference = ?, notes = ?
       WHERE id = ?`
    ).bind(
      amount,
      paymentDate,
      paymentMethod || null,
      paymentType || null,
      reference || null,
      notes || null,
      id
    ).run();

    success = 'Payment updated successfully';

    // Refresh payment data
    const updated = await db.prepare(
      `SELECT p.*, m.first_name, m.surname
       FROM payments p
       JOIN members m ON p.member_id = m.id
       WHERE p.id = ?`
    ).bind(id).first();
    if (updated) {
      Object.assign(payment, updated);
    }
  } catch (e: any) {
    error = `Failed to update payment: ${e.message}`;
  }
}

const paymentTypes = [
  { value: 'subscription', label: 'Subscription' },
  { value: 'competition_fee', label: 'Competition Fee' },
  { value: 'bar', label: 'Bar' },
  { value: 'shop', label: 'Shop' },
  { value: 'other', label: 'Other' }
];

function formatDateForInput(dateStr: string | null): string {
  if (!dateStr) return '';
  try {
    if (dateStr.includes('/')) {
      const [day, month, year] = dateStr.split('/');
      return `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
    }
    const date = new Date(dateStr);
    return date.toISOString().split('T')[0];
  } catch {
    return '';
  }
}
---

<AdminLayout title="Edit Payment">
  <div style="display: flex; gap: 1rem; margin-bottom: 1.5rem;">
    <button type="button" onclick="handleBack()" class="btn btn-secondary">&larr; Back to Member</button>
  </div>

  {error && <div class="alert alert-error">{error}</div>}
  {success && <div class="alert alert-success">{success}</div>}

  <div class="card">
    <div class="card-header">
      <h3 class="card-title">Edit Payment for {payment.first_name} {payment.surname}</h3>
    </div>

    <form method="POST">
      <div class="form-row">
        <div class="form-group">
          <label class="form-label" for="amount">Amount (Â£) *</label>
          <input type="number" step="0.01" name="amount" id="amount" class="form-input" required
                 value={payment.amount} />
        </div>

        <div class="form-group">
          <label class="form-label" for="payment_date">Payment Date *</label>
          <input type="date" name="payment_date" id="payment_date" class="form-input" required
                 value={formatDateForInput(payment.payment_date as string)} />
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label class="form-label" for="payment_method">Payment Method</label>
          <select name="payment_method" id="payment_method" class="form-input">
            <option value="">-</option>
            {PAYMENT_METHODS.map(pm => (
              <option value={pm} selected={payment.payment_method === pm}>{pm}</option>
            ))}
          </select>
        </div>

        <div class="form-group">
          <label class="form-label" for="payment_type">Payment Type</label>
          <select name="payment_type" id="payment_type" class="form-input">
            <option value="">-</option>
            {paymentTypes.map(pt => (
              <option value={pt.value} selected={payment.payment_type === pt.value}>{pt.label}</option>
            ))}
          </select>
        </div>

        <div class="form-group">
          <label class="form-label" for="reference">Reference</label>
          <input type="text" name="reference" id="reference" class="form-input"
                 value={payment.reference || ''} />
        </div>
      </div>

      <div class="form-group">
        <label class="form-label" for="notes">Notes</label>
        <textarea name="notes" id="notes" class="form-input" rows="2">{payment.notes || ''}</textarea>
      </div>

      <div style="display: flex; gap: 1rem; justify-content: space-between;">
        <form method="POST" style="margin: 0;" id="delete-payment-form">
          <input type="hidden" name="action" value="delete" />
          <button type="submit" class="btn btn-danger">
            Delete Payment
          </button>
        </form>

        <div style="display: flex; gap: 1rem;">
          <button type="button" onclick="handleBack()" class="btn btn-secondary">Cancel</button>
          <button type="submit" class="btn btn-primary">Save Changes</button>
        </div>
      </div>
    </form>
  </div>

  <!-- M3 Unsaved Changes Dialog -->
  <div id="unsaved-dialog" class="m3-dialog-overlay" style="display: none;">
    <div class="m3-dialog">
      <div class="m3-dialog-icon">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
          <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z" fill="currentColor"/>
        </svg>
      </div>
      <h2 class="m3-dialog-title">Unsaved changes</h2>
      <p class="m3-dialog-content">You have unsaved changes. Are you sure you want to leave this page?</p>
      <div class="m3-dialog-actions">
        <button type="button" id="dialog-cancel" class="m3-btn m3-btn-text">Stay</button>
        <button type="button" id="dialog-confirm" class="m3-btn m3-btn-filled">Leave</button>
      </div>
    </div>
  </div>

  <style>
    .m3-dialog-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.32);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      animation: fadeIn 0.15s ease-out;
    }

    .m3-dialog {
      background: #fff;
      border-radius: 28px;
      padding: 24px;
      min-width: 280px;
      max-width: 400px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.24);
      animation: scaleIn 0.15s ease-out;
    }

    .m3-dialog-icon {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      background: #fef3e0;
      color: #f59e0b;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 16px;
    }

    .m3-dialog-title {
      font-size: 1.25rem;
      font-weight: 500;
      margin: 0 0 8px 0;
      color: #1c1b1f;
    }

    .m3-dialog-content {
      font-size: 0.875rem;
      color: #49454f;
      margin: 0 0 24px 0;
      line-height: 1.5;
    }

    .m3-dialog-actions {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
    }

    .m3-btn {
      font-size: 0.875rem;
      font-weight: 500;
      padding: 10px 24px;
      border-radius: 20px;
      border: none;
      cursor: pointer;
      transition: all 0.15s ease;
    }

    .m3-btn-text {
      background: transparent;
      color: #1e5631;
    }

    .m3-btn-text:hover {
      background: rgba(30, 86, 49, 0.08);
    }

    .m3-btn-filled {
      background: #1e5631;
      color: #fff;
    }

    .m3-btn-filled:hover {
      background: #164023;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    @keyframes scaleIn {
      from { transform: scale(0.9); opacity: 0; }
      to { transform: scale(1); opacity: 1; }
    }
  </style>

  <script define:vars={{ memberId: payment.member_id }}>
    const form = document.querySelector('form:not([style])');
    let initialFormData = null;
    let hasUnsavedChanges = false;
    let pendingNavigation = null;

    // Capture initial form state
    function captureInitialState() {
      if (form) {
        initialFormData = new FormData(form);
      }
    }

    // Check if form has changed
    function checkForChanges() {
      if (!form || !initialFormData) return false;

      const currentData = new FormData(form);

      for (const [key, value] of currentData.entries()) {
        if (key === 'action') continue;
        const initial = initialFormData.get(key) || '';
        if (value !== initial) return true;
      }

      for (const [key, value] of initialFormData.entries()) {
        if (key === 'action') continue;
        const current = currentData.get(key) || '';
        if (value !== current) return true;
      }

      return false;
    }

    // Show dialog
    function showDialog(onConfirm) {
      const dialog = document.getElementById('unsaved-dialog');
      dialog.style.display = 'flex';
      pendingNavigation = onConfirm;
    }

    // Hide dialog
    function hideDialog() {
      const dialog = document.getElementById('unsaved-dialog');
      dialog.style.display = 'none';
      pendingNavigation = null;
    }

    // Handle back button click
    window.handleBack = function() {
      if (checkForChanges()) {
        showDialog(() => history.back());
      } else {
        history.back();
      }
    };

    // Setup dialog buttons
    document.getElementById('dialog-cancel').addEventListener('click', hideDialog);

    document.getElementById('dialog-confirm').addEventListener('click', () => {
      hideDialog();
      if (pendingNavigation) {
        hasUnsavedChanges = false;
        pendingNavigation();
      }
    });

    // Track form changes
    if (form) {
      form.addEventListener('input', () => {
        hasUnsavedChanges = checkForChanges();
      });

      form.addEventListener('change', () => {
        hasUnsavedChanges = checkForChanges();
      });

      // Allow form submission
      form.addEventListener('submit', () => {
        hasUnsavedChanges = false;
      });
    }

    // Intercept link clicks
    document.addEventListener('click', (e) => {
      const link = e.target.closest('a');
      if (link && link.href && checkForChanges()) {
        e.preventDefault();
        showDialog(() => window.location.href = link.href);
      }
    });

    // Handle browser back/forward
    window.addEventListener('popstate', (e) => {
      if (checkForChanges()) {
        history.pushState(null, '', window.location.href);
        showDialog(() => history.back());
      }
    });

    // Handle page unload
    window.addEventListener('beforeunload', (e) => {
      if (checkForChanges()) {
        e.preventDefault();
        e.returnValue = '';
      }
    });

    // Initialize
    captureInitialState();
    history.pushState(null, '', window.location.href);

    // Delete confirmation
    document.getElementById('delete-payment-form')?.addEventListener('submit', async (e) => {
      e.preventDefault();
      const confirmed = await m3Confirm('Are you sure you want to delete this payment?', {
        title: 'Delete Payment?',
        type: 'delete',
        confirmText: 'Delete',
        cancelText: 'Cancel',
        danger: true
      });
      if (confirmed) {
        hasUnsavedChanges = false;
        e.target.submit();
      }
    });
  </script>
</AdminLayout>
