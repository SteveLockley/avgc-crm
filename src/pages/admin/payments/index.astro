---
import AdminLayout from '../../../layouts/AdminLayout.astro';
import { formatDate, formatCurrency, PAYMENT_METHODS } from '../../../lib/db';

const db = Astro.locals.runtime.env.DB;

// Check for success message
const url = Astro.url;
const paymentRecorded = url.searchParams.get('payment_recorded') === '1';
const search = url.searchParams.get('search') || '';
const method = url.searchParams.get('method') || '';
const type = url.searchParams.get('type') || '';
const dateFrom = url.searchParams.get('date_from') || '';
const dateTo = url.searchParams.get('date_to') || '';
const page = parseInt(url.searchParams.get('page') || '1');
const perPage = 25;
const offset = (page - 1) * perPage;

// Build query
let whereClause = '1=1';
const params: any[] = [];

if (search) {
  whereClause += ` AND (m.surname LIKE ? OR m.first_name LIKE ? OR i.invoice_number LIKE ?)`;
  const searchTerm = `%${search}%`;
  params.push(searchTerm, searchTerm, searchTerm);
}

if (method) {
  whereClause += ' AND p.payment_method = ?';
  params.push(method);
}

if (type) {
  whereClause += ' AND p.payment_type = ?';
  params.push(type);
}

if (dateFrom) {
  whereClause += ' AND p.payment_date >= ?';
  params.push(dateFrom);
}

if (dateTo) {
  whereClause += ' AND p.payment_date <= ?';
  params.push(dateTo);
}

// Get total count
const countResult = await db.prepare(
  `SELECT COUNT(*) as count FROM payments p
   JOIN members m ON p.member_id = m.id
   LEFT JOIN invoices i ON p.invoice_id = i.id
   WHERE ${whereClause}`
).bind(...params).first<{ count: number }>();
const totalCount = countResult?.count || 0;
const totalPages = Math.ceil(totalCount / perPage);

// Get payments with invoice info
const payments = await db.prepare(
  `SELECT p.*, m.first_name, m.surname, i.invoice_number
   FROM payments p
   JOIN members m ON p.member_id = m.id
   LEFT JOIN invoices i ON p.invoice_id = i.id
   WHERE ${whereClause}
   ORDER BY m.surname, m.first_name, p.payment_date DESC
   LIMIT ? OFFSET ?`
).bind(...params, perPage, offset).all();

// Get totals for filtered results
const totalsResult = await db.prepare(
  `SELECT SUM(p.amount) as total FROM payments p
   JOIN members m ON p.member_id = m.id
   LEFT JOIN invoices i ON p.invoice_id = i.id
   WHERE ${whereClause}`
).bind(...params).first<{ total: number }>();

const paymentTypes = ['subscription', 'competition_fee', 'bar', 'shop', 'other'];

// Calculate pagination pages
const paginationPages: number[] = [];
const maxPagesToShow = 7;
if (totalPages <= maxPagesToShow) {
  for (let i = 1; i <= totalPages; i++) paginationPages.push(i);
} else if (page <= 4) {
  for (let i = 1; i <= maxPagesToShow; i++) paginationPages.push(i);
} else if (page >= totalPages - 3) {
  for (let i = totalPages - 6; i <= totalPages; i++) paginationPages.push(i);
} else {
  for (let i = page - 3; i <= page + 3; i++) paginationPages.push(i);
}

// Build query string helper
function buildQueryString(pageNum: number): string {
  const params = new URLSearchParams();
  if (search) params.set('search', search);
  if (method) params.set('method', method);
  if (type) params.set('type', type);
  if (dateFrom) params.set('date_from', dateFrom);
  if (dateTo) params.set('date_to', dateTo);
  params.set('page', String(pageNum));
  return `?${params.toString()}`;
}
---

<AdminLayout title="Payments">
  <!-- Page Header -->
  <div class="page-header">
    <div class="header-content">
      <h1>Payments</h1>
      <p class="subtitle">Track and manage member payments</p>
    </div>
    <div class="header-actions">
      <a href="/admin/payments/new" class="btn btn-primary">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="12" y1="5" x2="12" y2="19"/>
          <line x1="5" y1="12" x2="19" y2="12"/>
        </svg>
        Record Payment
      </a>
    </div>
  </div>

  {paymentRecorded && (
    <div class="alert alert-success">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
        <polyline points="22 4 12 14.01 9 11.01"/>
      </svg>
      Payment recorded successfully
    </div>
  )}

  <!-- Filter Card -->
  <div class="filter-card">
    <form method="GET" class="filter-form">
      <div class="filter-row">
        <div class="filter-group search-group">
          <label class="filter-label">Search</label>
          <div class="search-input-wrapper">
            <svg class="search-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="11" cy="11" r="8"/>
              <line x1="21" y1="21" x2="16.65" y2="16.65"/>
            </svg>
            <input type="text" name="search" class="filter-input" placeholder="Member or invoice..." value={search} />
          </div>
        </div>

        <div class="filter-group">
          <label class="filter-label">Method</label>
          <select name="method" class="filter-select">
            <option value="">All Methods</option>
            {PAYMENT_METHODS.map(m => (
              <option value={m} selected={method === m}>{m}</option>
            ))}
          </select>
        </div>

        <div class="filter-group">
          <label class="filter-label">Type</label>
          <select name="type" class="filter-select">
            <option value="">All Types</option>
            {paymentTypes.map(t => (
              <option value={t} selected={type === t}>{t}</option>
            ))}
          </select>
        </div>

        <div class="filter-group">
          <label class="filter-label">From</label>
          <input type="date" name="date_from" class="filter-input date-input" value={dateFrom} />
        </div>

        <div class="filter-group">
          <label class="filter-label">To</label>
          <input type="date" name="date_to" class="filter-input date-input" value={dateTo} />
        </div>

        <div class="filter-actions">
          <button type="submit" class="btn btn-primary">Filter</button>
          <a href="/admin/payments" class="btn btn-secondary">Clear</a>
        </div>
      </div>
    </form>

    {(search || method || type || dateFrom || dateTo) && (
      <div class="active-filters">
        <span class="filters-label">Active filters:</span>
        {search && <span class="filter-tag">Search: {search}</span>}
        {method && <span class="filter-tag">Method: {method}</span>}
        {type && <span class="filter-tag">Type: {type}</span>}
        {dateFrom && <span class="filter-tag">From: {dateFrom}</span>}
        {dateTo && <span class="filter-tag">To: {dateTo}</span>}
      </div>
    )}
  </div>

  <!-- Summary Card -->
  {totalsResult?.total !== null && (
    <div class="summary-card">
      <div class="summary-icon">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M7 20h10M10 20V12a4 4 0 0 1 8-1M6 14h8"/>
        </svg>
      </div>
      <div class="summary-content">
        <span class="summary-label">Total for selected filters</span>
        <span class="summary-value">{formatCurrency(totalsResult?.total || 0)}</span>
      </div>
    </div>
  )}

  <!-- Payments Table Card -->
  <div class="m3-card">
    <div class="card-header">
      <div class="card-title">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <rect x="1" y="4" width="22" height="16" rx="2" ry="2"/>
          <line x1="1" y1="10" x2="23" y2="10"/>
        </svg>
        <span>Payment History</span>
      </div>
      <span class="card-badge">{totalCount} payments</span>
    </div>
    <div class="table-container">
      <table class="m3-table">
        <thead>
          <tr>
            <th>Date</th>
            <th>Member</th>
            <th>Invoice</th>
            <th>Method</th>
            <th class="text-right">Amount</th>
            <th class="actions-col"></th>
          </tr>
        </thead>
        <tbody>
          {payments.results?.map((payment) => (
            <tr>
              <td class="date-cell">{formatDate(payment.payment_date as string)}</td>
              <td class="member-cell">
                <a href={`/admin/members/${payment.member_id}`} class="member-link">
                  {payment.surname}, {payment.first_name}
                </a>
              </td>
              <td>
                {payment.invoice_id ? (
                  <a href={`/admin/invoices/${payment.invoice_id}`} class="invoice-link">
                    {payment.invoice_number}
                  </a>
                ) : (
                  <span class="reference-text">{payment.reference || '-'}</span>
                )}
              </td>
              <td>
                {payment.payment_method ? (
                  <span class="method-badge">{payment.payment_method}</span>
                ) : '-'}
              </td>
              <td class="text-right amount-cell">
                {formatCurrency(payment.amount as number)}
              </td>
              <td class="actions-col">
                <a href={`/admin/payments/${payment.id}/edit`} class="action-btn" title="View">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                    <circle cx="12" cy="12" r="3"/>
                  </svg>
                </a>
              </td>
            </tr>
          ))}
          {(!payments.results || payments.results.length === 0) && (
            <tr>
              <td colspan="6" class="empty-row">
                <div class="empty-state">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <rect x="1" y="4" width="22" height="16" rx="2" ry="2"/>
                    <line x1="1" y1="10" x2="23" y2="10"/>
                  </svg>
                  <p>No payments found</p>
                </div>
              </td>
            </tr>
          )}
        </tbody>
      </table>
    </div>

    <!-- Pagination -->
    {totalPages > 1 && (
      <div class="pagination">
        {page > 1 && (
          <a href={buildQueryString(page - 1)} class="page-btn">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="15 18 9 12 15 6"/>
            </svg>
            Previous
          </a>
        )}

        <div class="page-numbers">
          {paginationPages.map((p) => (
            <a
              href={buildQueryString(p)}
              class={`page-num ${p === page ? 'active' : ''}`}
            >
              {p}
            </a>
          ))}
        </div>

        {page < totalPages && (
          <a href={buildQueryString(page + 1)} class="page-btn">
            Next
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="9 18 15 12 9 6"/>
            </svg>
          </a>
        )}
      </div>
    )}
  </div>


  <style>
    /* Page Header */
    .page-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 2rem;
      flex-wrap: wrap;
      gap: 1rem;
    }

    .header-content h1 {
      margin: 0;
      font-size: 1.75rem;
      font-weight: 600;
      color: #1a1a1a;
    }

    .subtitle {
      margin: 0.25rem 0 0 0;
      color: #666;
      font-size: 0.95rem;
    }

    .header-actions {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
    }

    .header-actions .btn {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
    }

    .header-actions .btn svg {
      width: 18px;
      height: 18px;
    }

    /* Alert */
    .alert {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 1rem 1.25rem;
      border-radius: 12px;
      margin-bottom: 1.5rem;
    }

    .alert svg {
      width: 20px;
      height: 20px;
      flex-shrink: 0;
    }

    .alert-success {
      background: #e8f5e9;
      color: #1e5631;
      border: 1px solid #c8e6c9;
    }

    /* Filter Card */
    .filter-card {
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
      border: 1px solid #e8e8e8;
      padding: 1.25rem;
      margin-bottom: 1.5rem;
    }

    .filter-form {
      width: 100%;
    }

    .filter-row {
      display: flex;
      gap: 1rem;
      align-items: flex-end;
      flex-wrap: wrap;
    }

    .filter-group {
      display: flex;
      flex-direction: column;
      gap: 0.375rem;
    }

    .search-group {
      flex: 1;
      min-width: 180px;
    }

    .filter-label {
      font-size: 0.8rem;
      font-weight: 500;
      color: #666;
      text-transform: uppercase;
      letter-spacing: 0.3px;
    }

    .search-input-wrapper {
      position: relative;
      display: flex;
      align-items: center;
    }

    .search-icon {
      position: absolute;
      left: 0.875rem;
      width: 18px;
      height: 18px;
      color: #888;
      pointer-events: none;
    }

    .filter-input {
      width: 100%;
      padding: 0.625rem 0.875rem 0.625rem 2.5rem;
      border: 1px solid #ddd;
      border-radius: 10px;
      font-size: 0.9rem;
      transition: all 0.2s ease;
    }

    .filter-input.date-input {
      padding-left: 0.875rem;
      width: 150px;
    }

    .filter-input:focus {
      outline: none;
      border-color: #1e5631;
      box-shadow: 0 0 0 3px rgba(30, 86, 49, 0.1);
    }

    .filter-select {
      padding: 0.625rem 2rem 0.625rem 0.875rem;
      border: 1px solid #ddd;
      border-radius: 10px;
      font-size: 0.9rem;
      background: #fff url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%23666' stroke-width='2'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E") no-repeat right 0.75rem center;
      appearance: none;
      cursor: pointer;
      min-width: 140px;
      transition: all 0.2s ease;
    }

    .filter-select:focus {
      outline: none;
      border-color: #1e5631;
      box-shadow: 0 0 0 3px rgba(30, 86, 49, 0.1);
    }

    .filter-actions {
      display: flex;
      gap: 0.5rem;
    }

    /* Active Filters */
    .active-filters {
      display: flex;
      align-items: center;
      gap: 0.625rem;
      margin-top: 1rem;
      padding-top: 1rem;
      border-top: 1px solid #f0f0f0;
      flex-wrap: wrap;
    }

    .filters-label {
      font-size: 0.85rem;
      color: #666;
      font-weight: 500;
    }

    .filter-tag {
      background: #1e5631;
      color: #fff;
      padding: 0.25rem 0.75rem;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 500;
    }

    /* Summary Card */
    .summary-card {
      background: linear-gradient(135deg, #1e5631 0%, #2d7a45 100%);
      border-radius: 16px;
      padding: 1.25rem;
      margin-bottom: 1.5rem;
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .summary-icon {
      width: 48px;
      height: 48px;
      border-radius: 12px;
      background: rgba(255,255,255,0.2);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .summary-icon svg {
      width: 24px;
      height: 24px;
      color: #fff;
    }

    .summary-content {
      display: flex;
      flex-direction: column;
    }

    .summary-label {
      font-size: 0.85rem;
      color: rgba(255,255,255,0.8);
    }

    .summary-value {
      font-size: 1.5rem;
      font-weight: 700;
      color: #fff;
    }

    /* M3 Card */
    .m3-card {
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
      border: 1px solid #e8e8e8;
      overflow: hidden;
      margin-bottom: 1.5rem;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem 1.25rem;
      border-bottom: 1px solid #f0f0f0;
      background: #fafafa;
    }

    .card-title {
      display: flex;
      align-items: center;
      gap: 0.625rem;
      font-weight: 600;
      color: #1a1a1a;
      font-size: 1rem;
    }

    .card-title svg {
      width: 20px;
      height: 20px;
      color: #1e5631;
    }

    .card-badge {
      font-size: 0.75rem;
      padding: 0.25rem 0.625rem;
      background: #e8f5e9;
      color: #1e5631;
      border-radius: 20px;
      font-weight: 500;
    }

    .card-content {
      padding: 0;
    }

    .table-container {
      overflow-x: auto;
    }

    /* M3 Table */
    .m3-table {
      width: 100%;
      border-collapse: collapse;
    }

    .m3-table th {
      text-align: left;
      padding: 1rem;
      font-weight: 600;
      font-size: 0.8rem;
      color: #666;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      background: #fafafa;
      border-bottom: 2px solid #e8e8e8;
      white-space: nowrap;
    }

    .m3-table td {
      padding: 0.875rem 1rem;
      font-size: 0.9rem;
      color: #333;
      border-bottom: 1px solid #f0f0f0;
      vertical-align: middle;
    }

    .m3-table tbody tr:hover {
      background: #f8faf8;
    }

    .text-right {
      text-align: right;
    }

    .date-cell {
      white-space: nowrap;
      color: #666;
    }

    .member-link {
      color: #1e5631;
      text-decoration: none;
      font-weight: 500;
    }

    .member-link:hover {
      text-decoration: underline;
    }

    .invoice-link {
      color: #1e5631;
      text-decoration: none;
      font-weight: 600;
      font-family: monospace;
      font-size: 0.85rem;
    }

    .invoice-link:hover {
      text-decoration: underline;
    }

    .reference-text {
      color: #999;
      font-size: 0.85rem;
    }

    .method-badge {
      display: inline-block;
      padding: 0.25rem 0.625rem;
      background: #f0f0f0;
      border-radius: 20px;
      font-size: 0.8rem;
      color: #555;
    }

    .amount-cell {
      font-weight: 600;
      color: #1a1a1a;
      font-size: 0.95rem;
    }

    /* Actions */
    .actions-col {
      width: 60px;
      text-align: right;
    }

    .action-btn {
      width: 32px;
      height: 32px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      border-radius: 8px;
      background: #f4f4f4;
      border: none;
      cursor: pointer;
      transition: all 0.2s ease;
      text-decoration: none;
      color: #555;
    }

    .action-btn:hover {
      background: #e8e8e8;
      color: #1e5631;
    }

    .action-btn svg {
      width: 16px;
      height: 16px;
    }

    /* Empty State */
    .empty-row {
      padding: 3rem !important;
    }

    .empty-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.75rem;
      color: #888;
    }

    .empty-state svg {
      width: 48px;
      height: 48px;
      opacity: 0.5;
    }

    .empty-state p {
      margin: 0;
      font-size: 0.95rem;
    }

    /* Pagination */
    .pagination {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      padding: 1rem;
      border-top: 1px solid #f0f0f0;
      background: #fafafa;
    }

    .page-btn {
      display: flex;
      align-items: center;
      gap: 0.375rem;
      padding: 0.5rem 0.875rem;
      border-radius: 8px;
      background: #fff;
      border: 1px solid #ddd;
      color: #333;
      text-decoration: none;
      font-size: 0.875rem;
      font-weight: 500;
      transition: all 0.2s ease;
    }

    .page-btn:hover {
      background: #f4f4f4;
      border-color: #ccc;
    }

    .page-btn svg {
      width: 16px;
      height: 16px;
    }

    .page-numbers {
      display: flex;
      gap: 0.25rem;
    }

    .page-num {
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 8px;
      background: #fff;
      border: 1px solid #ddd;
      color: #333;
      text-decoration: none;
      font-size: 0.875rem;
      font-weight: 500;
      transition: all 0.2s ease;
    }

    .page-num:hover {
      background: #f4f4f4;
      border-color: #ccc;
    }

    .page-num.active {
      background: #1e5631;
      border-color: #1e5631;
      color: #fff;
    }

    /* Responsive */
    @media (max-width: 900px) {
      .filter-row {
        flex-direction: column;
        align-items: stretch;
      }

      .filter-group {
        width: 100%;
      }

      .search-group {
        min-width: auto;
      }

      .filter-select,
      .filter-input.date-input {
        width: 100%;
      }

      .filter-actions {
        justify-content: flex-end;
      }
    }

    @media (max-width: 600px) {
      .page-header {
        flex-direction: column;
        align-items: flex-start;
      }

      .header-actions {
        width: 100%;
        justify-content: flex-start;
      }

      .page-numbers {
        display: none;
      }
    }
  </style>
</AdminLayout>
