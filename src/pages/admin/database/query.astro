---
import AdminLayout from '../../../layouts/AdminLayout.astro';

const db = Astro.locals.runtime.env.DB;

let query = '';
let results: any = null;
let error = '';
let executionTime = 0;
let affectedRows = 0;
let isSelect = false;

// Handle form submission
if (Astro.request.method === 'POST') {
  const formData = await Astro.request.formData();
  query = (formData.get('query') as string) || '';

  if (query.trim()) {
    const startTime = Date.now();

    try {
      // Determine if it's a SELECT query
      isSelect = query.trim().toUpperCase().startsWith('SELECT') ||
                 query.trim().toUpperCase().startsWith('PRAGMA') ||
                 query.trim().toUpperCase().startsWith('EXPLAIN');

      if (isSelect) {
        const result = await db.prepare(query).all();
        results = result.results || [];
        executionTime = Date.now() - startTime;
      } else {
        const result = await db.prepare(query).run();
        affectedRows = result.meta?.changes || 0;
        executionTime = Date.now() - startTime;
      }
    } catch (e: any) {
      error = e.message || 'Query execution failed';
      executionTime = Date.now() - startTime;
    }
  }
}

// Get tables for quick reference
const tablesResult = await db.prepare(
  `SELECT name FROM sqlite_master WHERE type='table' AND name NOT LIKE 'sqlite_%' AND name NOT LIKE '_cf_%' ORDER BY name`
).all();
const tables = tablesResult.results || [];

// Example queries
const exampleQueries = [
  { label: 'Show all tables', query: `SELECT name FROM sqlite_master WHERE type='table' AND name NOT LIKE 'sqlite_%' ORDER BY name` },
  { label: 'Count members', query: `SELECT COUNT(*) as total FROM members` },
  { label: 'Members by category', query: `SELECT category, COUNT(*) as count FROM members GROUP BY category ORDER BY count DESC` },
  { label: 'Recent payments', query: `SELECT p.*, m.first_name, m.surname FROM payments p JOIN members m ON p.member_id = m.id ORDER BY p.payment_date DESC LIMIT 10` },
  { label: 'Expiring memberships', query: `SELECT first_name, surname, email, date_expires FROM members WHERE date_expires BETWEEN date('now') AND date('now', '+30 days') ORDER BY date_expires` },
];
---

<AdminLayout title="SQL Query">
  <div class="card">
    <div class="card-header">
      <h3 class="card-title">
        <a href="/admin/database" style="color: #666; text-decoration: none;">&larr; Database</a>
        &nbsp;/&nbsp; SQL Query
      </h3>
    </div>

    <form method="POST">
      <div class="form-group">
        <label class="form-label">SQL Query</label>
        <textarea
          name="query"
          class="form-input"
          rows="6"
          style="font-family: monospace; font-size: 0.875rem;"
          placeholder="Enter your SQL query here..."
        >{query}</textarea>
      </div>

      <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem;">
        <button type="submit" class="btn btn-primary">Execute Query</button>
        <button type="button" class="btn btn-secondary" onclick="document.querySelector('textarea').value = ''">Clear</button>
      </div>
    </form>

    <!-- Quick queries -->
    <div style="margin-bottom: 1.5rem;">
      <div style="font-size: 0.875rem; color: #666; margin-bottom: 0.5rem;">Quick queries:</div>
      <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
        {exampleQueries.map((eq) => (
          <button
            type="button"
            class="btn btn-secondary btn-sm"
            onclick={`document.querySelector('textarea[name="query"]').value = ${JSON.stringify(eq.query)}`}
          >
            {eq.label}
          </button>
        ))}
      </div>
    </div>

    <!-- Tables reference -->
    <div style="margin-bottom: 1.5rem;">
      <div style="font-size: 0.875rem; color: #666; margin-bottom: 0.5rem;">Tables:</div>
      <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
        {tables.map((t: any) => (
          <a
            href={`/admin/database/table/${t.name}`}
            class="btn btn-secondary btn-sm"
            style="font-family: monospace;"
          >
            {t.name}
          </a>
        ))}
      </div>
    </div>

    {error && (
      <div style="background: #f8d7da; color: #721c24; padding: 1rem; border-radius: 4px; margin-bottom: 1rem;">
        <strong>Error:</strong> {error}
        <div style="font-size: 0.875rem; margin-top: 0.5rem; color: #666;">
          Execution time: {executionTime}ms
        </div>
      </div>
    )}

    {results !== null && isSelect && (
      <div>
        <div style="background: #d4edda; color: #155724; padding: 0.75rem; border-radius: 4px; margin-bottom: 1rem;">
          <strong>{results.length} row{results.length !== 1 ? 's' : ''}</strong> returned in {executionTime}ms
        </div>

        {results.length > 0 && (
          <div class="table-container" style="overflow-x: auto;">
            <table style="font-size: 0.875rem;">
              <thead>
                <tr>
                  {Object.keys(results[0]).map((col) => (
                    <th>{col}</th>
                  ))}
                </tr>
              </thead>
              <tbody>
                {results.map((row: any) => (
                  <tr>
                    {Object.values(row).map((val: any) => (
                      <td style="max-width: 300px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title={String(val ?? '')}>
                        {val === null ? (
                          <span style="color: #999; font-style: italic;">NULL</span>
                        ) : String(val).length > 100 ? (
                          String(val).substring(0, 100) + '...'
                        ) : (
                          String(val)
                        )}
                      </td>
                    ))}
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        )}
      </div>
    )}

    {results === null && !isSelect && !error && affectedRows >= 0 && query && (
      <div style="background: #d4edda; color: #155724; padding: 0.75rem; border-radius: 4px;">
        <strong>Query executed successfully.</strong> {affectedRows} row{affectedRows !== 1 ? 's' : ''} affected in {executionTime}ms
      </div>
    )}
  </div>

  <!-- SQL Tips -->
  <div class="card" style="margin-top: 1rem;">
    <h4 style="margin-bottom: 0.5rem;">SQLite Quick Reference</h4>
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1rem; font-size: 0.875rem;">
      <div>
        <strong>Select</strong>
        <pre style="background: #f8f9fa; padding: 0.5rem; border-radius: 4px; margin: 0.25rem 0;">SELECT * FROM table WHERE column = 'value'</pre>
      </div>
      <div>
        <strong>Insert</strong>
        <pre style="background: #f8f9fa; padding: 0.5rem; border-radius: 4px; margin: 0.25rem 0;">INSERT INTO table (col1, col2) VALUES ('a', 'b')</pre>
      </div>
      <div>
        <strong>Update</strong>
        <pre style="background: #f8f9fa; padding: 0.5rem; border-radius: 4px; margin: 0.25rem 0;">UPDATE table SET column = 'value' WHERE id = 1</pre>
      </div>
      <div>
        <strong>Delete</strong>
        <pre style="background: #f8f9fa; padding: 0.5rem; border-radius: 4px; margin: 0.25rem 0;">DELETE FROM table WHERE id = 1</pre>
      </div>
    </div>
  </div>
</AdminLayout>
