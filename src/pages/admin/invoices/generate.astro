---
import AdminLayout from '../../../layouts/AdminLayout.astro';
import { formatCurrency, EGU_CATEGORIES, getRenewalPeriod, generateInvoiceNumber, calculateEguCategory, type Member, type PaymentItem } from '../../../lib/db';
import { calculateInvoiceForMember, isMemberEligibleForInvoice, getFeeSummary } from '../../../lib/invoice';

const db = Astro.locals.runtime.env.DB;
const user = Astro.locals.user;

// Get renewal period
const period = getRenewalPeriod();

let error = '';
let success = '';
let selectedMembers: Member[] = [];
let invoicesGenerated = 0;

// Handle form submission
if (Astro.request.method === 'POST') {
  const formData = await Astro.request.formData();
  const action = formData.get('action');

  if (action === 'search') {
    // Search for members based on selection criteria
    const selectionMode = formData.get('selection_mode');
    const searchTerm = formData.get('search_term');
    const subscriptionTemplate = formData.get('subscription_template');
    const category = formData.get('category');
    const memberIds = formData.get('member_ids');

    let whereClause = '1=1';
    const params: any[] = [];

    // Filter by selection mode
    if (selectionMode === 'individual' && memberIds) {
      const ids = String(memberIds).split(',').map(id => parseInt(id.trim())).filter(id => !isNaN(id));
      if (ids.length > 0) {
        whereClause += ` AND id IN (${ids.map(() => '?').join(',')})`;
        params.push(...ids);
      }
    } else if (selectionMode === 'search' && searchTerm) {
      whereClause += ` AND (surname LIKE ? OR first_name LIKE ? OR email LIKE ?)`;
      const term = `%${searchTerm}%`;
      params.push(term, term, term);
    } else if (selectionMode === 'subscription' && subscriptionTemplate) {
      whereClause += ` AND subscription_template = ?`;
      params.push(subscriptionTemplate);
    } else if (selectionMode === 'egu_category' && category) {
      // EGU category is calculated, so we fetch all and filter later
      whereClause += ` AND subscription_template IS NOT NULL AND subscription_template != ''`;
    } else if (selectionMode === 'all') {
      // All renewable members with valid email and subscription
      whereClause += ` AND subscription_template IS NOT NULL AND subscription_template != ''`;
      whereClause += ` AND email IS NOT NULL AND email != ''`;
    }

    // Exclude members who already have an invoice for this period
    whereClause += ` AND id NOT IN (
      SELECT member_id FROM invoices
      WHERE period_start = ? AND period_end = ? AND status != 'cancelled'
    )`;
    params.push(period.start, period.end);

    // Get matching members
    const result = await db.prepare(
      `SELECT * FROM members WHERE ${whereClause} ORDER BY surname, first_name LIMIT 500`
    ).bind(...params).all();

    let members = (result.results || []) as Member[];

    // Filter by EGU category if selected (calculated field)
    if (selectionMode === 'egu_category' && category) {
      members = members.filter(m => calculateEguCategory(m) === category);
    }

    selectedMembers = members.slice(0, 200);

  } else if (action === 'generate') {
    // Generate invoices for selected members
    const memberIdsRaw = formData.get('selected_member_ids');
    const customMessage = formData.get('custom_message');

    if (!memberIdsRaw) {
      error = 'No members selected';
    } else {
      const memberIds = String(memberIdsRaw).split(',').map(id => parseInt(id.trim())).filter(id => !isNaN(id));

      if (memberIds.length === 0) {
        error = 'No valid member IDs provided';
      } else {
        // Get payment items
        const paymentItemsResult = await db.prepare(
          `SELECT * FROM payment_items WHERE active = 1`
        ).all();
        const paymentItems = (paymentItemsResult.results || []) as PaymentItem[];

        // Get members
        const membersResult = await db.prepare(
          `SELECT * FROM members WHERE id IN (${memberIds.map(() => '?').join(',')})`
        ).bind(...memberIds).all();
        const members = (membersResult.results || []) as Member[];

        // Generate invoices
        for (const member of members) {
          const eligibility = isMemberEligibleForInvoice(member);
          if (!eligibility.eligible) {
            continue;
          }

          const calculation = calculateInvoiceForMember(member, paymentItems, period.start, period.end);
          if (!calculation || calculation.items.length === 0) {
            continue;
          }

          // Get next sequence number for this member/year
          const seqResult = await db.prepare(
            `SELECT COUNT(*) as count FROM invoices
             WHERE member_id = ? AND invoice_number LIKE ?`
          ).bind(member.id, `${period.year}/%`).first<{ count: number }>();
          const sequence = (seqResult?.count || 0) + 1;

          // Generate invoice number
          const invoiceNumber = generateInvoiceNumber(period.year, member.pin || String(member.id), sequence);

          // Create invoice
          const invoiceResult = await db.prepare(
            `INSERT INTO invoices (
              invoice_number, member_id, invoice_date, period_start, period_end,
              subtotal, total, status, custom_message, created_by
            ) VALUES (?, ?, date('now'), ?, ?, ?, ?, 'draft', ?, ?)`
          ).bind(
            invoiceNumber,
            member.id,
            period.start,
            period.end,
            calculation.subtotal,
            calculation.total,
            customMessage || null,
            user?.email || null
          ).run();

          const invoiceId = invoiceResult.meta.last_row_id;

          // Create invoice items
          for (const item of calculation.items) {
            await db.prepare(
              `INSERT INTO invoice_items (
                invoice_id, payment_item_id, description, quantity, unit_price, line_total
              ) VALUES (?, ?, ?, ?, ?, ?)`
            ).bind(
              invoiceId,
              item.paymentItemId,
              item.description,
              item.quantity,
              item.unitPrice,
              item.lineTotal
            ).run();
          }

          invoicesGenerated++;
        }

        if (invoicesGenerated > 0) {
          success = `Successfully generated ${invoicesGenerated} invoice(s)`;

          // Log to audit
          await db.prepare(
            `INSERT INTO audit_log (user_email, action, entity_type, details)
             VALUES (?, 'generate_invoices', 'invoices', ?)`
          ).bind(
            user?.email || 'system',
            JSON.stringify({ count: invoicesGenerated, period: `${period.start} to ${period.end}` })
          ).run();
        } else {
          error = 'No invoices could be generated. Members may already have invoices for this period or lack subscription templates.';
        }
      }
    }
  }
}

// Get payment items for fee preview
const paymentItemsResult = await db.prepare(
  `SELECT * FROM payment_items WHERE active = 1 ORDER BY category, name`
).all();
const paymentItems = (paymentItemsResult.results || []) as PaymentItem[];

// Get subscription types from payment items
const subscriptionTypes = paymentItems
  .filter(item => item.category === 'Subscription')
  .map(item => item.name);

// Get counts for quick selection
const memberCounts = await db.prepare(
  `SELECT subscription_template, COUNT(*) as count
   FROM members
   WHERE subscription_template IS NOT NULL
   GROUP BY subscription_template`
).all();

const countByTemplate: Record<string, number> = {};
memberCounts.results?.forEach((row: any) => {
  countByTemplate[row.subscription_template] = row.count;
});

// Get all members for EGU category counts
const allMembersResult = await db.prepare(
  `SELECT gender, date_of_birth, home_away, home_club FROM members
   WHERE subscription_template IS NOT NULL AND subscription_template != ''`
).all();
const allMembers = (allMembersResult.results || []) as Pick<Member, 'gender' | 'date_of_birth' | 'home_away' | 'home_club'>[];

// Calculate EGU category counts
const countByEguCategory: Record<string, number> = {};
allMembers.forEach(member => {
  const eguCat = calculateEguCategory(member);
  if (eguCat) {
    countByEguCategory[eguCat] = (countByEguCategory[eguCat] || 0) + 1;
  }
});
---

<AdminLayout title="Generate Invoices">
  {error && (
    <div class="alert alert-error">{error}</div>
  )}

  {success && (
    <div class="alert alert-success">
      {success}
      <a href="/admin/invoices?status=draft" style="margin-left: 1rem;">View Draft Invoices</a>
    </div>
  )}

  <div class="card">
    <div class="card-header">
      <h3 class="card-title">Invoice Period</h3>
    </div>
    <div style="background: #f8f9fa; padding: 1rem; border-radius: 4px;">
      <p style="margin: 0; font-size: 1.125rem;">
        <strong>Membership Year:</strong> 1st April {period.year} - 31st March {period.year + 1}
      </p>
      <p style="margin: 0.5rem 0 0 0; color: #666; font-size: 0.875rem;">
        Invoices will be generated for this renewal period.
      </p>
    </div>
  </div>

  <!-- Step 1: Select Members -->
  <div class="card">
    <div class="card-header">
      <h3 class="card-title">Step 1: Select Members</h3>
    </div>

    <form method="POST">
      <input type="hidden" name="action" value="search" />

      <div class="form-group">
        <label class="form-label">Selection Mode</label>
        <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
          <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
            <input type="radio" name="selection_mode" value="subscription" checked />
            By Subscription Type
          </label>
          <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
            <input type="radio" name="selection_mode" value="egu_category" />
            By EGU Category
          </label>
          <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
            <input type="radio" name="selection_mode" value="search" />
            Search by Name
          </label>
          <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
            <input type="radio" name="selection_mode" value="individual" />
            Specific Member IDs
          </label>
          <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
            <input type="radio" name="selection_mode" value="all" />
            All Renewable
          </label>
        </div>
      </div>

      <div class="form-row">
        <div class="form-group" id="subscription-select">
          <label class="form-label">Subscription Type</label>
          <select name="subscription_template" class="form-input">
            <option value="">Select...</option>
            {subscriptionTypes.map(t => (
              <option value={t}>{t} ({countByTemplate[t] || 0} members)</option>
            ))}
          </select>
        </div>

        <div class="form-group" id="category-select" style="display: none;">
          <label class="form-label">EGU Category</label>
          <select name="category" class="form-input">
            <option value="">Select...</option>
            {EGU_CATEGORIES.map(c => (
              <option value={c}>{c} ({countByEguCategory[c] || 0} members)</option>
            ))}
          </select>
        </div>

        <div class="form-group" id="search-input" style="display: none;">
          <label class="form-label">Search Term</label>
          <input type="text" name="search_term" class="form-input" placeholder="Name or email..." />
        </div>

        <div class="form-group" id="ids-input" style="display: none;">
          <label class="form-label">Member IDs (comma separated)</label>
          <input type="text" name="member_ids" class="form-input" placeholder="1, 2, 3..." />
        </div>
      </div>

      <button type="submit" class="btn btn-primary">Find Members</button>
    </form>
  </div>

  <!-- Step 2: Preview & Customize -->
  {selectedMembers.length > 0 && (
    <div class="card">
      <div class="card-header">
        <h3 class="card-title">Step 2: Review Selected Members ({selectedMembers.length})</h3>
      </div>

      <form method="POST" id="generate-form">
        <input type="hidden" name="action" value="generate" />
        <input type="hidden" name="selected_member_ids" id="selected-member-ids" value="" />

        <div class="form-group">
          <label class="form-label">Custom Message (optional)</label>
          <textarea
            name="custom_message"
            class="form-input"
            rows="3"
            placeholder="Add a personal message to include in all invoices..."
          ></textarea>
        </div>

        <div class="table-container" style="max-height: 400px; overflow-y: auto;">
          <table>
            <thead style="position: sticky; top: 0; background: white;">
              <tr>
                <th style="width: 40px;">
                  <input type="checkbox" id="select-all" checked />
                </th>
                <th>Member</th>
                <th>Email</th>
                <th>Subscription</th>
                <th>Fees</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody>
              {selectedMembers.map((member) => {
                const eligibility = isMemberEligibleForInvoice(member);
                const fees = getFeeSummary(member);
                const calculation = calculateInvoiceForMember(member, paymentItems, period.start, period.end);

                return (
                  <tr class={!eligibility.eligible ? 'ineligible' : ''}>
                    <td>
                      <input
                        type="checkbox"
                        class="member-checkbox"
                        value={member.id}
                        checked={eligibility.eligible}
                        disabled={!eligibility.eligible}
                      />
                    </td>
                    <td>
                      <a href={`/admin/members/${member.id}`} target="_blank">
                        {member.surname}, {member.first_name}
                      </a>
                      <br>
                      <small style="color: #666;">M{member.pin?.padStart(4, '0')}</small>
                    </td>
                    <td style="font-size: 0.875rem;">{member.email || '-'}</td>
                    <td style="font-size: 0.875rem;">{member.subscription_template || '-'}</td>
                    <td style="font-size: 0.875rem;">
                      {fees.length > 0 ? fees.join(', ') : 'Subscription only'}
                    </td>
                    <td>
                      {eligibility.eligible ? (
                        <span class="badge badge-success">
                          {calculation ? formatCurrency(calculation.total) : 'Ready'}
                        </span>
                      ) : (
                        <span class="badge badge-danger" title={eligibility.reason}>
                          {eligibility.reason}
                        </span>
                      )}
                    </td>
                  </tr>
                );
              })}
            </tbody>
          </table>
        </div>

        <div style="margin-top: 1rem; display: flex; gap: 1rem; align-items: center;">
          <button type="submit" class="btn btn-primary" id="generate-btn">
            Generate Invoices
          </button>
          <span id="selected-count" style="color: #666;">
            {selectedMembers.filter(m => isMemberEligibleForInvoice(m).eligible).length} members selected
          </span>
        </div>
      </form>
    </div>
  )}

  <!-- Fee Reference -->
  <div class="card">
    <div class="card-header">
      <h3 class="card-title">Fee Reference</h3>
    </div>
    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>Category</th>
            <th>Name</th>
            <th style="text-align: right;">Amount</th>
            <th>Description</th>
          </tr>
        </thead>
        <tbody>
          {paymentItems.map((item) => (
            <tr>
              <td>
                <span class={`badge ${item.category === 'Subscription' ? 'badge-info' : 'badge-warning'}`}>
                  {item.category}
                </span>
              </td>
              <td>{item.name}</td>
              <td style="text-align: right; font-weight: 500;">
                {formatCurrency(item.fee)}
              </td>
              <td style="font-size: 0.875rem; color: #666;">{item.description || '-'}</td>
            </tr>
          ))}
        </tbody>
      </table>
    </div>
    <p style="margin: 1rem 0 0 0; font-size: 0.875rem; color: #666;">
      <a href="/admin/invoices/settings">Manage payment items and fees</a>
    </p>
  </div>
</AdminLayout>

<style>
  .ineligible {
    opacity: 0.6;
    background: #f8f8f8;
  }
</style>

<script>
  // Handle selection mode changes
  document.querySelectorAll('input[name="selection_mode"]').forEach(radio => {
    radio.addEventListener('change', (e) => {
      const mode = (e.target as HTMLInputElement).value;

      document.getElementById('subscription-select')!.style.display = mode === 'subscription' ? 'block' : 'none';
      document.getElementById('category-select')!.style.display = mode === 'egu_category' ? 'block' : 'none';
      document.getElementById('search-input')!.style.display = mode === 'search' ? 'block' : 'none';
      document.getElementById('ids-input')!.style.display = mode === 'individual' ? 'block' : 'none';
    });
  });

  // Handle select all checkbox
  const selectAll = document.getElementById('select-all') as HTMLInputElement;
  const checkboxes = document.querySelectorAll('.member-checkbox:not(:disabled)') as NodeListOf<HTMLInputElement>;
  const selectedCount = document.getElementById('selected-count');
  const selectedIdsInput = document.getElementById('selected-member-ids') as HTMLInputElement;

  function updateSelectedCount() {
    const selected = document.querySelectorAll('.member-checkbox:checked') as NodeListOf<HTMLInputElement>;
    if (selectedCount) {
      selectedCount.textContent = `${selected.length} members selected`;
    }
    if (selectedIdsInput) {
      selectedIdsInput.value = Array.from(selected).map(cb => cb.value).join(',');
    }
  }

  if (selectAll) {
    selectAll.addEventListener('change', () => {
      checkboxes.forEach(cb => cb.checked = selectAll.checked);
      updateSelectedCount();
    });
  }

  checkboxes.forEach(cb => {
    cb.addEventListener('change', updateSelectedCount);
  });

  // Initial count update
  updateSelectedCount();

  // Form validation
  const generateForm = document.getElementById('generate-form');
  if (generateForm) {
    generateForm.addEventListener('submit', async (e) => {
      const selected = document.querySelectorAll('.member-checkbox:checked');
      if (selected.length === 0) {
        e.preventDefault();
        await m3Alert('Please select at least one member', { title: 'No Members Selected', type: 'warning' });
      }
    });
  }
</script>
