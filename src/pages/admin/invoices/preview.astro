---
import AdminLayout from '../../../layouts/AdminLayout.astro';
import { formatCurrency, getFullName, type Invoice, type InvoiceItem, type Member } from '../../../lib/db';
import { generateInvoiceEmail, generateInvoiceSubject } from '../../../lib/email-template';
import { sendEmail, isEmailConfigured, isValidEmail } from '../../../lib/email';
import { loadFeeItems, calculateLineItems } from '../../../lib/generate-invoice';

const db = Astro.locals.runtime.env.DB;
const user = Astro.locals.user;
const env = Astro.locals.runtime.env;

// Get invoice IDs from query params
const url = Astro.url;
const idsParam = url.searchParams.get('ids') || '';
const invoiceIds = idsParam.split(',').map(id => parseInt(id.trim())).filter(id => !isNaN(id));

if (invoiceIds.length === 0) {
  return Astro.redirect('/admin/invoices');
}

// Get settings
const settingsResult = await db.prepare(
  `SELECT * FROM invoice_settings`
).all();
const settings: Record<string, string> = {};
settingsResult.results?.forEach((row: any) => {
  settings[row.setting_key] = row.setting_value;
});

// Get custom message from query params (persisted across navigation)
const customMessage = url.searchParams.get('message') || '';

// Load fee items for recalculation
const feeItems = await loadFeeItems(db);

// Get invoices with member data, recalculating fees
const invoices: Array<{
  invoice: Invoice;
  member: Member;
  items: InvoiceItem[];
  emailHtml: string;
  emailSubject: string;
  revised: boolean;
}> = [];

for (const invoiceId of invoiceIds) {
  const invoice = await db.prepare(
    `SELECT * FROM invoices WHERE id = ? AND status IN ('draft', 'sent', 'paid')`
  ).bind(invoiceId).first<Invoice>();

  if (!invoice) continue;

  // Load member with subscription fee for their current category
  const member = await db.prepare(
    `SELECT m.*, p.fee as subscription_fee, p.id as subscription_item_id
     FROM members m
     LEFT JOIN payment_items p ON p.name = m.category AND p.category = 'Subscription' AND p.active = 1
     WHERE m.id = ?`
  ).bind(invoice.member_id).first<any>();

  if (!member) continue;

  // Recalculate what the line items should be based on current member data + fees
  const isSocial = (member.category || '').toLowerCase().includes('social');
  const correctItems = calculateLineItems(member, feeItems, isSocial);
  const correctTotal = correctItems.reduce((sum: number, item: any) => sum + item.unitPrice, 0);

  let revised = false;

  // If the total differs, revise the invoice
  if (Math.abs(correctTotal - (invoice.total as number)) > 0.005 && correctItems.length > 0) {
    // Adjust member account balance only for unpaid invoices (draft/sent)
    // Paid invoices already had balance settled, so don't touch it
    if (invoice.status !== 'paid') {
      const oldTotal = invoice.total as number;
      const diff = correctTotal - oldTotal;
      if (Math.abs(diff) > 0.005) {
        await db.prepare(
          `UPDATE members SET account_balance = account_balance + ? WHERE id = ?`
        ).bind(diff, member.id).run();
      }
    }

    // Delete old line items and insert new ones
    await db.prepare(`DELETE FROM invoice_items WHERE invoice_id = ?`).bind(invoiceId).run();

    for (const item of correctItems) {
      await db.prepare(
        `INSERT INTO invoice_items (invoice_id, payment_item_id, description, quantity, unit_price, line_total)
         VALUES (?, ?, ?, 1, ?, ?)`
      ).bind(invoiceId, item.paymentItemId, item.description, item.unitPrice, item.unitPrice).run();
    }

    // Update invoice totals
    await db.prepare(
      `UPDATE invoices SET subtotal = ?, total = ?, updated_at = datetime('now') WHERE id = ?`
    ).bind(correctTotal, correctTotal, invoiceId).run();

    // Update the invoice object in memory
    (invoice as any).subtotal = correctTotal;
    (invoice as any).total = correctTotal;
    revised = true;
  }

  // Load the (possibly updated) line items
  const itemsResult = await db.prepare(
    `SELECT * FROM invoice_items WHERE invoice_id = ? ORDER BY id`
  ).bind(invoiceId).all();
  const items = (itemsResult.results || []) as InvoiceItem[];

  const periodYear = parseInt(invoice.period_start.substring(0, 4));
  const emailHtml = generateInvoiceEmail({
    member,
    invoice,
    items,
    settings,
    customMessage: customMessage || undefined,
  });
  const emailSubject = generateInvoiceSubject(invoice, periodYear);

  invoices.push({ invoice, member, items, emailHtml, emailSubject, revised });
}

if (invoices.length === 0) {
  return Astro.redirect('/admin/invoices?error=no_valid_invoices');
}

// Check email configuration
const emailConfigured = isEmailConfigured(env);

let error = '';
let success = '';
let sentCount = 0;
let failedCount = 0;

// Handle form submission
if (Astro.request.method === 'POST') {
  const formData = await Astro.request.formData();
  const action = formData.get('action');

  if (action === 'send_test' || action === 'send_test_direct') {
    // Send test email to logged-in user
    const testEmail = formData.get('test_email') as string || user?.email;
    const useDirectMailbox = action === 'send_test_direct';

    if (!testEmail || !isValidEmail(testEmail)) {
      error = 'Invalid test email address';
    } else if (!emailConfigured) {
      error = 'Email is not configured. Please set up Azure AD credentials.';
    } else {
      const firstInvoice = invoices[0];
      const result = await sendEmail({
        to: testEmail,
        subject: `[TEST] ${firstInvoice.emailSubject}`,
        html: firstInvoice.emailHtml,
        useServiceAccountMailbox: useDirectMailbox,
      }, {
        AZURE_TENANT_ID: env.AZURE_TENANT_ID,
        AZURE_CLIENT_ID: env.AZURE_CLIENT_ID,
        AZURE_CLIENT_SECRET: env.AZURE_CLIENT_SECRET,
        AZURE_SERVICE_USER: env.AZURE_SERVICE_USER,
        AZURE_SERVICE_PASSWORD: env.AZURE_SERVICE_PASSWORD,
      });

      if (result.success) {
        success = useDirectMailbox
          ? `Test email sent from service account mailbox to ${testEmail}`
          : `Test email sent to ${testEmail}`;
      } else {
        error = `Failed to send test email: ${result.error}`;
      }
    }

  } else if (action === 'send_all') {
    // Send all invoices
    if (!emailConfigured) {
      error = 'Email is not configured. Please set up Azure AD credentials.';
    } else {
      for (const { invoice, member, emailHtml, emailSubject } of invoices) {
        if (!member.email || !isValidEmail(member.email)) {
          failedCount++;
          continue;
        }

        const result = await sendEmail({
          to: member.email,
          subject: emailSubject,
          html: emailHtml,
        }, {
          AZURE_TENANT_ID: env.AZURE_TENANT_ID,
          AZURE_CLIENT_ID: env.AZURE_CLIENT_ID,
          AZURE_CLIENT_SECRET: env.AZURE_CLIENT_SECRET,
          AZURE_SERVICE_USER: env.AZURE_SERVICE_USER,
          AZURE_SERVICE_PASSWORD: env.AZURE_SERVICE_PASSWORD,
        });

        const periodYear = parseInt(invoice.period_start.substring(0, 4));

        if (result.success) {
          // Update invoice status
          await db.prepare(
            `UPDATE invoices SET
              status = 'sent',
              sent_at = datetime('now'),
              sent_to_email = ?,
              updated_at = datetime('now')
            WHERE id = ?`
          ).bind(member.email, invoice.id).run();

          // Record in sent_emails
          await db.prepare(
            `INSERT INTO sent_emails (member_id, email_type, email_address, year, status) VALUES (?, 'invoice_send', ?, ?, 'sent')`
          ).bind(member.id, member.email, periodYear).run();

          sentCount++;
        } else {
          failedCount++;

          // Record failure in sent_emails
          await db.prepare(
            `INSERT INTO sent_emails (member_id, email_type, email_address, year, status, error) VALUES (?, 'invoice_send', ?, ?, 'failed', ?)`
          ).bind(member.id, member.email, periodYear, result.error || 'Unknown error').run();
        }

        // Small delay between emails
        await new Promise(resolve => setTimeout(resolve, 100));
      }

      if (sentCount > 0) {
        // Log to audit
        await db.prepare(
          `INSERT INTO audit_log (user_email, action, entity_type, details)
           VALUES (?, 'send_invoices', 'invoices', ?)`
        ).bind(
          user?.email || 'system',
          JSON.stringify({ sent: sentCount, failed: failedCount })
        ).run();

        success = `Successfully sent ${sentCount} invoice(s)`;
        if (failedCount > 0) {
          success += ` (${failedCount} failed)`;
        }
      } else {
        error = `Failed to send any invoices. ${failedCount} failed.`;
      }
    }
  }
}

// Get current preview index
const previewIndex = parseInt(url.searchParams.get('preview') || '0');
const currentPreview = invoices[Math.min(previewIndex, invoices.length - 1)];
---

<AdminLayout title="Preview & Send Invoices">
  <div class="preview-page">
    {error && (
      <div class="m3-alert m3-alert-error">{error}</div>
    )}

    {success && (
      <div class="m3-alert m3-alert-success">
        {success}
        <a href="/admin/invoices?status=sent" class="m3-alert-link">View Sent Invoices &rarr;</a>
      </div>
    )}

    {invoices.some(i => i.revised) && (
      <div class="m3-alert m3-alert-success">
        <strong>Invoices revised:</strong> {invoices.filter(i => i.revised).length} invoice(s) were recalculated with updated fees.
      </div>
    )}

    <!-- Header Banner -->
    <div class="header-banner">
      <a href="/admin/invoices" class="back-link">&larr; Back to Invoices</a>
      <span class="invoice-count-badge">{invoices.length} Invoice{invoices.length !== 1 ? 's' : ''} Ready to Send</span>
    </div>

    {!emailConfigured && (
      <div class="m3-alert m3-alert-error">
        <strong>Email Not Configured:</strong> Configure Azure AD credentials to send invoices.
        <a href="/admin/invoices/settings" class="m3-alert-link">Setup &rarr;</a>
      </div>
    )}

    <div class="preview-grid">
      <!-- Sidebar -->
      <div class="sidebar">
        <!-- Invoice List -->
        <div class="m3-card">
          <div class="m3-card-header">
            <h2>Invoices</h2>
            <span class="member-count-badge">{invoices.length}</span>
          </div>

          <div class="invoice-list">
            {invoices.map((data, index) => (
              <a
                href={`?ids=${idsParam}&preview=${index}${customMessage ? `&message=${encodeURIComponent(customMessage)}` : ''}`}
                class={`invoice-list-item ${index === previewIndex ? 'active' : ''}`}
              >
                <div class="invoice-list-name">{getFullName(data.member)}</div>
                <div class="invoice-list-meta">{data.invoice.invoice_number}</div>
                <div class="invoice-list-email">
                  {data.member.email ? (
                    <span class="has-email">{data.member.email}</span>
                  ) : (
                    <span class="no-email">No email</span>
                  )}
                </div>
                <div class="invoice-list-amount">
                  {formatCurrency(data.invoice.total)}
                  {data.revised && <span class="revised-badge">Revised</span>}
                </div>
              </a>
            ))}
          </div>
        </div>

        <!-- Custom Message -->
        <div class="m3-card">
          <div class="m3-card-header">
            <h2>Custom Message</h2>
          </div>
          <p class="card-hint">Optional text shown at the top of the invoice email.</p>
          <textarea
            id="custom-message"
            class="form-input"
            rows="3"
            placeholder="e.g. Your subscription has been updated..."
          >{customMessage}</textarea>
          <button id="apply-message-btn" class="m3-btn m3-btn-tonal" style="width: 100%; margin-top: 0.75rem;">
            Update Preview
          </button>
        </div>

        <!-- Actions -->
        <div class="m3-card">
          <div class="m3-card-header">
            <h2>Send</h2>
          </div>

          <form method="POST" class="action-form">
            <input type="hidden" name="action" value="send_test" />
            <label class="form-label">Test Email Address</label>
            <input
              type="email"
              name="test_email"
              class="form-input"
              value={user?.email || ''}
              placeholder="your@email.com"
            />
            <button type="submit" class="m3-btn m3-btn-tonal" style="width: 100%; margin-top: 0.5rem;" disabled={!emailConfigured}>
              Send Test Email
            </button>
          </form>

          <div class="action-divider"></div>

          <form method="POST" id="send-all-form" data-count={invoices.length}>
            <input type="hidden" name="action" value="send_all" />
            <button
              type="submit"
              class="m3-btn m3-btn-filled"
              style="width: 100%;"
              disabled={!emailConfigured}
            >
              Send {invoices.length > 1 ? `All ${invoices.length} Invoices` : 'Invoice'}
            </button>
          </form>

          {!emailConfigured && (
            <p class="config-warning">Email sending is disabled. Configure Azure AD credentials to enable.</p>
          )}
        </div>

        <!-- Summary -->
        <div class="m3-card">
          <div class="m3-card-header">
            <h2>Summary</h2>
          </div>
          <div class="summary-grid">
            <div class="summary-row">
              <span>Total Invoices</span>
              <span class="summary-value">{invoices.length}</span>
            </div>
            <div class="summary-row">
              <span>With Email</span>
              <span class="summary-value">{invoices.filter(i => i.member.email && isValidEmail(i.member.email)).length}</span>
            </div>
            <div class="summary-row">
              <span>Without Email</span>
              <span class="summary-value">{invoices.filter(i => !i.member.email || !isValidEmail(i.member.email)).length}</span>
            </div>
            <div class="summary-row summary-total">
              <span>Total Value</span>
              <span class="summary-value">{formatCurrency(invoices.reduce((sum, i) => sum + i.invoice.total, 0))}</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Main: Email Preview -->
      <div class="preview-main">
        <div class="m3-card">
          <div class="m3-card-header">
            <h2>Email Preview</h2>
            {invoices.length > 1 && (
              <div class="preview-nav">
                {previewIndex > 0 && (
                  <a href={`?ids=${idsParam}&preview=${previewIndex - 1}${customMessage ? `&message=${encodeURIComponent(customMessage)}` : ''}`} class="m3-btn m3-btn-tonal m3-btn-sm">
                    &larr; Prev
                  </a>
                )}
                <span class="preview-counter">{previewIndex + 1} of {invoices.length}</span>
                {previewIndex < invoices.length - 1 && (
                  <a href={`?ids=${idsParam}&preview=${previewIndex + 1}${customMessage ? `&message=${encodeURIComponent(customMessage)}` : ''}`} class="m3-btn m3-btn-tonal m3-btn-sm">
                    Next &rarr;
                  </a>
                )}
              </div>
            )}
          </div>

          <div class="email-meta">
            <div class="email-meta-row">
              <span class="email-meta-label">To</span>
              <span>{currentPreview.member.email || 'No email address'}</span>
            </div>
            <div class="email-meta-row">
              <span class="email-meta-label">Subject</span>
              <span>{currentPreview.emailSubject}</span>
            </div>
          </div>

          <div class="email-frame-wrapper">
            <iframe
              class="email-frame"
              srcdoc={currentPreview.emailHtml}
            ></iframe>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script is:inline>
    // Update Preview button - reloads page with custom message in URL
    document.getElementById('apply-message-btn')?.addEventListener('click', () => {
      const msg = document.getElementById('custom-message').value.trim();
      const url = new URL(window.location.href);
      if (msg) {
        url.searchParams.set('message', msg);
      } else {
        url.searchParams.delete('message');
      }
      window.location.href = url.toString();
    });

    // Send all confirmation
    document.getElementById('send-all-form')?.addEventListener('submit', async (e) => {
      e.preventDefault();
      const count = e.target.dataset.count;
      const confirmed = await m3Confirm(
        `This will send ${count} invoice(s) to members via email. This cannot be undone.`,
        {
          title: 'Send Invoices?',
          type: 'warning',
          confirmText: 'Send All',
          cancelText: 'Cancel'
        }
      );
      if (confirmed) {
        e.target.submit();
      }
    });
  </script>
</AdminLayout>

<style>
  .preview-page {
    max-width: 1400px;
  }

  /* Alerts */
  .m3-alert {
    padding: 1rem 1.25rem;
    border-radius: 12px;
    margin-bottom: 1rem;
    font-size: 0.9rem;
    display: flex;
    align-items: center;
    gap: 1rem;
    flex-wrap: wrap;
  }

  .m3-alert-error {
    background: #fef2f2;
    color: #991b1b;
    border: 1px solid #fecaca;
  }

  .m3-alert-success {
    background: #f0fdf4;
    color: #166534;
    border: 1px solid #bbf7d0;
  }

  .m3-alert-link {
    color: inherit;
    font-weight: 600;
    text-decoration: none;
    margin-left: auto;
  }

  .m3-alert-link:hover {
    text-decoration: underline;
  }

  /* Header Banner */
  .header-banner {
    display: flex;
    align-items: center;
    justify-content: space-between;
    background: white;
    border-radius: 16px;
    padding: 1rem 1.5rem;
    margin-bottom: 1rem;
    box-shadow: 0 1px 3px rgba(0,0,0,0.08);
  }

  .back-link {
    color: #1e5631;
    text-decoration: none;
    font-weight: 500;
    font-size: 0.9rem;
  }

  .back-link:hover {
    text-decoration: underline;
  }

  .invoice-count-badge {
    display: inline-flex;
    align-items: center;
    padding: 0.4rem 1rem;
    background: #e8f5e9;
    color: #1e5631;
    border-radius: 100px;
    font-size: 0.875rem;
    font-weight: 600;
  }

  /* Grid Layout */
  .preview-grid {
    display: grid;
    grid-template-columns: 320px 1fr;
    gap: 1rem;
    align-items: start;
  }

  @media (max-width: 900px) {
    .preview-grid {
      grid-template-columns: 1fr;
    }
  }

  .sidebar {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  /* M3 Cards */
  .m3-card {
    background: white;
    border-radius: 16px;
    padding: 1.25rem;
    box-shadow: 0 1px 3px rgba(0,0,0,0.08);
  }

  .m3-card-header {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    margin-bottom: 1rem;
  }

  .m3-card-header h2 {
    margin: 0;
    font-size: 1rem;
    font-weight: 600;
    color: #333;
  }

  .member-count-badge {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    min-width: 24px;
    height: 24px;
    padding: 0 0.5rem;
    border-radius: 12px;
    background: #e8f5e9;
    color: #1e5631;
    font-size: 0.8rem;
    font-weight: 600;
  }

  /* Invoice List */
  .invoice-list {
    max-height: 380px;
    overflow-y: auto;
    margin: -0.25rem -1.25rem -1.25rem;
    border-radius: 0 0 16px 16px;
  }

  .invoice-list-item {
    display: block;
    padding: 0.75rem 1.25rem;
    text-decoration: none;
    color: inherit;
    border-top: 1px solid #f0f0f0;
    transition: background 0.15s;
  }

  .invoice-list-item:first-child {
    border-top: none;
  }

  .invoice-list-item:hover {
    background: #f9faf9;
  }

  .invoice-list-item.active {
    background: #e8f5e9;
  }

  .invoice-list-item:last-child {
    border-radius: 0 0 16px 16px;
  }

  .invoice-list-name {
    font-weight: 500;
    font-size: 0.9rem;
    color: #1a1a1a;
  }

  .invoice-list-meta {
    font-size: 0.8rem;
    color: #888;
    margin-top: 0.1rem;
  }

  .invoice-list-email {
    font-size: 0.8rem;
    margin-top: 0.1rem;
  }

  .has-email {
    color: #1e5631;
  }

  .no-email {
    color: #dc3545;
  }

  .invoice-list-amount {
    font-size: 0.85rem;
    font-weight: 600;
    margin-top: 0.25rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .revised-badge {
    font-size: 0.7rem;
    font-weight: 500;
    background: #fff3cd;
    color: #856404;
    padding: 0.1rem 0.4rem;
    border-radius: 6px;
  }

  /* Card Hint */
  .card-hint {
    font-size: 0.8rem;
    color: #888;
    margin: -0.5rem 0 0.75rem;
  }

  /* Actions */
  .action-form {
    margin-bottom: 0;
  }

  .action-divider {
    height: 1px;
    background: #f0f0f0;
    margin: 1rem 0;
  }

  .config-warning {
    margin: 0.75rem 0 0 0;
    font-size: 0.8rem;
    color: #dc3545;
  }

  /* Summary */
  .summary-grid {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .summary-row {
    display: flex;
    justify-content: space-between;
    font-size: 0.875rem;
    color: #666;
  }

  .summary-value {
    font-weight: 500;
    color: #333;
  }

  .summary-total {
    padding-top: 0.5rem;
    border-top: 1px solid #f0f0f0;
    font-weight: 600;
    color: #1a1a1a;
  }

  .summary-total .summary-value {
    color: #1e5631;
    font-weight: 700;
  }

  /* Preview Nav */
  .preview-nav {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-left: auto;
  }

  .preview-counter {
    font-size: 0.85rem;
    color: #888;
  }

  /* Email Meta */
  .email-meta {
    background: #f8faf8;
    border-radius: 12px;
    padding: 0.85rem 1rem;
    margin-bottom: 1rem;
    display: flex;
    flex-direction: column;
    gap: 0.35rem;
  }

  .email-meta-row {
    font-size: 0.875rem;
    display: flex;
    gap: 0.5rem;
  }

  .email-meta-label {
    font-weight: 600;
    color: #555;
    min-width: 55px;
  }

  /* Email Frame */
  .email-frame-wrapper {
    border: 1px solid #e5e7eb;
    border-radius: 12px;
    overflow: hidden;
  }

  .email-frame {
    width: 100%;
    height: 700px;
    border: none;
    display: block;
  }

  /* M3 Buttons */
  .m3-btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 0.6rem 1.25rem;
    border-radius: 100px;
    font-size: 0.875rem;
    font-weight: 500;
    cursor: pointer;
    border: none;
    transition: all 0.2s;
    text-decoration: none;
  }

  .m3-btn-filled {
    background: #1e5631;
    color: white;
  }

  .m3-btn-filled:hover {
    background: #164424;
    box-shadow: 0 1px 3px rgba(0,0,0,0.2);
  }

  .m3-btn-tonal {
    background: #e8f5e9;
    color: #1e5631;
  }

  .m3-btn-tonal:hover {
    background: #dcfce7;
  }

  .m3-btn-sm {
    padding: 0.35rem 0.85rem;
    font-size: 0.8rem;
  }

  .m3-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  /* Form overrides */
  .form-input {
    width: 100%;
    border-radius: 10px;
    padding: 0.6rem 0.75rem;
    box-sizing: border-box;
  }

  textarea.form-input {
    font-size: 0.85rem;
  }

  .form-label {
    display: block;
    font-size: 0.8rem;
    font-weight: 500;
    color: #555;
    margin-bottom: 0.35rem;
  }
</style>
