---
import AdminLayout from '../../../layouts/AdminLayout.astro';
import { formatDate, formatCurrency, getFullName, getFullAddress, getInvoiceStatusBadge, formatInvoicePeriod, type Invoice, type InvoiceItem, type Member, type InvoiceSetting } from '../../../lib/db';
import { generateInvoiceEmail, generateInvoiceSubject } from '../../../lib/email-template';

const { id } = Astro.params;
const db = Astro.locals.runtime.env.DB;
const user = Astro.locals.user;

// Get invoice
const invoice = await db.prepare(
  `SELECT * FROM invoices WHERE id = ?`
).bind(id).first<Invoice>();

if (!invoice) {
  return Astro.redirect('/invoices');
}

// Get member
const member = await db.prepare(
  `SELECT * FROM members WHERE id = ?`
).bind(invoice.member_id).first<Member>();

if (!member) {
  return Astro.redirect('/invoices');
}

// Get invoice items
const itemsResult = await db.prepare(
  `SELECT ii.*, pi.name as payment_item_name
   FROM invoice_items ii
   LEFT JOIN payment_items pi ON ii.payment_item_id = pi.id
   WHERE ii.invoice_id = ?
   ORDER BY ii.id`
).bind(id).all();
const items = (itemsResult.results || []) as (InvoiceItem & { payment_item_name?: string })[];

// Get settings for email preview
const settingsResult = await db.prepare(
  `SELECT * FROM invoice_settings`
).all();
const settings: Record<string, string> = {};
settingsResult.results?.forEach((row: any) => {
  settings[row.setting_key] = row.setting_value;
});

// Handle actions
let error = '';
let success = '';

if (Astro.request.method === 'POST') {
  const formData = await Astro.request.formData();
  const action = formData.get('action');

  if (action === 'mark_paid') {
    await db.prepare(
      `UPDATE invoices SET status = 'paid', updated_at = datetime('now') WHERE id = ?`
    ).bind(id).run();

    // Decrement member's balance and set renewal date
    await db.prepare(
      `UPDATE members SET account_balance = account_balance - ?, date_renewed = date('now') WHERE id = ?`
    ).bind(invoice.total, invoice.member_id).run();

    success = 'Invoice marked as paid, renewal date updated, and member balance adjusted';

    // Refresh invoice data
    const refreshed = await db.prepare(
      `SELECT * FROM invoices WHERE id = ?`
    ).bind(id).first<Invoice>();
    if (refreshed) Object.assign(invoice, refreshed);

  } else if (action === 'cancel') {
    // Check if this invoice has associated payments (e.g. DD auto-paid invoices)
    const existingPayment = await db.prepare(
      `SELECT id, amount, payment_method FROM payments WHERE invoice_id = ? LIMIT 1`
    ).bind(id).first();

    await db.prepare(
      `UPDATE invoices SET status = 'cancelled', updated_at = datetime('now') WHERE id = ?`
    ).bind(id).run();

    // Decrement member's outstanding balance by the invoice total
    await db.prepare(
      `UPDATE members SET account_balance = account_balance - ? WHERE id = ?`
    ).bind(invoice.total, invoice.member_id).run();

    // If a payment was already recorded (e.g. DD), create a refund payment record
    if (existingPayment) {
      const refundResult = await db.prepare(
        `INSERT INTO payments (member_id, invoice_id, amount, payment_date, payment_method, payment_type, reference, notes, recorded_by)
         VALUES (?, ?, ?, date('now'), ?, 'subscription', ?, 'Refund â€” invoice cancelled', ?)`
      ).bind(
        invoice.member_id, id, -(existingPayment.amount as number),
        existingPayment.payment_method, `REFUND ${invoice.invoice_number}`,
        user?.email || 'system'
      ).run();

      // Create refund payment line items mirroring the original
      const refundPaymentId = refundResult.meta?.last_row_id;
      if (refundPaymentId) {
        const originalLines = await db.prepare(
          `SELECT invoice_item_id, payment_item_id, description, amount FROM payment_line_items WHERE payment_id = ?`
        ).bind(existingPayment.id).all();

        for (const line of (originalLines.results || []) as any[]) {
          await db.prepare(
            `INSERT INTO payment_line_items (payment_id, invoice_item_id, payment_item_id, description, amount)
             VALUES (?, ?, ?, ?, ?)`
          ).bind(refundPaymentId, line.invoice_item_id, line.payment_item_id, `Refund: ${line.description}`, -line.amount).run();
        }
      }

      success = 'Invoice cancelled, payment refund recorded, and member balance adjusted';
    } else {
      success = 'Invoice cancelled and member balance adjusted';
    }

    const refreshed = await db.prepare(
      `SELECT * FROM invoices WHERE id = ?`
    ).bind(id).first<Invoice>();
    if (refreshed) Object.assign(invoice, refreshed);

    // Refresh member data too
    const refreshedMember = await db.prepare(
      `SELECT * FROM members WHERE id = ?`
    ).bind(invoice.member_id).first<Member>();
    if (refreshedMember) Object.assign(member, refreshedMember);

  } else if (action === 'revert_draft') {
    // Re-add the invoice total to the member's balance since it's outstanding again
    await db.prepare(
      `UPDATE members SET account_balance = account_balance + ? WHERE id = ?`
    ).bind(invoice.total, invoice.member_id).run();

    await db.prepare(
      `UPDATE invoices SET status = 'draft', updated_at = datetime('now') WHERE id = ?`
    ).bind(id).run();
    success = 'Invoice reverted to draft and member balance adjusted';

    const refreshed = await db.prepare(
      `SELECT * FROM invoices WHERE id = ?`
    ).bind(id).first<Invoice>();
    if (refreshed) Object.assign(invoice, refreshed);

    const refreshedMember = await db.prepare(
      `SELECT * FROM members WHERE id = ?`
    ).bind(invoice.member_id).first<Member>();
    if (refreshedMember) Object.assign(member, refreshedMember);

  } else if (action === 'delete') {
    // If deleting a non-cancelled invoice, decrement the member's balance
    if (invoice.status !== 'cancelled') {
      await db.prepare(
        `UPDATE members SET account_balance = account_balance - ? WHERE id = ?`
      ).bind(invoice.total, invoice.member_id).run();
    }

    // Delete associated payment line items and payments
    await db.prepare(
      `DELETE FROM payment_line_items WHERE payment_id IN (SELECT id FROM payments WHERE invoice_id = ?)`
    ).bind(id).run();
    await db.prepare(
      `DELETE FROM payments WHERE invoice_id = ?`
    ).bind(id).run();

    // Delete invoice items
    await db.prepare(
      `DELETE FROM invoice_items WHERE invoice_id = ?`
    ).bind(id).run();

    // Delete the invoice
    await db.prepare(
      `DELETE FROM invoices WHERE id = ?`
    ).bind(id).run();

    // Nullify the member's renewal date
    await db.prepare(
      `UPDATE members SET date_renewed = NULL WHERE id = ?`
    ).bind(invoice.member_id).run();

    // Log action
    await db.prepare(
      `INSERT INTO audit_log (user_email, action, entity_type, entity_id, details)
       VALUES (?, 'delete_invoice', 'invoice', ?, ?)`
    ).bind(user?.email || 'system', id, JSON.stringify({ invoice_number: invoice.invoice_number })).run();

    // Redirect to invoices list
    return Astro.redirect('/admin/invoices?deleted=1');
  }

  // Log action
  await db.prepare(
    `INSERT INTO audit_log (user_email, action, entity_type, entity_id, details)
     VALUES (?, ?, 'invoice', ?, ?)`
  ).bind(user?.email || 'system', action, id, JSON.stringify({ invoice_number: invoice.invoice_number })).run();
}

// Calculate period year
const periodYear = parseInt(invoice.period_start.substring(0, 4));

// Generate email preview
const emailPreview = generateInvoiceEmail({
  member,
  invoice,
  items,
  settings,
});
---

<AdminLayout title={`Invoice ${invoice.invoice_number}`}>
  {error && (
    <div class="alert alert-error">{error}</div>
  )}

  {success && (
    <div class="alert alert-success">{success}</div>
  )}

  <!-- Header Actions -->
  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
    <div>
      <a href="/invoices" class="btn btn-secondary">&larr; Back to Invoices</a>
    </div>
    <div style="display: flex; gap: 0.5rem;">
      {invoice.status === 'draft' && (
        <>
          <a href={`/invoices/preview?ids=${invoice.id}`} class="btn btn-primary">Send Invoice</a>
          <form method="POST" style="display: inline;" data-confirm="cancel">
            <input type="hidden" name="action" value="cancel" />
            <button type="submit" class="btn btn-danger">Cancel</button>
          </form>
        </>
      )}
      {invoice.status === 'sent' && (
        <>
          <form method="POST" style="display: inline;">
            <input type="hidden" name="action" value="mark_paid" />
            <button type="submit" class="btn btn-primary">Mark as Paid</button>
          </form>
          <form method="POST" style="display: inline;" data-confirm="cancel">
            <input type="hidden" name="action" value="cancel" />
            <button type="submit" class="btn btn-danger">Cancel</button>
          </form>
        </>
      )}
      {(invoice.status === 'cancelled' || invoice.status === 'paid') && (
        <form method="POST" style="display: inline;">
          <input type="hidden" name="action" value="revert_draft" />
          <button type="submit" class="btn btn-secondary">Revert to Draft</button>
        </form>
      )}
      {(invoice.status === 'draft' || invoice.status === 'cancelled') && (
        <form method="POST" style="display: inline;" data-confirm="delete">
          <input type="hidden" name="action" value="delete" />
          <button type="submit" class="btn btn-danger">Delete</button>
        </form>
      )}
      <button type="button" class="btn btn-secondary" onclick="window.print()">Print</button>
    </div>
  </div>

  <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 1.5rem;">
    <!-- Main Content -->
    <div>
      <!-- Invoice Details -->
      <div class="card">
        <div class="card-header">
          <h3 class="card-title">Invoice Details</h3>
          <span class={`badge ${getInvoiceStatusBadge(invoice.status)}`} style="font-size: 1rem; padding: 0.5rem 1rem;">
            {invoice.status.toUpperCase()}
          </span>
        </div>

        <div class="form-row">
          <div>
            <label class="form-label">Invoice Number</label>
            <p style="font-size: 1.25rem; font-weight: 600; margin: 0;">{invoice.invoice_number}</p>
          </div>
          <div>
            <label class="form-label">Invoice Date</label>
            <p style="margin: 0;">{formatDate(invoice.invoice_date)}</p>
          </div>
          <div>
            <label class="form-label">Period</label>
            <p style="margin: 0;">{formatInvoicePeriod(invoice.period_start, invoice.period_end)}</p>
          </div>
        </div>

        {invoice.sent_at && (
          <div style="margin-top: 1rem; padding: 1rem; background: #f8f9fa; border-radius: 4px;">
            <p style="margin: 0; font-size: 0.875rem; color: #666;">
              <strong>Sent:</strong> {formatDate(invoice.sent_at)} to {invoice.sent_to_email}
            </p>
          </div>
        )}

        {invoice.custom_message && (
          <div style="margin-top: 1rem; padding: 1rem; background: #e8f4e8; border-radius: 4px; border-left: 4px solid #1e5631;">
            <label class="form-label">Custom Message</label>
            <p style="margin: 0;">{invoice.custom_message}</p>
          </div>
        )}
      </div>

      <!-- Line Items -->
      <div class="card">
        <div class="card-header">
          <h3 class="card-title">Line Items</h3>
        </div>

        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>Description</th>
                <th style="text-align: center;">Qty</th>
                <th style="text-align: right;">Unit Price</th>
                <th style="text-align: right;">Total</th>
              </tr>
            </thead>
            <tbody>
              {items.map((item) => (
                <tr>
                  <td>{item.description}</td>
                  <td style="text-align: center;">{item.quantity}</td>
                  <td style="text-align: right;">{formatCurrency(item.unit_price)}</td>
                  <td style="text-align: right; font-weight: 500;">{formatCurrency(item.line_total)}</td>
                </tr>
              ))}
            </tbody>
            <tfoot>
              <tr style="background: #f8f9fa;">
                <td colspan="3" style="text-align: right; font-weight: 600;">Subtotal</td>
                <td style="text-align: right; font-weight: 600;">{formatCurrency(invoice.subtotal)}</td>
              </tr>
              <tr style="background: #1e5631; color: white;">
                <td colspan="3" style="text-align: right; font-weight: 600; font-size: 1.125rem;">Total</td>
                <td style="text-align: right; font-weight: 700; font-size: 1.25rem;">{formatCurrency(invoice.total)}</td>
              </tr>
            </tfoot>
          </table>
        </div>
      </div>

      <!-- Email Preview -->
      <div class="card">
        <div class="card-header">
          <h3 class="card-title">Email Preview</h3>
          <button type="button" class="btn btn-secondary btn-sm" onclick="toggleEmailPreview()">
            Show/Hide
          </button>
        </div>
        <div id="email-preview" style="display: none; border: 1px solid #ddd; border-radius: 4px; max-height: 600px; overflow: auto;">
          <iframe
            id="email-iframe"
            style="width: 100%; height: 600px; border: none;"
            srcdoc={emailPreview}
          ></iframe>
        </div>
      </div>
    </div>

    <!-- Sidebar -->
    <div>
      <!-- Member Info -->
      <div class="card">
        <div class="card-header">
          <h3 class="card-title">Member</h3>
        </div>
        <p style="font-size: 1.125rem; font-weight: 600; margin: 0 0 0.5rem 0;">
          <a href={`/admin/members/${member.id}`}>{getFullName(member)}</a>
        </p>
        <p style="margin: 0 0 0.5rem 0; font-size: 0.875rem; color: #666;">
          Member No: M{member.pin?.padStart(4, '0')}
        </p>
        <p style="margin: 0 0 0.5rem 0; font-size: 0.875rem;">
          <span class="badge badge-info">{member.category}</span>
        </p>

        {member.email && (
          <p style="margin: 0.5rem 0 0 0; font-size: 0.875rem;">
            <strong>Email:</strong> {member.email}
          </p>
        )}

        {member.telephone_1 && (
          <p style="margin: 0.25rem 0 0 0; font-size: 0.875rem;">
            <strong>Phone:</strong> {member.telephone_1}
          </p>
        )}

        <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #ddd;">
          <p style="margin: 0; font-size: 0.875rem; line-height: 1.5;">
            {getFullAddress(member)}
          </p>
        </div>
      </div>

      <!-- Audit Info -->
      <div class="card">
        <div class="card-header">
          <h3 class="card-title">Audit Trail</h3>
        </div>
        <p style="margin: 0 0 0.5rem 0; font-size: 0.875rem;">
          <strong>Created:</strong> {formatDate(invoice.created_at)}
        </p>
        {invoice.created_by && (
          <p style="margin: 0 0 0.5rem 0; font-size: 0.875rem;">
            <strong>By:</strong> {invoice.created_by}
          </p>
        )}
        <p style="margin: 0; font-size: 0.875rem;">
          <strong>Updated:</strong> {formatDate(invoice.updated_at)}
        </p>
      </div>

      <!-- Related Invoices -->
      <div class="card">
        <div class="card-header">
          <h3 class="card-title">Member's Other Invoices</h3>
        </div>
        <div id="related-invoices" style="font-size: 0.875rem;">
          Loading...
        </div>
      </div>
    </div>
  </div>
</AdminLayout>

<style>
  @media print {
    .btn, .card-header button, form {
      display: none !important;
    }
    .card {
      box-shadow: none;
      border: 1px solid #ddd;
    }
  }
</style>

<script define:vars={{ memberId: member.id, currentInvoiceId: invoice.id }}>
  // Toggle email preview
  window.toggleEmailPreview = function() {
    const preview = document.getElementById('email-preview');
    if (preview) {
      preview.style.display = preview.style.display === 'none' ? 'block' : 'none';
    }
  };

  // Load related invoices
  fetch(`/api/member-invoices?member_id=${memberId}&exclude=${currentInvoiceId}`)
    .then(res => res.json())
    .then(data => {
      const container = document.getElementById('related-invoices');
      if (!container) return;

      if (!data.invoices || data.invoices.length === 0) {
        container.innerHTML = '<p style="color: #666;">No other invoices</p>';
        return;
      }

      container.innerHTML = data.invoices.map(inv =>
        `<div style="padding: 0.5rem 0; border-bottom: 1px solid #eee;">
          <a href="/admin/invoices/${inv.id}">${inv.invoice_number}</a>
          <span class="badge badge-${inv.status === 'paid' ? 'success' : inv.status === 'sent' ? 'info' : 'warning'}" style="margin-left: 0.5rem; font-size: 0.7rem;">${inv.status}</span>
        </div>`
      ).join('');
    })
    .catch(() => {
      const container = document.getElementById('related-invoices');
      if (container) container.innerHTML = '<p style="color: #666;">Could not load</p>';
    });

  // M3 confirmation dialogs for forms
  document.querySelectorAll('form[data-confirm]').forEach(form => {
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const confirmType = form.dataset.confirm;

      let confirmed = false;
      if (confirmType === 'cancel') {
        confirmed = await m3Confirm('Are you sure you want to cancel this invoice?', {
          title: 'Cancel Invoice?',
          type: 'warning',
          confirmText: 'Cancel Invoice',
          cancelText: 'Keep It',
          danger: true
        });
      } else if (confirmType === 'delete') {
        confirmed = await m3Confirm('This will permanently delete this invoice. This cannot be undone.', {
          title: 'Delete Invoice?',
          type: 'delete',
          confirmText: 'Delete',
          cancelText: 'Keep It',
          danger: true
        });
      }

      if (confirmed) {
        form.submit();
      }
    });
  });
</script>
