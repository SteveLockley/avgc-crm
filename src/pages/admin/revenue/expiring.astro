---
// Expiring members CSV export
const db = Astro.locals.runtime.env.DB;

const days = parseInt(Astro.url.searchParams.get('days') || '60');

const members = await db.prepare(`
  SELECT surname, first_name, email, telephone_1, telephone_2, category,
         subscription_template, date_expires, default_payment_method,
         send_invoice_by, electronic_communication_consent
  FROM members
  WHERE date_expires BETWEEN date('now') AND date('now', '+' || ? || ' days')
  ORDER BY date_expires, surname
`).bind(days).all();

if (!members.results || members.results.length === 0) {
  return new Response(`No members expiring in the next ${days} days`, { status: 404 });
}

const columns = [
  'Surname', 'First Name', 'Email', 'Phone 1', 'Phone 2',
  'Category', 'Subscription', 'Expires', 'Payment Method', 'Invoice By', 'Email Consent'
];

function escapeCSV(value: any): string {
  const str = String(value || '');
  if (str.includes(',') || str.includes('"') || str.includes('\n')) {
    return `"${str.replace(/"/g, '""')}"`;
  }
  return str;
}

let csv = columns.join(',') + '\n';

for (const m of members.results) {
  const row = [
    m.surname,
    m.first_name,
    m.email,
    m.telephone_1,
    m.telephone_2,
    m.category,
    m.subscription_template,
    m.date_expires,
    m.default_payment_method,
    m.send_invoice_by,
    m.electronic_communication_consent
  ].map(escapeCSV);
  csv += row.join(',') + '\n';
}

const filename = `AVGC_Expiring_Members_${days}days_${new Date().toISOString().split('T')[0]}.csv`;

return new Response(csv, {
  headers: {
    'Content-Type': 'text/csv; charset=utf-8',
    'Content-Disposition': `attachment; filename="${filename}"`
  }
});
---
