---
import AdminLayout from '../../../layouts/AdminLayout.astro';
import { formatCurrency, formatDate, type PaymentItem } from '../../../lib/db';

const db = Astro.locals.runtime.env.DB;

// Subscription type breakdown (category holds subscription type)
const subscriptionStats = await db.prepare(`
  SELECT
    category,
    COUNT(*) as count,
    SUM(CASE WHEN home_away = 'H' THEN 1 ELSE 0 END) as home,
    SUM(CASE WHEN home_away = 'A' THEN 1 ELSE 0 END) as away
  FROM members
  WHERE category IS NOT NULL AND category != ''
  GROUP BY category
  ORDER BY count DESC
`).all();

// Get payment items with revenue from invoices
const paymentItemsResult = await db.prepare(
  `SELECT * FROM payment_items WHERE active = 1 ORDER BY category, name`
).all();
const paymentItems = (paymentItemsResult.results || []) as PaymentItem[];

// Get current year for revenue reporting
const currentYear = new Date().getFullYear();
const currentYearStart = `${currentYear}-01-01`;

// Potential revenue by payment item (all non-cancelled invoices in current year)
const potentialRevenueByItem = await db.prepare(`
  SELECT
    ii.description,
    COUNT(*) as count,
    SUM(ii.line_total) as total_revenue
  FROM invoice_items ii
  JOIN invoices i ON ii.invoice_id = i.id
  WHERE i.status != 'cancelled'
    AND i.period_start >= ?
  GROUP BY ii.description
  ORDER BY total_revenue DESC
`).bind(currentYearStart).all();

// Actual revenue paid by payment item (from payment_line_items table)
const actualRevenueByItem = await db.prepare(`
  SELECT
    pli.description,
    COUNT(*) as count,
    SUM(pli.amount) as total_revenue
  FROM payment_line_items pli
  JOIN payments p ON pli.payment_id = p.id
  JOIN invoices i ON p.invoice_id = i.id
  WHERE i.period_start >= ?
  GROUP BY pli.description
  ORDER BY total_revenue DESC
`).bind(currentYearStart).all();

// Also get total actual payments received for invoices this period
const totalActualPayments = await db.prepare(`
  SELECT SUM(p.amount) as total
  FROM payments p
  JOIN invoices i ON p.invoice_id = i.id
  WHERE i.period_start >= ?
`).bind(currentYearStart).first<{ total: number }>();

// Create a map of actual revenue for easy lookup
const actualRevenueMap: Record<string, { count: number; revenue: number }> = {};
actualRevenueByItem.results?.forEach((item: any) => {
  actualRevenueMap[item.description] = { count: item.count, revenue: item.total_revenue };
});

// Payment statistics - current year (uses currentYear defined above)
const paymentStats = await db.prepare(`
  SELECT
    payment_type,
    COUNT(*) as count,
    SUM(amount) as total
  FROM payments
  WHERE payment_date >= ?
  GROUP BY payment_type
  ORDER BY total DESC
`).bind(`${currentYear}-01-01`).all();

// Outstanding balances
const outstandingBalances = await db.prepare(`
  SELECT
    SUM(CASE WHEN account_balance < 0 THEN account_balance ELSE 0 END) as credits,
    SUM(CASE WHEN account_balance > 0 THEN account_balance ELSE 0 END) as debits,
    COUNT(CASE WHEN account_balance != 0 THEN 1 END) as members_with_balance
  FROM members
`).first();

// Monthly subscription revenue (Apr-Mar membership year)
// Find the most recent membership year that has invoices
const now = new Date();
const latestInvoiceYear = await db.prepare(`
  SELECT DISTINCT period_start FROM invoices
  WHERE status != 'cancelled'
  ORDER BY period_start DESC LIMIT 1
`).first<{ period_start: string }>();

// Fall back to current year logic if no invoices exist
let membershipYearStart: number;
if (latestInvoiceYear?.period_start) {
  membershipYearStart = parseInt(latestInvoiceYear.period_start.substring(0, 4));
} else {
  membershipYearStart = now.getMonth() < 3 ? now.getFullYear() - 1 : now.getFullYear();
}
const membershipYearEnd = membershipYearStart + 1;
const aprStart = `${membershipYearStart}-04-01`;
const marEnd = `${membershipYearEnd}-03-31`;

// Monthly payment totals - membership year (Apr-Mar)
const monthlyPayments = await db.prepare(`
  SELECT
    strftime('%Y-%m', payment_date) as month,
    SUM(amount) as total,
    COUNT(*) as count
  FROM payments
  WHERE payment_date >= ? AND payment_date <= ?
  GROUP BY strftime('%Y-%m', payment_date)
  ORDER BY month
`).bind(aprStart, marEnd).all();

// DD invoices: get subscription vs fee breakdown per invoice for schedule calculation
const ddInvoiceBreakdown = await db.prepare(`
  SELECT
    i.id,
    i.total,
    SUM(CASE WHEN ii.description LIKE '%subscription%' THEN ii.line_total ELSE 0 END) as sub_amount,
    SUM(CASE WHEN ii.description NOT LIKE '%subscription%' THEN ii.line_total ELSE 0 END) as fee_amount
  FROM invoices i
  JOIN invoice_items ii ON ii.invoice_id = i.id
  WHERE i.status != 'cancelled'
    AND i.period_start = ?
    AND i.status = 'paid'
    AND EXISTS (SELECT 1 FROM payments p WHERE p.invoice_id = i.id AND p.payment_method = 'Clubwise Direct Debit')
  GROUP BY i.id
`).bind(aprStart).all();

// Non-DD invoices: total invoiced (goes in April) and paid by payment month
const nonDDTotal = await db.prepare(`
  SELECT SUM(i.total) as total
  FROM invoices i
  WHERE i.status != 'cancelled'
    AND i.period_start = ?
    AND NOT EXISTS (SELECT 1 FROM payments p WHERE p.invoice_id = i.id AND p.payment_method = 'Clubwise Direct Debit')
`).bind(aprStart).first<{ total: number }>();

const nonDDPaidByMonth = await db.prepare(`
  SELECT
    strftime('%Y-%m', p.payment_date) as month,
    SUM(p.amount) as paid
  FROM payments p
  JOIN invoices i ON i.id = p.invoice_id
  WHERE i.status != 'cancelled'
    AND i.period_start = ?
    AND p.payment_method != 'Clubwise Direct Debit'
    AND p.amount > 0
  GROUP BY strftime('%Y-%m', p.payment_date)
  ORDER BY month
`).bind(aprStart).all();

// Build monthly schedule arrays (Apr=0 ... Mar=11)
const MONTH_LABELS = ['Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec', 'Jan', 'Feb', 'Mar'];
const invoicedByMonth = new Array(12).fill(0);
const paidByMonth = new Array(12).fill(0);

// Spread DD invoices across 12 months using DD schedule
// First month (Apr): fees + first month subscription (absorbs rounding)
// Months 2-12 (May-Mar): floor(subscription / 12) each
for (const inv of (ddInvoiceBreakdown.results || []) as any[]) {
  const sub = inv.sub_amount as number;
  const fees = inv.fee_amount as number;
  const monthly = Math.floor(sub * 100 / 12) / 100;
  const firstMonthSub = Math.round((sub - 11 * monthly) * 100) / 100;
  const firstMonth = fees + firstMonthSub;

  // DD invoices are paid, so invoiced = paid for each month
  invoicedByMonth[0] += firstMonth;
  paidByMonth[0] += firstMonth;
  for (let m = 1; m < 12; m++) {
    invoicedByMonth[m] += monthly;
    paidByMonth[m] += monthly;
  }
}

// Non-DD: all invoiced goes in April (index 0), paid distributed by payment month
invoicedByMonth[0] += (nonDDTotal?.total || 0);

for (const row of (nonDDPaidByMonth.results || []) as any[]) {
  const month = row.month as string;
  const [yr, mo] = month.split('-').map(Number);
  let idx: number;
  if (mo >= 4) {
    idx = mo - 4; // Apr=0, May=1, ..., Dec=8
  } else {
    idx = mo + 8; // Jan=9, Feb=10, Mar=11
  }
  if (idx >= 0 && idx < 12) {
    paidByMonth[idx] += row.paid as number;
  }
}

// Build chart data
const subRevenueData: { label: string; key: string; invoiced: number; paid: number; unpaid: number }[] = [];
for (let i = 0; i < 12; i++) {
  const monthNum = ((3 + i) % 12) + 1;
  const yr = monthNum <= 3 ? membershipYearEnd : membershipYearStart;
  const key = `${yr}-${String(monthNum).padStart(2, '0')}`;
  const invoiced = Math.round(invoicedByMonth[i] * 100) / 100;
  const paid = Math.round(paidByMonth[i] * 100) / 100;
  subRevenueData.push({
    label: MONTH_LABELS[i],
    key,
    invoiced,
    paid,
    unpaid: Math.max(Math.round((invoiced - paid) * 100) / 100, 0),
  });
}
const totalInvoiced = Math.round(subRevenueData.reduce((sum, d) => sum + d.invoiced, 0) * 100) / 100;
const totalPaid = Math.round(subRevenueData.reduce((sum, d) => sum + d.paid, 0) * 100) / 100;
const totalUnpaid = Math.max(Math.round((totalInvoiced - totalPaid) * 100) / 100, 0);
const maxBarValue = Math.max(...subRevenueData.map(d => Math.max(d.invoiced, d.paid)), 1);

// Recent membership activity
const recentJoins = await db.prepare(`
  SELECT COUNT(*) as count
  FROM members
  WHERE date_joined >= date('now', '-30 days')
`).first();

// Payment method breakdown (including members with no payment method)
const paymentMethodStats = await db.prepare(`
  SELECT
    COALESCE(default_payment_method, 'Not Set') as default_payment_method,
    COUNT(*) as count
  FROM members
  GROUP BY COALESCE(default_payment_method, 'Not Set')
  ORDER BY count DESC
`).all();
---

<AdminLayout title="Revenue">
  <!-- Page Header -->
  <div class="page-header">
    <div class="header-content">
      <h1>Revenue</h1>
      <p class="subtitle">Revenue and financial analytics</p>
    </div>
  </div>

  <!-- Financial Overview Stats -->
  <div class="stats-row">
    <div class="stat-card">
      <div class="stat-icon">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M7 20h10M10 20V12a4 4 0 0 1 8-1M6 14h8"/>
        </svg>
      </div>
      <div class="stat-content">
        <span class="stat-value">{formatCurrency(Math.abs(outstandingBalances?.credits || 0))}</span>
        <span class="stat-label">Member Credits</span>
      </div>
    </div>

    <div class="stat-card stat-success">
      <div class="stat-icon">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/>
          <polyline points="17 6 23 6 23 12"/>
        </svg>
      </div>
      <div class="stat-content">
        <span class="stat-value">{formatCurrency(outstandingBalances?.debits || 0)}</span>
        <span class="stat-label">Outstanding Debts</span>
      </div>
    </div>

    <div class="stat-card stat-info">
      <div class="stat-icon">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
          <circle cx="8.5" cy="7" r="4"/>
          <line x1="20" y1="8" x2="20" y2="14"/>
          <line x1="23" y1="11" x2="17" y2="11"/>
        </svg>
      </div>
      <div class="stat-content">
        <span class="stat-value">{recentJoins?.count || 0}</span>
        <span class="stat-label">New (30 days)</span>
      </div>
    </div>
  </div>

  <!-- Main Grid -->
  <div class="reports-grid">
    <!-- Left Column -->
    <div class="reports-main">
      <!-- Subscription Revenue Chart -->
      <div class="m3-card">
        <div class="card-header">
          <div class="card-title">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="18" y1="20" x2="18" y2="10"/>
              <line x1="12" y1="20" x2="12" y2="4"/>
              <line x1="6" y1="20" x2="6" y2="14"/>
            </svg>
            <span>Subscription Revenue</span>
          </div>
          <span class="card-badge">{membershipYearStart}/{membershipYearEnd}</span>
        </div>
        <div class="card-content">
          <div class="chart-summary">
            <div class="chart-summary-item">
              <span class="chart-legend-dot legend-invoiced"></span>
              Invoiced: <strong>{formatCurrency(totalInvoiced)}</strong>
            </div>
            <div class="chart-summary-item">
              <span class="chart-legend-dot legend-paid"></span>
              Paid: <strong>{formatCurrency(totalPaid)}</strong>
            </div>
            <div class="chart-summary-item">
              <span class="chart-legend-dot legend-unpaid"></span>
              Unpaid: <strong>{formatCurrency(totalUnpaid)}</strong>
            </div>
          </div>
          <div class="bar-chart">
            {subRevenueData.map((d) => (
              <div class="bar-col">
                <div class="bar-value">{d.invoiced > 0 ? formatCurrency(d.invoiced) : ''}</div>
                <div class="bar-track">
                  <div class="bar-stack" style={`height: ${maxBarValue > 0 ? (d.invoiced / maxBarValue) * 100 : 0}%`}>
                    <a href="/admin/invoices?status=draft" class="bar-segment-unpaid" style={`flex: ${d.unpaid}`}></a>
                    <div class="bar-segment-paid" style={`flex: ${d.paid}`}></div>
                  </div>
                </div>
                <div class="bar-label">{d.label}</div>
              </div>
            ))}
          </div>
          {totalInvoiced === 0 && (
            <div class="empty-row" style="text-align: center; color: #999; padding: 1rem;">No invoices recorded for this period</div>
          )}
        </div>
      </div>

      <!-- Revenue by Payment Item -->
      <div class="m3-card">
        <div class="card-header">
          <div class="card-title">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="1" y="4" width="22" height="16" rx="2" ry="2"/>
              <line x1="1" y1="10" x2="23" y2="10"/>
            </svg>
            <span>Revenue by Payment Item</span>
          </div>
          <span class="card-badge">{currentYear}/{currentYear + 1}</span>
        </div>
        <div class="card-content">
          <table class="m3-table">
            <thead>
              <tr>
                <th>Payment Item</th>
                <th class="text-right">Invoiced</th>
                <th class="text-right">Potential</th>
                <th class="text-right">Paid</th>
                <th class="text-right">Actual</th>
                <th class="text-right">%</th>
              </tr>
            </thead>
            <tbody>
              {potentialRevenueByItem.results?.map((item) => {
                const actual = actualRevenueMap[item.description as string] || { count: 0, revenue: 0 };
                const potentialRev = item.total_revenue as number;
                const actualRev = actual.revenue;
                const collectionPct = potentialRev > 0 ? ((actualRev / potentialRev) * 100).toFixed(0) : '0';
                return (
                  <tr>
                    <td class="item-name">{item.description}</td>
                    <td class="text-right">{item.count}</td>
                    <td class="text-right">{formatCurrency(potentialRev)}</td>
                    <td class="text-right">{actual.count}</td>
                    <td class="text-right text-success">{formatCurrency(actualRev)}</td>
                    <td class="text-right">
                      <span class={`pct-badge ${parseFloat(collectionPct) >= 80 ? 'pct-high' : parseFloat(collectionPct) >= 50 ? 'pct-mid' : 'pct-low'}`}>
                        {collectionPct}%
                      </span>
                    </td>
                  </tr>
                );
              })}
              {(!potentialRevenueByItem.results || potentialRevenueByItem.results.length === 0) && (
                <tr>
                  <td colspan="6" class="empty-row">No invoice data available</td>
                </tr>
              )}
            </tbody>
            {potentialRevenueByItem.results && potentialRevenueByItem.results.length > 0 && (
              <tfoot>
                <tr>
                  <td><strong>Total</strong></td>
                  <td class="text-right"><strong>{potentialRevenueByItem.results.reduce((sum, item) => sum + (item.count as number), 0)}</strong></td>
                  <td class="text-right"><strong>{formatCurrency(potentialRevenueByItem.results.reduce((sum, item) => sum + (item.total_revenue as number), 0))}</strong></td>
                  <td class="text-right"><strong>{actualRevenueByItem.results?.reduce((sum, item) => sum + (item.count as number), 0) || 0}</strong></td>
                  <td class="text-right text-success"><strong>{formatCurrency(actualRevenueByItem.results?.reduce((sum, item) => sum + (item.total_revenue as number), 0) || 0)}</strong></td>
                  <td class="text-right">
                    {(() => {
                      const totalPotential = potentialRevenueByItem.results.reduce((sum, item) => sum + (item.total_revenue as number), 0);
                      const totalActual = actualRevenueByItem.results?.reduce((sum, item) => sum + (item.total_revenue as number), 0) || 0;
                      const pct = totalPotential > 0 ? ((totalActual / totalPotential) * 100).toFixed(0) : '0';
                      return <span class="pct-badge pct-total">{pct}%</span>;
                    })()}
                  </td>
                </tr>
              </tfoot>
            )}
          </table>
        </div>
      </div>

      <!-- Members by Subscription -->
      <div class="m3-card">
        <div class="card-header">
          <div class="card-title">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
              <circle cx="9" cy="7" r="4"/>
              <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
              <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
            </svg>
            <span>Members by Subscription</span>
          </div>
        </div>
        <div class="card-content">
          <table class="m3-table">
            <thead>
              <tr>
                <th>Subscription Type</th>
                <th class="text-right">Home</th>
                <th class="text-right">Away</th>
                <th class="text-right">Total</th>
              </tr>
            </thead>
            <tbody>
              {subscriptionStats.results?.map((sub) => (
                <tr>
                  <td>
                    <a href={`/members?subscription_type=${encodeURIComponent(sub.category as string)}`} class="table-link">
                      {sub.category}
                    </a>
                  </td>
                  <td class="text-right">{sub.home}</td>
                  <td class="text-right">{sub.away}</td>
                  <td class="text-right"><strong>{sub.count}</strong></td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      </div>

      <!-- Monthly Payments -->
      <div class="m3-card">
        <div class="card-header">
          <div class="card-title">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
              <line x1="16" y1="2" x2="16" y2="6"/>
              <line x1="8" y1="2" x2="8" y2="6"/>
              <line x1="3" y1="10" x2="21" y2="10"/>
            </svg>
            <span>Monthly Payments</span>
          </div>
          <span class="card-badge">{membershipYearStart}/{membershipYearEnd}</span>
        </div>
        <div class="card-content">
          <table class="m3-table">
            <thead>
              <tr>
                <th>Month</th>
                <th class="text-right">Payments</th>
                <th class="text-right">Total</th>
              </tr>
            </thead>
            <tbody>
              {monthlyPayments.results?.map((mp) => (
                <tr>
                  <td>{mp.month}</td>
                  <td class="text-right">{mp.count}</td>
                  <td class="text-right"><strong>{formatCurrency(mp.total as number)}</strong></td>
                </tr>
              ))}
              {(!monthlyPayments.results || monthlyPayments.results.length === 0) && (
                <tr>
                  <td colspan="3" class="empty-row">No payment data</td>
                </tr>
              )}
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Right Column -->
    <div class="reports-sidebar">
      <!-- Payments by Type -->
      <div class="m3-card">
        <div class="card-header">
          <div class="card-title">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M7 18h10M7 14h6a4 4 0 0 0 0-8H7v12"/>
            </svg>
            <span>Payments by Type</span>
          </div>
          <span class="card-badge-light">{currentYear}</span>
        </div>
        <div class="card-content">
          <div class="payment-type-list">
            {paymentStats.results?.map((pt) => (
              <div class="payment-type-item">
                <span class="payment-type-name">{pt.payment_type || 'Unspecified'}</span>
                <div class="payment-type-stats">
                  <span class="payment-count">{pt.count} payments</span>
                  <span class="payment-total">{formatCurrency(pt.total as number)}</span>
                </div>
              </div>
            ))}
            {(!paymentStats.results || paymentStats.results.length === 0) && (
              <div class="empty-state-light">No payments this year</div>
            )}
          </div>
        </div>
      </div>

      <!-- Payment Methods -->
      <div class="m3-card">
        <div class="card-header">
          <div class="card-title">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="1" y="4" width="22" height="16" rx="2" ry="2"/>
              <line x1="1" y1="10" x2="23" y2="10"/>
            </svg>
            <span>Payment Methods</span>
          </div>
        </div>
        <div class="card-content">
          <div class="method-list">
            {paymentMethodStats.results?.map((pm) => {
              const methodValue = pm.default_payment_method as string;
              const filterParam = methodValue === 'Not Set'
                ? '/admin/members?payment_method=none'
                : `/admin/members?payment_method=${encodeURIComponent(methodValue)}`;
              return (
                <a href={filterParam} class="method-item method-link">
                  <span class="method-name">{methodValue}</span>
                  <span class="method-count">{pm.count} members</span>
                </a>
              );
            })}
          </div>
        </div>
      </div>

      <!-- Export Reports -->
      <div class="m3-card">
        <div class="card-header">
          <div class="card-title">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
              <polyline points="7 10 12 15 17 10"/>
              <line x1="12" y1="15" x2="12" y2="3"/>
            </svg>
            <span>Export Reports</span>
          </div>
        </div>
        <div class="card-content">
          <div class="export-actions">
            <a href="/admin/members/export" class="export-btn">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                <polyline points="14 2 14 8 20 8"/>
              </svg>
              Export Members (CSV)
            </a>
            <a href="/admin/revenue/expiring" class="export-btn">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"/>
                <polyline points="12 6 12 12 16 14"/>
              </svg>
              Expiring Members
            </a>
            <a href="/admin/revenue/renewals" class="export-btn">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="23 4 23 10 17 10"/>
                <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/>
              </svg>
              Renewal Reminders
            </a>
            <a href="/admin/members/clubwise-first-month" class="export-btn">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="1" y="4" width="22" height="16" rx="2" ry="2"/>
                <line x1="1" y1="10" x2="23" y2="10"/>
              </svg>
              Clubwise First Month (CSV)
            </a>
            <a href="/admin/revenue/clubhouse" class="export-btn primary">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
                <polyline points="9 22 9 12 15 12 15 22"/>
              </svg>
              Clubhouse Financials
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>

  <style>
    .page-header {
      margin-bottom: 2rem;
    }

    .header-content h1 {
      margin: 0;
      font-size: 1.75rem;
      font-weight: 600;
      color: #1a1a1a;
    }

    .subtitle {
      margin: 0.25rem 0 0 0;
      color: #666;
      font-size: 0.95rem;
    }

    /* Stats Row */
    .stats-row {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 1rem;
      margin-bottom: 2rem;
    }

    .stat-card {
      background: #fff;
      border-radius: 16px;
      padding: 1.25rem;
      display: flex;
      align-items: center;
      gap: 1rem;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
      border: 1px solid #e8e8e8;
    }

    .stat-icon {
      width: 48px;
      height: 48px;
      border-radius: 12px;
      background: linear-gradient(135deg, #dc3545 0%, #e85d6a 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }

    .stat-icon svg {
      width: 24px;
      height: 24px;
      color: #fff;
    }

    .stat-success .stat-icon { background: linear-gradient(135deg, #28a745 0%, #34ce57 100%); }
    .stat-info .stat-icon { background: linear-gradient(135deg, #1e5631 0%, #2d7a45 100%); }

    .stat-content {
      display: flex;
      flex-direction: column;
    }

    .stat-value {
      font-size: 1.5rem;
      font-weight: 700;
      color: #1a1a1a;
      line-height: 1;
    }

    .stat-label {
      font-size: 0.85rem;
      color: #666;
      margin-top: 0.25rem;
    }

    /* Reports Grid */
    .reports-grid {
      display: grid;
      grid-template-columns: 1fr 380px;
      gap: 1.5rem;
    }

    .reports-main {
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
    }

    .reports-sidebar {
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
    }

    /* M3 Card */
    .m3-card {
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
      border: 1px solid #e8e8e8;
      overflow: hidden;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem 1.25rem;
      border-bottom: 1px solid #f0f0f0;
      background: #fafafa;
    }

    .card-title {
      display: flex;
      align-items: center;
      gap: 0.625rem;
      font-weight: 600;
      color: #1a1a1a;
      font-size: 1rem;
    }

    .card-title svg {
      width: 20px;
      height: 20px;
      color: #1e5631;
    }

    .card-badge {
      font-size: 0.75rem;
      padding: 0.25rem 0.625rem;
      background: #e8f5e9;
      color: #1e5631;
      border-radius: 20px;
      font-weight: 500;
    }

    .card-badge-light {
      font-size: 0.75rem;
      padding: 0.25rem 0.625rem;
      background: rgba(255,255,255,0.2);
      color: rgba(255,255,255,0.9);
      border-radius: 20px;
      font-weight: 500;
    }

    .card-content {
      padding: 1.25rem;
    }

    /* M3 Table */
    .m3-table {
      width: 100%;
      border-collapse: collapse;
    }

    .m3-table th {
      text-align: left;
      padding: 0.75rem;
      font-weight: 600;
      font-size: 0.75rem;
      color: #666;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      border-bottom: 2px solid #e8e8e8;
    }

    .m3-table td {
      padding: 0.75rem;
      font-size: 0.875rem;
      color: #333;
      border-bottom: 1px solid #f0f0f0;
    }

    .m3-table tbody tr:last-child td {
      border-bottom: none;
    }

    .m3-table tfoot td {
      padding: 0.875rem 0.75rem;
      background: #f8f9fa;
      border-top: 2px solid #e8e8e8;
    }

    .text-right { text-align: right; }
    .text-success { color: #28a745; font-weight: 600; }

    .table-link {
      color: #1e5631;
      text-decoration: none;
      font-weight: 500;
    }

    .table-link:hover { text-decoration: underline; }

    .item-name { font-weight: 500; }

    .empty-row {
      text-align: center;
      color: #999;
      padding: 2rem !important;
    }

    /* Percentage Badges */
    .pct-badge {
      display: inline-block;
      padding: 0.2rem 0.5rem;
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: 600;
    }

    .pct-high { background: #d4edda; color: #155724; }
    .pct-mid { background: #fff3cd; color: #856404; }
    .pct-low { background: #f8d7da; color: #721c24; }
    .pct-total { background: #d1ecf1; color: #0c5460; }

    /* Payment Type List */
    .payment-type-list {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    .payment-type-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.75rem 1rem;
      background: rgba(255,255,255,0.15);
      border-radius: 10px;
    }

    .payment-type-name {
      color: #fff;
      font-weight: 500;
    }

    .payment-type-stats {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 0.125rem;
    }

    .payment-count {
      font-size: 0.75rem;
      color: rgba(255,255,255,0.7);
    }

    .payment-total {
      font-size: 1.125rem;
      font-weight: 700;
      color: #fff;
    }

    .empty-state-light {
      text-align: center;
      color: rgba(255,255,255,0.7);
      padding: 1.5rem;
    }

    /* Method List */
    .method-list {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .method-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.625rem 0.75rem;
      border-bottom: 1px solid #f0f0f0;
      border-radius: 8px;
    }

    .method-item:last-child {
      border-bottom: none;
    }

    .method-link {
      text-decoration: none;
      transition: background 0.2s;
    }

    .method-link:hover {
      background: #f0f7f0;
    }

    .method-name {
      font-weight: 500;
      color: #333;
    }

    .method-count {
      font-size: 0.85rem;
      color: #666;
    }

    /* Export Actions */
    .export-actions {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .export-btn {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.875rem 1rem;
      background: #f8f9fa;
      border-radius: 10px;
      color: #333;
      text-decoration: none;
      font-weight: 500;
      font-size: 0.9rem;
      transition: all 0.2s ease;
    }

    .export-btn:hover {
      background: #f0f0f0;
    }

    .export-btn.primary {
      background: linear-gradient(135deg, #1e5631 0%, #2d7a45 100%);
      color: #fff;
    }

    .export-btn.primary:hover {
      background: linear-gradient(135deg, #164024 0%, #246339 100%);
    }

    .export-btn svg {
      width: 20px;
      height: 20px;
      flex-shrink: 0;
    }

    /* Bar Chart */
    .chart-summary {
      display: flex;
      gap: 1.5rem;
      margin-bottom: 1rem;
      justify-content: flex-end;
      flex-wrap: wrap;
    }

    .chart-summary-item {
      font-size: 0.85rem;
      color: #666;
      display: flex;
      align-items: center;
      gap: 0.375rem;
    }

    .chart-summary-item strong {
      color: #1a1a1a;
    }

    .chart-legend-dot {
      width: 10px;
      height: 10px;
      border-radius: 2px;
      flex-shrink: 0;
    }

    .legend-invoiced { background: #e0e0e0; }
    .legend-paid { background: #28a745; }
    .legend-unpaid { background: #dc3545; }

    .bar-chart {
      display: flex;
      align-items: flex-end;
      gap: 4px;
      height: 220px;
    }

    .bar-col {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      height: 100%;
    }

    .bar-value {
      font-size: 0.6rem;
      color: #666;
      font-weight: 600;
      margin-bottom: 4px;
      white-space: nowrap;
      min-height: 14px;
    }

    .bar-track {
      flex: 1;
      width: 100%;
      max-width: 48px;
      display: flex;
      align-items: flex-end;
      background: #f0f0f0;
      border-radius: 4px 4px 0 0;
      overflow: hidden;
    }

    .bar-stack {
      width: 100%;
      display: flex;
      flex-direction: column;
      border-radius: 4px 4px 0 0;
      overflow: hidden;
      transition: height 0.3s ease;
    }

    .bar-segment-paid {
      background: #28a745;
    }

    .bar-segment-unpaid {
      background: #dc3545;
      cursor: pointer;
      text-decoration: none;
      display: block;
    }

    .bar-segment-unpaid:hover {
      background: #c82333;
    }

    .bar-label {
      font-size: 0.75rem;
      color: #666;
      font-weight: 500;
      margin-top: 6px;
    }

    /* Responsive */
    @media (max-width: 1200px) {
      .reports-grid {
        grid-template-columns: 1fr;
      }

      .reports-sidebar {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
      }
    }

    @media (max-width: 900px) {
      .stats-row {
        grid-template-columns: 1fr;
      }

      .reports-sidebar {
        grid-template-columns: 1fr;
      }
    }
  </style>
</AdminLayout>
