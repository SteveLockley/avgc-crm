---
import AdminLayout from '../../../layouts/AdminLayout.astro';

const db = Astro.locals.runtime?.env?.DB;

const DAY_NAMES = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];

let hours: any[] = [];
let message = '';
let messageType: 'success' | 'error' | '' = '';

// Handle form submissions
if (Astro.request.method === 'POST') {
  const formData = await Astro.request.formData();
  const action = formData.get('action');

  try {
    if (action === 'update') {
      // Update all days at once
      for (let day = 0; day < 7; day++) {
        const openTime = formData.get(`open_${day}`)?.toString() || '08:00';
        const closeTime = formData.get(`close_${day}`)?.toString() || '18:00';
        const isClosed = formData.get(`closed_${day}`) === 'on' ? 1 : 0;

        // Check if entry exists
        const existing = await db?.prepare(
          `SELECT id FROM opening_hours WHERE location = 'Clubhouse' AND day_of_week = ?`
        ).bind(day).first();

        if (existing) {
          await db?.prepare(
            `UPDATE opening_hours SET open_time = ?, close_time = ?, is_closed = ?, updated_at = datetime('now')
             WHERE location = 'Clubhouse' AND day_of_week = ?`
          ).bind(openTime, closeTime, isClosed, day).run();
        } else {
          await db?.prepare(
            `INSERT INTO opening_hours (location, period_name, day_of_week, open_time, close_time, is_closed, sort_order)
             VALUES ('Clubhouse', 'Standard', ?, ?, ?, ?, ?)`
          ).bind(day, openTime, closeTime, isClosed, day).run();
        }
      }
      message = 'Opening hours updated successfully';
      messageType = 'success';
    }
  } catch (e: any) {
    message = e.message || 'Failed to update opening hours';
    messageType = 'error';
  }
}

// Fetch current hours
if (db) {
  const result = await db.prepare(
    `SELECT * FROM opening_hours WHERE location = 'Clubhouse' ORDER BY day_of_week`
  ).all();
  hours = result.results || [];
}

// Create a map for easy lookup
const hoursByDay = new Map<number, any>();
for (const h of hours) {
  if (h.day_of_week !== null) {
    hoursByDay.set(h.day_of_week, h);
  }
}
---

<AdminLayout title="Opening Hours">
  <div class="card">
    <div class="card-header">
      <h3 class="card-title">Clubhouse Opening Hours</h3>
    </div>

    {message && (
      <div class={`alert alert-${messageType}`} style="margin-bottom: 1rem;">
        {message}
      </div>
    )}

    <form method="POST">
      <input type="hidden" name="action" value="update" />

      <table class="table">
        <thead>
          <tr>
            <th>Day</th>
            <th>Open</th>
            <th>Close</th>
            <th>Closed</th>
          </tr>
        </thead>
        <tbody>
          {[1, 2, 3, 4, 5, 6, 0].map(day => {
            const h = hoursByDay.get(day);
            const openTime = h?.open_time || '08:00';
            const closeTime = h?.close_time || '18:00';
            const isClosed = h?.is_closed || false;

            return (
              <tr>
                <td><strong>{DAY_NAMES[day]}</strong></td>
                <td>
                  <input
                    type="time"
                    name={`open_${day}`}
                    value={openTime}
                    class="form-input"
                    style="width: 130px;"
                  />
                </td>
                <td>
                  <input
                    type="text"
                    name={`close_${day}`}
                    value={closeTime}
                    class="form-input"
                    style="width: 130px;"
                    placeholder="e.g., 18:00 or Dusk"
                  />
                </td>
                <td>
                  <input
                    type="checkbox"
                    name={`closed_${day}`}
                    checked={isClosed}
                  />
                </td>
              </tr>
            );
          })}
        </tbody>
      </table>

      <div style="margin-top: 1.5rem;">
        <button type="submit" class="btn btn-primary">Save Changes</button>
      </div>
    </form>

    <div class="info-box" style="margin-top: 2rem;">
      <h4>Tips</h4>
      <ul>
        <li>Use 24-hour format for open times (e.g., 08:00, 14:30)</li>
        <li>Close time can be a time (e.g., 18:00) or text (e.g., "Dusk", "Late")</li>
        <li>Check "Closed" to mark a day as closed</li>
        <li>Changes will appear immediately on the public website</li>
      </ul>
    </div>
  </div>

  <style>
    .alert {
      padding: 1rem;
      border-radius: 8px;
    }
    .alert-success {
      background: #dcfce7;
      color: #166534;
    }
    .alert-error {
      background: #fee2e2;
      color: #991b1b;
    }
    .table {
      width: 100%;
      border-collapse: collapse;
    }
    .table th, .table td {
      padding: 0.75rem;
      text-align: left;
      border-bottom: 1px solid var(--border, #e0e0e0);
    }
    .table th {
      font-weight: 600;
      background: #f9f9f9;
    }
    .form-input {
      padding: 0.5rem;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 0.9rem;
    }
    .info-box {
      background: #f0f9ff;
      border: 1px solid #bae6fd;
      border-radius: 8px;
      padding: 1rem 1.5rem;
    }
    .info-box h4 {
      margin: 0 0 0.5rem 0;
      color: #0369a1;
    }
    .info-box ul {
      margin: 0;
      padding-left: 1.25rem;
      color: #0c4a6e;
    }
    .info-box li {
      margin-bottom: 0.25rem;
    }
  </style>
</AdminLayout>
