---
import AdminLayout from '../../layouts/AdminLayout.astro';

const db = Astro.locals.runtime.env.DB;
const userEmail = Astro.locals.user?.email?.toLowerCase() || '';
const BACKUP_ADMINS = ['admin@alnmouthvillage.golf', 'steve.lockley@alnmouthvillage.golf'];
const canBackup = BACKUP_ADMINS.includes(userEmail);

// Get all tables (excluding internal SQLite tables and FTS shadow tables)
const tablesResult = await db.prepare(
  `SELECT name FROM sqlite_master
   WHERE type='table'
   AND name NOT LIKE 'sqlite_%'
   AND name NOT LIKE '_cf_%'
   AND name NOT LIKE '%_fts_%'
   AND name NOT LIKE '%_content'
   AND name NOT LIKE '%_docsize'
   AND name NOT LIKE '%_data'
   AND name NOT LIKE '%_idx'
   AND name NOT LIKE '%_config'
   ORDER BY name`
).all();

const tables = tablesResult.results || [];

// Check for error message
const errorParam = Astro.url.searchParams.get('error');

// Get table info for each table
const tableInfo: Record<string, any> = {};
for (const table of tables) {
  const countResult = await db.prepare(`SELECT COUNT(*) as count FROM "${table.name}"`).first<{ count: number }>();
  const columnsResult = await db.prepare(`PRAGMA table_info("${table.name}")`).all();
  const indexesResult = await db.prepare(`PRAGMA index_list("${table.name}")`).all();

  tableInfo[table.name as string] = {
    count: countResult?.count || 0,
    columns: columnsResult.results || [],
    indexes: indexesResult.results || []
  };
}
---

<AdminLayout title="Database Explorer">
  <div class="card">
    <div class="card-header">
      <h3 class="card-title">Database Explorer</h3>
      <div style="display: flex; gap: 0.5rem;">
        {canBackup && (
          <button type="button" id="backup-btn" class="btn btn-secondary" onclick="runBackup()">
            Backup to SharePoint
          </button>
        )}
        <a href="/database/query" class="btn btn-primary">SQL Query</a>
      </div>
    </div>

    <div id="backup-result" style="display: none; padding: 0.75rem; border-radius: 4px; margin-bottom: 1rem;"></div>

    {errorParam === 'fts' && (
      <div style="background: #fff3cd; color: #856404; padding: 0.75rem; border-radius: 4px; margin-bottom: 1rem;">
        FTS (Full-Text Search) shadow tables cannot be browsed directly. They are internal SQLite structures.
      </div>
    )}

    <p style="color: #666; margin-bottom: 1.5rem;">
      Browse and manage your D1 SQLite database tables.
    </p>

    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>Table Name</th>
            <th>Rows</th>
            <th>Columns</th>
            <th>Indexes</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {tables.map((table) => (
            <tr>
              <td>
                <a href={`/database/table/${table.name}`} style="font-weight: 500;">
                  {table.name}
                </a>
              </td>
              <td>{tableInfo[table.name as string].count.toLocaleString()}</td>
              <td>{tableInfo[table.name as string].columns.length}</td>
              <td>{tableInfo[table.name as string].indexes.length}</td>
              <td>
                <a href={`/database/table/${table.name}`} class="btn btn-secondary btn-sm">Browse</a>
                <a href={`/database/table/${table.name}/structure`} class="btn btn-secondary btn-sm">Structure</a>
              </td>
            </tr>
          ))}
          {tables.length === 0 && (
            <tr>
              <td colspan="5" style="text-align: center; color: #666; padding: 2rem;">
                No tables found
              </td>
            </tr>
          )}
        </tbody>
      </table>
    </div>
  </div>

  <!-- Quick Stats -->
  <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-top: 1rem;">
    <div class="card" style="padding: 1rem;">
      <div style="font-size: 2rem; font-weight: bold; color: #2d5a27;">{tables.length}</div>
      <div style="color: #666;">Tables</div>
    </div>
    <div class="card" style="padding: 1rem;">
      <div style="font-size: 2rem; font-weight: bold; color: #2d5a27;">
        {Object.values(tableInfo).reduce((sum: number, t: any) => sum + t.count, 0).toLocaleString()}
      </div>
      <div style="color: #666;">Total Rows</div>
    </div>
    <div class="card" style="padding: 1rem;">
      <div style="font-size: 2rem; font-weight: bold; color: #2d5a27;">
        {Object.values(tableInfo).reduce((sum: number, t: any) => sum + t.indexes.length, 0)}
      </div>
      <div style="color: #666;">Indexes</div>
    </div>
  </div>

  {canBackup && (
    <script is:inline>
      async function runBackup() {
        const btn = document.getElementById('backup-btn');
        const resultDiv = document.getElementById('backup-result');

        btn.disabled = true;
        btn.textContent = 'Backing up...';
        resultDiv.style.display = 'block';
        resultDiv.style.background = '#e7f3ff';
        resultDiv.style.color = '#0066cc';
        resultDiv.textContent = 'Starting backup to SharePoint...';

        try {
          const response = await fetch('/api/backup', { method: 'POST' });
          const data = await response.json();

          if (data.success) {
            resultDiv.style.background = '#d4edda';
            resultDiv.style.color = '#155724';
            resultDiv.innerHTML = `<strong>Backup successful!</strong><br>
              File: ${data.filename}<br>
              Size: ${(data.size / 1024).toFixed(1)} KB<br>
              Time: ${new Date(data.timestamp).toLocaleString()}`;
          } else {
            throw new Error(data.error || 'Backup failed');
          }
        } catch (error) {
          resultDiv.style.background = '#f8d7da';
          resultDiv.style.color = '#721c24';
          resultDiv.textContent = 'Backup failed: ' + error.message;
        } finally {
          btn.disabled = false;
          btn.textContent = 'Backup to SharePoint';
        }
      }
    </script>
  )}
</AdminLayout>
