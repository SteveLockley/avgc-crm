---
import AdminLayout from '../../../../../layouts/AdminLayout.astro';

const { table, id } = Astro.params;
const db = Astro.locals.runtime.env.DB;

// Validate table exists
const tableCheck = await db.prepare(
  `SELECT name FROM sqlite_master WHERE type='table' AND name = ?`
).bind(table).first();

if (!tableCheck) {
  return Astro.redirect('/database');
}

// Get columns
const columnsResult = await db.prepare(`PRAGMA table_info("${table}")`).all();
const columns = columnsResult.results || [];
const primaryKey = columns.find((c: any) => c.pk === 1)?.name || 'rowid';

// Get current row data
const row = await db.prepare(
  `SELECT rowid, * FROM "${table}" WHERE "${primaryKey}" = ?`
).bind(id).first();

if (!row) {
  return Astro.redirect(`/database/table/${table}`);
}

let error = '';
let success = false;

// Handle form submission
if (Astro.request.method === 'POST') {
  const formData = await Astro.request.formData();

  try {
    const updates: string[] = [];
    const values: any[] = [];

    for (const col of columns) {
      const colName = (col as any).name;
      if (colName === primaryKey && (col as any).pk === 1) continue; // Skip primary key

      const rawValue = formData.get(colName);
      const isNull = formData.get(`${colName}_null`) === 'on';

      if (isNull) {
        updates.push(`"${colName}" = NULL`);
      } else if (rawValue !== null) {
        updates.push(`"${colName}" = ?`);
        values.push(rawValue);
      }
    }

    if (updates.length > 0) {
      values.push(id);
      await db.prepare(
        `UPDATE "${table}" SET ${updates.join(', ')} WHERE "${primaryKey}" = ?`
      ).bind(...values).run();
      success = true;
    }
  } catch (e: any) {
    error = e.message || 'Failed to update row';
  }

  // Refresh row data after update
  if (success) {
    const updatedRow = await db.prepare(
      `SELECT rowid, * FROM "${table}" WHERE "${primaryKey}" = ?`
    ).bind(id).first();
    if (updatedRow) {
      Object.assign(row, updatedRow);
    }
  }
}
---

<AdminLayout title={`Edit Row - ${table}`}>
  <div class="card">
    <div class="card-header">
      <h3 class="card-title">
        <a href="/database" style="color: #666; text-decoration: none;">&larr; Database</a>
        &nbsp;/&nbsp;
        <a href={`/database/table/${table}`} style="color: #666; text-decoration: none;">{table}</a>
        &nbsp;/&nbsp; Edit Row #{id}
      </h3>
    </div>

    {error && (
      <div style="background: #f8d7da; color: #721c24; padding: 0.75rem; border-radius: 4px; margin-bottom: 1rem;">
        {error}
      </div>
    )}

    {success && (
      <div style="background: #d4edda; color: #155724; padding: 0.75rem; border-radius: 4px; margin-bottom: 1rem;">
        Row updated successfully.
      </div>
    )}

    <form method="POST">
      <div style="display: flex; flex-direction: column; gap: 1rem;">
        {columns.map((col: any) => {
          const value = row[col.name];
          const isNull = value === null;
          const isPK = col.pk === 1;
          const isLargeText = col.type?.toUpperCase().includes('TEXT') && String(value || '').length > 100;

          return (
            <div class="form-group" style="margin-bottom: 0;">
              <label class="form-label" style="display: flex; align-items: center; gap: 0.5rem;">
                {col.name}
                {isPK && <span class="badge badge-success">PK</span>}
                {col.notnull && <span class="badge badge-warning">NOT NULL</span>}
                <span style="color: #999; font-weight: normal;">({col.type || 'TEXT'})</span>
              </label>

              <div style="display: flex; gap: 0.5rem; align-items: start;">
                {isLargeText ? (
                  <textarea
                    name={col.name}
                    class="form-input"
                    rows="4"
                    style="flex: 1;"
                    disabled={isPK}
                  >{isNull ? '' : String(value)}</textarea>
                ) : (
                  <input
                    type="text"
                    name={col.name}
                    class="form-input"
                    value={isNull ? '' : String(value)}
                    style="flex: 1;"
                    disabled={isPK}
                  />
                )}

                {!col.notnull && !isPK && (
                  <label style="display: flex; align-items: center; gap: 0.25rem; white-space: nowrap; padding: 0.5rem;">
                    <input type="checkbox" name={`${col.name}_null`} checked={isNull} />
                    NULL
                  </label>
                )}
              </div>
            </div>
          );
        })}
      </div>

      <div style="margin-top: 1.5rem; display: flex; gap: 0.5rem;">
        <button type="submit" class="btn btn-primary">Save Changes</button>
        <a href={`/database/table/${table}`} class="btn btn-secondary">Cancel</a>
      </div>
    </form>
  </div>
</AdminLayout>

<script>
  // When NULL checkbox is checked, disable the input
  document.querySelectorAll('input[type="checkbox"][name$="_null"]').forEach(checkbox => {
    const input = checkbox.closest('.form-group')?.querySelector('input[type="text"], textarea') as HTMLInputElement;
    if (input) {
      checkbox.addEventListener('change', (e) => {
        const checked = (e.target as HTMLInputElement).checked;
        input.disabled = checked;
        if (checked) input.value = '';
      });
      // Initial state
      if ((checkbox as HTMLInputElement).checked) {
        input.disabled = true;
      }
    }
  });
</script>
