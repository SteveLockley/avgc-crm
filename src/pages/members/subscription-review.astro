---
import AdminLayout from '../../layouts/AdminLayout.astro';
import { formatDate } from '../../lib/db';
import {
  reviewSubscriptionChanges,
  getApril1stOfCurrentYear,
  type MemberForSubscription,
  type SubscriptionChange
} from '../../lib/subscription-rules';

const db = Astro.locals.runtime.env.DB;

let changes: SubscriptionChange[] = [];
let appliedCount = 0;
let error = '';
let success = '';

// Get reference date info
const now = new Date();
const april1st = getApril1stOfCurrentYear(now);
const currentYear = now.getFullYear();

// Handle applying changes
if (Astro.request.method === 'POST') {
  const formData = await Astro.request.formData();
  const action = formData.get('action');

  if (action === 'apply') {
    // Get selected member IDs
    const selectedIds: number[] = [];
    for (const [key, value] of formData.entries()) {
      if (key.startsWith('member_') && value === 'on') {
        const id = parseInt(key.replace('member_', ''));
        if (!isNaN(id)) {
          selectedIds.push(id);
        }
      }
    }

    if (selectedIds.length === 0) {
      error = 'No members selected for update';
    } else {
      try {
        // Get the new subscription types from hidden fields
        const updates: { id: number; newSubscription: string }[] = [];
        for (const id of selectedIds) {
          const newSub = formData.get(`new_subscription_${id}`);
          if (newSub) {
            updates.push({ id, newSubscription: newSub.toString() });
          }
        }

        // Apply updates (category holds subscription type)
        for (const update of updates) {
          await db.prepare(
            `UPDATE members SET category = ?, updated_at = datetime('now') WHERE id = ?`
          ).bind(update.newSubscription, update.id).run();

          // Log the change
          await db.prepare(
            `INSERT INTO audit_log (user_email, action, entity_type, entity_id, details)
             VALUES (?, 'subscription_update', 'member', ?, ?)`
          ).bind(
            Astro.locals.user?.email || 'system',
            update.id,
            JSON.stringify({ newSubscription: update.newSubscription })
          ).run();

          appliedCount++;
        }

        success = `Successfully updated ${appliedCount} member subscription${appliedCount !== 1 ? 's' : ''}`;
      } catch (e: any) {
        error = `Failed to apply changes: ${e.message}`;
      }
    }
  }
}

// Get all members with relevant data (category holds subscription type)
const membersResult = await db.prepare(
  `SELECT id, first_name, surname, date_of_birth, date_joined, home_away, category
   FROM members
   WHERE category IS NULL
      OR (category NOT LIKE '%Social%'
      AND category NOT LIKE '%Twilight%'
      AND category NOT LIKE '%Out Of County%'
      AND category NOT LIKE '%Gratis%'
      AND category NOT LIKE '%Honorary%'
      AND category NOT LIKE '%Retention%'
      AND category NOT LIKE '%Resigned%')
   ORDER BY surname, first_name`
).all();

const members = (membersResult.results || []) as MemberForSubscription[];

// Review and get proposed changes
changes = reviewSubscriptionChanges(members);

// Group changes by type
const changesByType: Record<string, SubscriptionChange[]> = {};
for (const change of changes) {
  const key = `${change.currentSubscription || 'None'} → ${change.newSubscription}`;
  if (!changesByType[key]) {
    changesByType[key] = [];
  }
  changesByType[key].push(change);
}
---

<AdminLayout title="Subscription Review">
  <style>
    .summary-cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 1rem;
      margin-bottom: 1.5rem;
    }
    .summary-card {
      background: #fff;
      border-radius: 8px;
      padding: 1.25rem;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .summary-card h4 {
      font-size: 0.875rem;
      color: #666;
      margin: 0 0 0.5rem 0;
    }
    .summary-card .value {
      font-size: 1.75rem;
      font-weight: 700;
      color: #1e5631;
    }
    .change-group {
      margin-bottom: 1.5rem;
    }
    .change-group h4 {
      font-size: 0.875rem;
      padding: 0.5rem 0.75rem;
      background: #f4f4f4;
      border-radius: 4px;
      margin-bottom: 0.5rem;
    }
    .change-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.875rem;
    }
    .change-table th, .change-table td {
      padding: 0.5rem 0.75rem;
      text-align: left;
      border-bottom: 1px solid #eee;
    }
    .change-table th {
      background: #f9f9f9;
      font-weight: 600;
    }
    .change-table th:first-child {
      width: 40px;
    }
    .badge-change {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.75rem;
    }
    .badge-from {
      background: #f8d7da;
      color: #721c24;
      padding: 0.25rem 0.5rem;
      border-radius: 3px;
    }
    .badge-to {
      background: #d4edda;
      color: #155724;
      padding: 0.25rem 0.5rem;
      border-radius: 3px;
    }
    .badge-arrow {
      color: #666;
    }
    .info-box {
      background: #e7f3ff;
      border: 1px solid #b8daff;
      border-radius: 4px;
      padding: 1rem;
      margin-bottom: 1.5rem;
    }
    .info-box h4 {
      margin: 0 0 0.5rem 0;
      color: #004085;
    }
    .info-box ul {
      margin: 0;
      padding-left: 1.5rem;
      color: #004085;
    }
    .info-box li {
      margin-bottom: 0.25rem;
    }
    .select-all-row {
      background: #f9f9f9;
    }
  </style>

  <div style="display: flex; gap: 1rem; margin-bottom: 1.5rem;">
    <a href="/members" class="btn btn-secondary">&larr; Back to Members</a>
  </div>

  {error && <div class="alert alert-error">{error}</div>}
  {success && <div class="alert alert-success">{success}</div>}

  <div class="info-box">
    <h4>Subscription Rules (based on age on 1st April {currentYear})</h4>
    <ul>
      <li><strong>Junior → Intermediate:</strong> Member turns 18+ on 1st April</li>
      <li><strong>Intermediate → Under 30:</strong> Member turns 21+ on 1st April</li>
      <li><strong>Under 30 → Full:</strong> Member turns 30+ on 1st April</li>
      <li><strong>Full → Senior Loyalty:</strong> Member is 65+ years old AND has 25+ years of membership</li>
      <li><strong>Any → Over 80:</strong> Member turns 80+ on 1st April</li>
      <li><strong>Any → Life Member:</strong> Member reaches 50+ years of membership during the year</li>
    </ul>
    <p style="margin-top: 0.75rem; font-size: 0.875rem;">
      <strong>Reference date:</strong> 1st April {currentYear} ({formatDate(april1st.toISOString())})
    </p>
  </div>

  <div class="summary-cards">
    <div class="summary-card">
      <h4>Total Members Reviewed</h4>
      <div class="value">{members.length}</div>
    </div>
    <div class="summary-card">
      <h4>Changes Needed</h4>
      <div class="value" style={changes.length > 0 ? 'color: #856404;' : ''}>{changes.length}</div>
    </div>
    <div class="summary-card">
      <h4>Change Types</h4>
      <div class="value">{Object.keys(changesByType).length}</div>
    </div>
    {appliedCount > 0 && (
      <div class="summary-card">
        <h4>Just Applied</h4>
        <div class="value" style="color: #155724;">{appliedCount}</div>
      </div>
    )}
  </div>

  {changes.length === 0 ? (
    <div class="card">
      <div class="card-header">
        <h3 class="card-title">No Changes Required</h3>
      </div>
      <p style="color: #666;">
        All member subscriptions are up to date based on the current rules.
        No changes are needed at this time.
      </p>
    </div>
  ) : (
    <form method="POST">
      <input type="hidden" name="action" value="apply" />

      <div class="card">
        <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
          <h3 class="card-title">Proposed Subscription Changes ({changes.length})</h3>
          <button type="submit" class="btn btn-primary">Apply Selected Changes</button>
        </div>

        {Object.entries(changesByType).map(([changeType, groupChanges]) => (
          <div class="change-group">
            <h4>{changeType} ({groupChanges.length} member{groupChanges.length !== 1 ? 's' : ''})</h4>
            <table class="change-table">
              <thead>
                <tr>
                  <th>
                    <input
                      type="checkbox"
                      class="select-group"
                      data-group={changeType.replace(/[^a-zA-Z0-9]/g, '_')}
                      checked
                    />
                  </th>
                  <th>Member</th>
                  <th>Age on 1 Apr</th>
                  <th>Years Member</th>
                  <th>Reason</th>
                </tr>
              </thead>
              <tbody>
                {groupChanges.map(change => (
                  <tr>
                    <td>
                      <input
                        type="checkbox"
                        name={`member_${change.memberId}`}
                        class={`member-checkbox group-${changeType.replace(/[^a-zA-Z0-9]/g, '_')}`}
                        checked
                      />
                      <input
                        type="hidden"
                        name={`new_subscription_${change.memberId}`}
                        value={change.newSubscription}
                      />
                    </td>
                    <td>
                      <a href={`/members/${change.memberId}`}>{change.memberName}</a>
                    </td>
                    <td>{change.ageOnApril1 !== null ? change.ageOnApril1 : '-'}</td>
                    <td>{change.yearsOfMembership !== null ? change.yearsOfMembership : '-'}</td>
                    <td style="font-size: 0.75rem; color: #666;">{change.reason}</td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        ))}
      </div>

      <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 1rem;">
        <button type="submit" class="btn btn-primary">Apply Selected Changes</button>
      </div>
    </form>
  )}

  <script is:inline>
    // Handle select-all checkboxes for each group
    document.querySelectorAll('.select-group').forEach(checkbox => {
      checkbox.addEventListener('change', function() {
        const group = this.dataset.group;
        document.querySelectorAll(`.group-${group}`).forEach(cb => {
          cb.checked = this.checked;
        });
      });
    });

    // Update group checkbox when individual checkboxes change
    document.querySelectorAll('.member-checkbox').forEach(checkbox => {
      checkbox.addEventListener('change', function() {
        const classes = Array.from(this.classList);
        const groupClass = classes.find(c => c.startsWith('group-'));
        if (groupClass) {
          const group = groupClass.replace('group-', '');
          const groupCheckboxes = document.querySelectorAll(`.${groupClass}`);
          const groupSelectAll = document.querySelector(`.select-group[data-group="${group}"]`);
          if (groupSelectAll) {
            const allChecked = Array.from(groupCheckboxes).every(cb => cb.checked);
            const someChecked = Array.from(groupCheckboxes).some(cb => cb.checked);
            groupSelectAll.checked = allChecked;
            groupSelectAll.indeterminate = someChecked && !allChecked;
          }
        }
      });
    });
  </script>
</AdminLayout>
