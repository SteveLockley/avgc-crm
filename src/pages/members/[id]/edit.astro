---
import AdminLayout from '../../../layouts/AdminLayout.astro';
import { FEE_TEMPLATES, ZERO_COST_SUBSCRIPTIONS, PAYMENT_METHODS, AGE_GROUPS } from '../../../lib/db';

const { id } = Astro.params;
const db = Astro.locals.runtime.env.DB;

let error = '';
let success = '';

// Get member details
const member = await db.prepare(
  'SELECT * FROM members WHERE id = ?'
).bind(id).first();

if (!member) {
  return Astro.redirect('/members');
}

// Load subscription types from payment_items
const subscriptionTypesResult = await db.prepare(
  `SELECT name FROM payment_items WHERE category = 'Subscription' AND active = 1 ORDER BY name`
).all();
const subscriptionTypes = (subscriptionTypesResult.results || []).map((r: any) => r.name as string);

// Check if current category is a zero-cost subscription
const isZeroCostSubscription = (category: string | null): boolean => {
  if (!category) return false;
  return ZERO_COST_SUBSCRIPTIONS.some(zc => category === zc);
};

// Handle form submission
if (Astro.request.method === 'POST') {
  const formData = await Astro.request.formData();

  const updates: Record<string, any> = {};
  const fields = [
    'surname', 'first_name', 'middle_initials', 'title', 'gender', 'date_of_birth',
    'address_1', 'address_2', 'address_3', 'address_4', 'address_5',
    'telephone_1', 'telephone_2', 'telephone_3', 'email',
    'category', 'age_group', 'home_away', 'home_club', 'subscription_template',
    'handicap_index', 'national_id', 'national_id_country',
    'date_joined', 'date_renewed', 'date_expires', 'date_subscription_paid',
    'default_payment_method', 'account_balance', 'competition_fee_purse',
    'locker_number', 'additional_locker', 'send_invoice_by',
    'account_notes', 'notes', 'officer_title', 'pin', 'club_number',
    'electronic_communication_consent', 'parental_consent'
  ];

  for (const field of fields) {
    const value = formData.get(field);
    if (value !== null) {
      updates[field] = value === '' ? null : value;
    }
  }

  // Convert numeric fields
  if (updates.handicap_index) {
    updates.handicap_index = parseFloat(updates.handicap_index) || null;
  }
  if (updates.account_balance) {
    updates.account_balance = parseFloat(updates.account_balance) || 0;
  }
  if (updates.competition_fee_purse) {
    updates.competition_fee_purse = parseFloat(updates.competition_fee_purse) || 0;
  }

  // Build UPDATE query
  const setClauses = Object.keys(updates).map(k => `${k} = ?`).join(', ');
  const values = Object.values(updates);

  try {
    await db.prepare(
      `UPDATE members SET ${setClauses}, updated_at = datetime('now') WHERE id = ?`
    ).bind(...values, id).run();

    // Log the change
    await db.prepare(
      `INSERT INTO audit_log (user_email, action, entity_type, entity_id, details)
       VALUES (?, 'update', 'member', ?, ?)`
    ).bind(Astro.locals.user?.email || 'system', id, JSON.stringify(updates)).run();

    success = 'Member updated successfully';

    // Refresh member data
    const updatedMember = await db.prepare(
      'SELECT * FROM members WHERE id = ?'
    ).bind(id).first();
    if (updatedMember) {
      Object.assign(member, updatedMember);
    }
  } catch (e: any) {
    error = `Failed to update member: ${e.message}`;
  }
}

// Helper to format date for input
function formatDateForInput(dateStr: string | null): string {
  if (!dateStr) return '';
  try {
    // Handle DD/MM/YYYY format
    if (dateStr.includes('/')) {
      const [day, month, year] = dateStr.split('/');
      return `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
    }
    const date = new Date(dateStr);
    return date.toISOString().split('T')[0];
  } catch {
    return '';
  }
}
---

<AdminLayout title={`Edit ${member.first_name} ${member.surname}`}>
  <div style="display: flex; gap: 1rem; margin-bottom: 1.5rem;">
    <button type="button" onclick="history.back()" class="btn btn-secondary">&larr; Back</button>
  </div>

  {error && <div class="alert alert-error">{error}</div>}
  {success && <div class="alert alert-success">{success}</div>}

  <form method="POST">
    <div class="card">
      <div class="card-header">
        <h3 class="card-title">Personal Information</h3>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label class="form-label" for="title">Title</label>
          <select name="title" id="title" class="form-input">
            <option value="">-</option>
            {['Mr', 'Mrs', 'Ms', 'Miss', 'Dr', 'Prof'].map(t => (
              <option value={t} selected={member.title === t}>{t}</option>
            ))}
          </select>
        </div>
        <div class="form-group">
          <label class="form-label" for="first_name">First Name *</label>
          <input type="text" name="first_name" id="first_name" class="form-input" required value={member.first_name} />
        </div>
        <div class="form-group">
          <label class="form-label" for="middle_initials">Middle Initials</label>
          <input type="text" name="middle_initials" id="middle_initials" class="form-input" value={member.middle_initials || ''} />
        </div>
        <div class="form-group">
          <label class="form-label" for="surname">Surname *</label>
          <input type="text" name="surname" id="surname" class="form-input" required value={member.surname} />
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label class="form-label" for="gender">Gender</label>
          <select name="gender" id="gender" class="form-input">
            <option value="">-</option>
            <option value="M" selected={member.gender === 'M'}>Male</option>
            <option value="F" selected={member.gender === 'F'}>Female</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label" for="date_of_birth">Date of Birth</label>
          <input type="date" name="date_of_birth" id="date_of_birth" class="form-input"
                 value={formatDateForInput(member.date_of_birth as string)} />
        </div>
        <div class="form-group">
          <label class="form-label" for="age_group">Age Group</label>
          <select name="age_group" id="age_group" class="form-input">
            <option value="">-</option>
            {AGE_GROUPS.map(ag => (
              <option value={ag} selected={member.age_group === ag}>{ag}</option>
            ))}
          </select>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="card-header">
        <h3 class="card-title">Contact Information</h3>
      </div>

      <div class="form-group">
        <label class="form-label" for="email">Email</label>
        <input type="email" name="email" id="email" class="form-input" value={member.email || ''} />
      </div>

      <div class="form-row">
        <div class="form-group">
          <label class="form-label" for="telephone_1">Telephone 1</label>
          <input type="tel" name="telephone_1" id="telephone_1" class="form-input" value={member.telephone_1 || ''} />
        </div>
        <div class="form-group">
          <label class="form-label" for="telephone_2">Telephone 2</label>
          <input type="tel" name="telephone_2" id="telephone_2" class="form-input" value={member.telephone_2 || ''} />
        </div>
        <div class="form-group">
          <label class="form-label" for="telephone_3">Telephone 3</label>
          <input type="tel" name="telephone_3" id="telephone_3" class="form-input" value={member.telephone_3 || ''} />
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label class="form-label" for="address_1">Address Line 1</label>
          <input type="text" name="address_1" id="address_1" class="form-input" value={member.address_1 || ''} />
        </div>
        <div class="form-group">
          <label class="form-label" for="address_2">Address Line 2</label>
          <input type="text" name="address_2" id="address_2" class="form-input" value={member.address_2 || ''} />
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label class="form-label" for="address_3">Town/City</label>
          <input type="text" name="address_3" id="address_3" class="form-input" value={member.address_3 || ''} />
        </div>
        <div class="form-group">
          <label class="form-label" for="address_4">County</label>
          <input type="text" name="address_4" id="address_4" class="form-input" value={member.address_4 || ''} />
        </div>
        <div class="form-group">
          <label class="form-label" for="address_5">Postcode</label>
          <input type="text" name="address_5" id="address_5" class="form-input" value={member.address_5 || ''} />
        </div>
      </div>
    </div>

    <div class="card">
      <div class="card-header">
        <h3 class="card-title">Membership</h3>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label class="form-label" for="category">Subscription Type</label>
          <select name="category" id="category" class="form-input">
            <option value="">-</option>
            {subscriptionTypes.map(sub => (
              <option value={sub} selected={member.category === sub}>{sub}</option>
            ))}
          </select>
        </div>
        <div class="form-group" id="fee-template-group" style={isZeroCostSubscription(member.category as string) ? '' : 'display: none;'}>
          <label class="form-label" for="subscription_template">Fee Template</label>
          <select name="subscription_template" id="subscription_template" class="form-input">
            <option value="">-</option>
            {FEE_TEMPLATES.map(ft => (
              <option value={ft} selected={member.subscription_template === ft}>{ft}</option>
            ))}
          </select>
          <small style="color: #666;">For Life, Honorary, and Gratis members only</small>
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label class="form-label" for="home_away">Home/Away</label>
          <select name="home_away" id="home_away" class="form-input">
            <option value="">-</option>
            <option value="H" selected={member.home_away === 'H'}>Home</option>
            <option value="A" selected={member.home_away === 'A'}>Away</option>
            <option value="V" selected={member.home_away === 'V'}>Visitor</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label" for="home_club">Home Club</label>
          <input type="text" name="home_club" id="home_club" class="form-input"
                 value={member.home_club || 'Alnmouth Village'} />
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label class="form-label" for="date_joined">Date Joined</label>
          <input type="date" name="date_joined" id="date_joined" class="form-input"
                 value={formatDateForInput(member.date_joined as string)} />
        </div>
        <div class="form-group">
          <label class="form-label" for="date_renewed">Date Renewed</label>
          <input type="date" name="date_renewed" id="date_renewed" class="form-input"
                 value={formatDateForInput(member.date_renewed as string)} />
        </div>
        <div class="form-group">
          <label class="form-label" for="date_expires">Date Expires</label>
          <input type="date" name="date_expires" id="date_expires" class="form-input"
                 value={formatDateForInput(member.date_expires as string)} />
        </div>
        <div class="form-group">
          <label class="form-label" for="date_subscription_paid">Subscription Paid</label>
          <input type="date" name="date_subscription_paid" id="date_subscription_paid" class="form-input"
                 value={formatDateForInput(member.date_subscription_paid as string)} />
        </div>
      </div>
    </div>

    <div class="card">
      <div class="card-header">
        <h3 class="card-title">Golf/WHS</h3>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label class="form-label" for="handicap_index">Handicap Index</label>
          <input type="number" step="0.1" name="handicap_index" id="handicap_index" class="form-input"
                 value={member.handicap_index || ''} />
        </div>
        <div class="form-group">
          <label class="form-label" for="national_id">WHS National ID</label>
          <input type="text" name="national_id" id="national_id" class="form-input"
                 value={member.national_id || ''} />
        </div>
        <div class="form-group">
          <label class="form-label" for="national_id_country">Country</label>
          <input type="text" name="national_id_country" id="national_id_country" class="form-input"
                 value={member.national_id_country || 'England'} />
        </div>
      </div>
    </div>

    <div class="card">
      <div class="card-header">
        <h3 class="card-title">Financial</h3>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label class="form-label" for="default_payment_method">Payment Method</label>
          <select name="default_payment_method" id="default_payment_method" class="form-input">
            <option value="">-</option>
            {PAYMENT_METHODS.map(pm => (
              <option value={pm} selected={member.default_payment_method === pm}>{pm}</option>
            ))}
          </select>
        </div>
        <div class="form-group">
          <label class="form-label" for="account_balance">Account Balance (£)</label>
          <input type="number" step="0.01" name="account_balance" id="account_balance" class="form-input"
                 value={member.account_balance || 0} />
        </div>
        <div class="form-group">
          <label class="form-label" for="competition_fee_purse">Competition Fee Purse (£)</label>
          <input type="number" step="0.01" name="competition_fee_purse" id="competition_fee_purse" class="form-input"
                 value={member.competition_fee_purse || 0} />
        </div>
        <div class="form-group">
          <label class="form-label" for="send_invoice_by">Send Invoice By</label>
          <select name="send_invoice_by" id="send_invoice_by" class="form-input">
            <option value="Email" selected={member.send_invoice_by === 'Email'}>Email</option>
            <option value="Letter" selected={member.send_invoice_by === 'Letter'}>Letter</option>
          </select>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="card-header">
        <h3 class="card-title">Admin</h3>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label class="form-label" for="pin">PIN</label>
          <input type="text" name="pin" id="pin" class="form-input" value={member.pin || ''} />
        </div>
        <div class="form-group">
          <label class="form-label" for="club_number">Club Number</label>
          <input type="text" name="club_number" id="club_number" class="form-input" value={member.club_number || ''} />
        </div>
        <div class="form-group">
          <label class="form-label" for="locker_number">Locker Number</label>
          <input type="text" name="locker_number" id="locker_number" class="form-input" value={member.locker_number || ''} />
        </div>
        <div class="form-group">
          <label class="form-label" for="additional_locker">Additional Locker</label>
          <input type="text" name="additional_locker" id="additional_locker" class="form-input" value={member.additional_locker || ''} />
        </div>
      </div>

      <div class="form-group">
        <label class="form-label" for="officer_title">Officer Title</label>
        <input type="text" name="officer_title" id="officer_title" class="form-input"
               value={member.officer_title || 'Not on Committee'} />
      </div>
    </div>

    <div class="card">
      <div class="card-header">
        <h3 class="card-title">Consent/GDPR</h3>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label class="form-label" for="electronic_communication_consent">Electronic Communication</label>
          <select name="electronic_communication_consent" id="electronic_communication_consent" class="form-input">
            <option value="">-</option>
            <option value="Yes" selected={member.electronic_communication_consent === 'Yes'}>Yes</option>
            <option value="No" selected={member.electronic_communication_consent === 'No'}>No</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label" for="parental_consent">Parental Consent (Juniors)</label>
          <select name="parental_consent" id="parental_consent" class="form-input">
            <option value="">-</option>
            <option value="Yes" selected={member.parental_consent === 'Yes'}>Yes</option>
            <option value="No" selected={member.parental_consent === 'No'}>No</option>
          </select>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="card-header">
        <h3 class="card-title">Notes</h3>
      </div>

      <div class="form-group">
        <label class="form-label" for="account_notes">Account Notes</label>
        <textarea name="account_notes" id="account_notes" class="form-input" rows="3">{member.account_notes || ''}</textarea>
      </div>

      <div class="form-group">
        <label class="form-label" for="notes">General Notes</label>
        <textarea name="notes" id="notes" class="form-input" rows="3">{member.notes || ''}</textarea>
      </div>
    </div>

    <div style="display: flex; gap: 1rem; justify-content: flex-end;">
      <a href={`/members/${id}`} class="btn btn-secondary">Cancel</a>
      <button type="submit" class="btn btn-primary">Save Changes</button>
    </div>
  </form>

  <!-- M3 Unsaved Changes Dialog -->
  <div id="unsaved-dialog" class="m3-dialog-overlay" style="display: none;">
    <div class="m3-dialog">
      <div class="m3-dialog-icon">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z" fill="currentColor"/>
        </svg>
      </div>
      <h2 class="m3-dialog-title">Unsaved changes</h2>
      <p class="m3-dialog-content">You have unsaved changes. Are you sure you want to leave this page?</p>
      <div class="m3-dialog-actions">
        <button type="button" id="dialog-cancel" class="m3-btn m3-btn-text">Stay</button>
        <button type="button" id="dialog-confirm" class="m3-btn m3-btn-filled">Leave</button>
      </div>
    </div>
  </div>

  <style>
    .m3-dialog-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.32);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      animation: m3-fade-in 0.15s ease-out;
    }
    @keyframes m3-fade-in {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    .m3-dialog {
      background: #fff;
      border-radius: 28px;
      padding: 24px;
      min-width: 280px;
      max-width: 560px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.24);
      animation: m3-scale-in 0.2s ease-out;
    }
    @keyframes m3-scale-in {
      from { transform: scale(0.9); opacity: 0; }
      to { transform: scale(1); opacity: 1; }
    }
    .m3-dialog-icon {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      background: #fef3e0;
      color: #e65100;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 16px;
    }
    .m3-dialog-title {
      font-size: 1.5rem;
      font-weight: 500;
      margin: 0 0 16px 0;
      color: #1c1b1f;
    }
    .m3-dialog-content {
      font-size: 0.875rem;
      color: #49454f;
      margin: 0 0 24px 0;
      line-height: 1.5;
    }
    .m3-dialog-actions {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
    }
    .m3-btn {
      padding: 10px 24px;
      border-radius: 20px;
      font-size: 0.875rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      border: none;
    }
    .m3-btn-text {
      background: transparent;
      color: #1e5631;
    }
    .m3-btn-text:hover {
      background: rgba(30, 86, 49, 0.08);
    }
    .m3-btn-filled {
      background: #1e5631;
      color: #fff;
    }
    .m3-btn-filled:hover {
      background: #2d7a47;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
    }
  </style>

  <script is:inline define:vars={{ zeroCostSubscriptions: ZERO_COST_SUBSCRIPTIONS }}>
    // Show/hide fee template based on subscription type
    const categorySelect = document.getElementById('category');
    const feeTemplateGroup = document.getElementById('fee-template-group');
    const feeTemplateSelect = document.getElementById('subscription_template');

    function updateFeeTemplateVisibility() {
      const selectedCategory = categorySelect.value;
      const isZeroCost = zeroCostSubscriptions.includes(selectedCategory);

      if (isZeroCost) {
        feeTemplateGroup.style.display = '';
      } else {
        feeTemplateGroup.style.display = 'none';
        feeTemplateSelect.value = ''; // Clear fee template when not applicable
      }
    }

    categorySelect.addEventListener('change', updateFeeTemplateVisibility);

    // Unsaved changes detection
    const form = document.querySelector('form');
    const dialog = document.getElementById('unsaved-dialog');
    const dialogCancel = document.getElementById('dialog-cancel');
    const dialogConfirm = document.getElementById('dialog-confirm');
    let initialFormData = new FormData(form);
    let pendingNavigation = null;
    let formSubmitting = false;

    function getFormDataString(formData) {
      return Array.from(formData.entries())
        .map(([k, v]) => `${k}=${v}`)
        .sort()
        .join('&');
    }

    function hasUnsavedChanges() {
      const currentFormData = new FormData(form);
      return getFormDataString(initialFormData) !== getFormDataString(currentFormData);
    }

    function showDialog(callback) {
      pendingNavigation = callback;
      dialog.style.display = 'flex';
    }

    function hideDialog() {
      dialog.style.display = 'none';
      pendingNavigation = null;
    }

    dialogCancel.addEventListener('click', hideDialog);

    dialogConfirm.addEventListener('click', () => {
      hideDialog();
      if (pendingNavigation) {
        pendingNavigation();
      }
    });

    // Close dialog on overlay click
    dialog.addEventListener('click', (e) => {
      if (e.target === dialog) {
        hideDialog();
      }
    });

    // Close dialog on Escape key
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && dialog.style.display === 'flex') {
        hideDialog();
      }
    });

    // Mark form as submitting to allow navigation
    form.addEventListener('submit', () => {
      formSubmitting = true;
    });

    // Intercept link clicks
    document.addEventListener('click', (e) => {
      const link = e.target.closest('a[href]');
      if (link && !formSubmitting && hasUnsavedChanges()) {
        e.preventDefault();
        showDialog(() => {
          window.location.href = link.href;
        });
      }
    });

    // Intercept back button clicks
    document.addEventListener('click', (e) => {
      const btn = e.target.closest('button[onclick*="history.back"]');
      if (btn && !formSubmitting && hasUnsavedChanges()) {
        e.preventDefault();
        e.stopPropagation();
        showDialog(() => {
          history.back();
        });
      }
    }, true);

    // Intercept browser back/forward and refresh
    window.addEventListener('beforeunload', (e) => {
      if (!formSubmitting && hasUnsavedChanges()) {
        e.preventDefault();
        e.returnValue = '';
        return '';
      }
    });

    // Reset initial form data after successful save (page reload with success message)
    if (document.querySelector('.alert-success')) {
      initialFormData = new FormData(form);
    }
  </script>
</AdminLayout>
