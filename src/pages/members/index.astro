---
import AdminLayout from '../../layouts/AdminLayout.astro';
import { formatDate, isExpired, expiresSoon, EGU_CATEGORIES, calculateEguCategory, type Member } from '../../lib/db';

const db = Astro.locals.runtime.env.DB;

// Get query parameters
const url = Astro.url;
const search = url.searchParams.get('search') || '';
const subscriptionType = url.searchParams.get('subscription_type') || '';
const eguCategory = url.searchParams.get('egu_category') || '';
const filter = url.searchParams.get('filter') || '';
const page = parseInt(url.searchParams.get('page') || '1');
const perPage = 25;
const offset = (page - 1) * perPage;

// Load subscription types from payment_items
const subscriptionTypesResult = await db.prepare(
  `SELECT name FROM payment_items WHERE category = 'Subscription' AND active = 1 ORDER BY name`
).all();
const subscriptionTypes = (subscriptionTypesResult.results || []).map((r: any) => r.name as string);

// For EGU category filtering, we need to get all members and filter in code
// because EGU category is calculated, not stored
let filteredByEgu = false;
let eguFilteredIds: number[] = [];

if (eguCategory) {
  filteredByEgu = true;
  // Get all members with required fields for EGU calculation
  const allMembers = await db.prepare(
    `SELECT id, gender, date_of_birth, home_away, home_club
     FROM members
     WHERE category IS NOT NULL AND category != ''`
  ).all();

  eguFilteredIds = (allMembers.results || [])
    .filter((m: any) => calculateEguCategory(m as Pick<Member, 'gender' | 'date_of_birth' | 'home_away' | 'home_club'>) === eguCategory)
    .map((m: any) => m.id);
}

// Build query
let whereClause = '1=1';
const params: any[] = [];

if (search) {
  whereClause += ` AND (
    surname LIKE ? OR
    first_name LIKE ? OR
    email LIKE ?
  )`;
  const searchTerm = `%${search}%`;
  params.push(searchTerm, searchTerm, searchTerm);
}

if (subscriptionType) {
  whereClause += ' AND category = ?';
  params.push(subscriptionType);
}

if (filter === 'expiring') {
  whereClause += ` AND date_expires BETWEEN date('now') AND date('now', '+30 days')`;
} else if (filter === 'expired') {
  whereClause += ` AND date_expires < date('now')`;
} else if (filter === 'active') {
  whereClause += ` AND (date_expires >= date('now') OR date_expires IS NULL)`;
}

if (filteredByEgu && eguFilteredIds.length > 0) {
  const placeholders = eguFilteredIds.map(() => '?').join(',');
  whereClause += ` AND id IN (${placeholders})`;
  params.push(...eguFilteredIds);
} else if (filteredByEgu && eguFilteredIds.length === 0) {
  // No members match the EGU category
  whereClause += ' AND 1=0';
}

// Get total count
const countResult = await db.prepare(
  `SELECT COUNT(*) as count FROM members WHERE ${whereClause}`
).bind(...params).first<{ count: number }>();
const totalCount = countResult?.count || 0;
const totalPages = Math.ceil(totalCount / perPage);

// Get members
const members = await db.prepare(
  `SELECT id, surname, first_name, email, category, home_away, handicap_index,
          date_expires, date_joined, default_payment_method, account_balance, subscription_template
   FROM members
   WHERE ${whereClause}
   ORDER BY surname, first_name
   LIMIT ? OFFSET ?`
).bind(...params, perPage, offset).all();

// Calculate pagination pages
const paginationPages: number[] = [];
const maxPagesToShow = 7;
if (totalPages <= maxPagesToShow) {
  for (let i = 1; i <= totalPages; i++) paginationPages.push(i);
} else if (page <= 4) {
  for (let i = 1; i <= maxPagesToShow; i++) paginationPages.push(i);
} else if (page >= totalPages - 3) {
  for (let i = totalPages - 6; i <= totalPages; i++) paginationPages.push(i);
} else {
  for (let i = page - 3; i <= page + 3; i++) paginationPages.push(i);
}

// Build query string for pagination links
function buildQueryString(pageNum: number): string {
  const params = new URLSearchParams();
  if (search) params.set('search', search);
  if (subscriptionType) params.set('subscription_type', subscriptionType);
  if (eguCategory) params.set('egu_category', eguCategory);
  if (filter) params.set('filter', filter);
  params.set('page', String(pageNum));
  return `?${params.toString()}`;
}

// Build query string for export/email links (without page)
function buildFilterQueryString(): string {
  const params = new URLSearchParams();
  if (search) params.set('search', search);
  if (subscriptionType) params.set('subscription_type', subscriptionType);
  if (eguCategory) params.set('egu_category', eguCategory);
  if (filter) params.set('filter', filter);
  return params.toString() ? `?${params.toString()}` : '';
}
---

<AdminLayout title="Members">
  <div class="card">
    <div class="card-header">
      <h3 class="card-title">Member List ({totalCount} members)</h3>
      <div style="display: flex; gap: 0.5rem;">
        <a href="/members/subscription-review" class="btn btn-secondary">Subscription Review</a>
        <a href="/members/direct-debit" class="btn btn-secondary">DD Consolidation</a>
        <a href="/members/brs" class="btn btn-secondary">BRS Consolidation</a>
        <a href="/members/egu" class="btn btn-secondary">EGU Consolidation</a>
        <a href="/members/import" class="btn btn-secondary">Import</a>
        <a href={`/members/export${buildFilterQueryString()}`} class="btn btn-secondary">Export</a>
        <a href={`/members/email${buildFilterQueryString()}`} class="btn btn-secondary">Email All</a>
        <a href="/members/new" class="btn btn-primary">Add Member</a>
      </div>
    </div>

    <!-- Filters -->
    <form method="GET" class="filters" style="margin-bottom: 1rem;">
      <div style="display: flex; gap: 1rem; flex-wrap: wrap; align-items: end;">
        <div class="form-group" style="margin-bottom: 0; flex: 1; min-width: 150px;">
          <label class="form-label">Search</label>
          <input
            type="text"
            name="search"
            class="form-input"
            placeholder="Name or email..."
            value={search}
          />
        </div>

        <div class="form-group" style="margin-bottom: 0;">
          <label class="form-label">Subscription Type</label>
          <select name="subscription_type" class="form-input">
            <option value="">All Types</option>
            {subscriptionTypes.map(st => (
              <option value={st} selected={subscriptionType === st}>{st}</option>
            ))}
          </select>
        </div>

        <div class="form-group" style="margin-bottom: 0;">
          <label class="form-label">EGU Category</label>
          <select name="egu_category" class="form-input">
            <option value="">All EGU Categories</option>
            {EGU_CATEGORIES.map(cat => (
              <option value={cat} selected={eguCategory === cat}>{cat}</option>
            ))}
          </select>
        </div>

        <div class="form-group" style="margin-bottom: 0;">
          <label class="form-label">Status</label>
          <select name="filter" class="form-input">
            <option value="">All Statuses</option>
            <option value="active" selected={filter === 'active'}>Active</option>
            <option value="expiring" selected={filter === 'expiring'}>Expiring Soon</option>
            <option value="expired" selected={filter === 'expired'}>Expired</option>
          </select>
        </div>

        <button type="submit" class="btn btn-primary">Search</button>
        <a href="/members" class="btn btn-secondary">Clear</a>
      </div>
    </form>

    <!-- Active filters display -->
    {(subscriptionType || eguCategory || filter || search) && (
      <div style="margin-bottom: 1rem; padding: 0.5rem 1rem; background: #e8f4e8; border-radius: 4px; font-size: 0.875rem;">
        <strong>Active filters:</strong>
        {search && <span class="badge badge-info" style="margin-left: 0.5rem;">Search: {search}</span>}
        {subscriptionType && <span class="badge badge-info" style="margin-left: 0.5rem;">Type: {subscriptionType}</span>}
        {eguCategory && <span class="badge badge-info" style="margin-left: 0.5rem;">EGU: {eguCategory}</span>}
        {filter && <span class="badge badge-info" style="margin-left: 0.5rem;">Status: {filter}</span>}
      </div>
    )}

    <!-- Members table -->
    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>Name</th>
            <th>Subscription Type</th>
            <th>H/A</th>
            <th>Handicap</th>
            <th>Expires</th>
            <th>Payment Method</th>
            <th>Balance</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {members.results?.map((member) => (
              <tr>
                <td>
                  <a href={`/members/${member.id}`} style="font-weight: 500;">
                    {member.surname}, {member.first_name}
                  </a>
                  {member.email && (
                    <div style="font-size: 0.75rem; color: #666;">{member.email}</div>
                  )}
                </td>
                <td style="font-size: 0.875rem;">
                  {member.category || '-'}
                  {member.subscription_template && (
                    <div style="font-size: 0.7rem; color: #888;">{member.subscription_template}</div>
                  )}
                </td>
                <td>
                  <span class={`badge ${member.home_away === 'H' ? 'badge-success' : 'badge-info'}`}>
                    {member.home_away || '-'}
                  </span>
                </td>
                <td>{member.handicap_index ?? '-'}</td>
                <td>
                  {member.date_expires ? (
                    <span class={`badge ${isExpired(member.date_expires as string) ? 'badge-danger' : expiresSoon(member.date_expires as string) ? 'badge-warning' : 'badge-success'}`}>
                      {formatDate(member.date_expires as string)}
                    </span>
                  ) : '-'}
                </td>
                <td style="font-size: 0.875rem;">{member.default_payment_method || '-'}</td>
                <td style={`font-weight: 500; ${(member.account_balance as number) < 0 ? 'color: #dc3545' : ''}`}>
                  {member.account_balance !== 0 ? `Â£${member.account_balance}` : '-'}
                </td>
                <td>
                  <a href={`/members/${member.id}`} class="btn btn-secondary btn-sm">View</a>
                  <a href={`/members/${member.id}/edit`} class="btn btn-secondary btn-sm">Edit</a>
                </td>
              </tr>
            ))}
          {(!members.results || members.results.length === 0) && (
            <tr>
              <td colspan="8" style="text-align: center; color: #666; padding: 2rem;">
                No members found
              </td>
            </tr>
          )}
        </tbody>
      </table>
    </div>

    <!-- Pagination -->
    {totalPages > 1 && (
      <div class="pagination">
        {page > 1 && (
          <a href={buildQueryString(page - 1)}>
            Previous
          </a>
        )}

        {paginationPages.map((p) => (
          <a
            href={buildQueryString(p)}
            class={p === page ? 'active' : ''}
          >
            {p}
          </a>
        ))}

        {page < totalPages && (
          <a href={buildQueryString(page + 1)}>
            Next
          </a>
        )}
      </div>
    )}
  </div>

</AdminLayout>
