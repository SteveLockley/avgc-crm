---
// CSV Export endpoint - exports in HandicapMaster compatible format
import { calculateEguCategory, type Member } from '../../lib/db';

const db = Astro.locals.runtime.env.DB;

// Get filter parameters (same as index page)
const url = Astro.url;
const search = url.searchParams.get('search') || '';
const subscriptionType = url.searchParams.get('subscription_type') || '';
const eguCategory = url.searchParams.get('egu_category') || '';
const filter = url.searchParams.get('filter') || '';

// For EGU category filtering, we need to get all members and filter in code
let filteredByEgu = false;
let eguFilteredIds: number[] = [];

if (eguCategory) {
  filteredByEgu = true;
  const allMembers = await db.prepare(
    `SELECT id, gender, date_of_birth, home_away, home_club
     FROM members
     WHERE category IS NOT NULL AND category != ''`
  ).all();

  eguFilteredIds = (allMembers.results || [])
    .filter((m: any) => calculateEguCategory(m as Pick<Member, 'gender' | 'date_of_birth' | 'home_away' | 'home_club'>) === eguCategory)
    .map((m: any) => m.id);
}

// Build query with filters
let whereClause = '1=1';
const params: any[] = [];

if (search) {
  whereClause += ` AND (
    surname LIKE ? OR
    first_name LIKE ? OR
    email LIKE ?
  )`;
  const searchTerm = `%${search}%`;
  params.push(searchTerm, searchTerm, searchTerm);
}

if (subscriptionType) {
  whereClause += ' AND category = ?';
  params.push(subscriptionType);
}

if (filter === 'expiring') {
  whereClause += ` AND date_expires BETWEEN date('now') AND date('now', '+30 days')`;
} else if (filter === 'expired') {
  whereClause += ` AND date_expires < date('now')`;
} else if (filter === 'active') {
  whereClause += ` AND (date_expires >= date('now') OR date_expires IS NULL)`;
}

if (filteredByEgu && eguFilteredIds.length > 0) {
  const placeholders = eguFilteredIds.map(() => '?').join(',');
  whereClause += ` AND id IN (${placeholders})`;
  params.push(...eguFilteredIds);
} else if (filteredByEgu && eguFilteredIds.length === 0) {
  whereClause += ' AND 1=0';
}

// Get filtered members
const members = await db.prepare(
  `SELECT * FROM members WHERE ${whereClause} ORDER BY surname, first_name`
).bind(...params).all();

if (!members.results || members.results.length === 0) {
  return new Response('No members to export', { status: 404 });
}

// Define CSV columns - HandicapMaster compatible format
// Only include fields that HandicapMaster supports
const columns = [
  'Surname',
  'Middle Initials',
  'First Name',
  'Gender',
  'Age Group',
  'Handicap Index',
  'Home/Away/Visitor',
  'Home Club',
  'PIN',
  'Title',
  'Address 1',
  'Address 2',
  'Address 3',
  'Address 4',
  'Address 5',
  'Telephone 1',
  'Telephone 2',
  'Telephone 3',
  'E-Mail Address',
  'Club Number',
  'Category',
  'Officer Title',
  'Date Joined',
  'Date Renewed',
  'Date Expires',
  'Date Subscription Paid',
  'National ID Country',
  'National ID',
  'Card Number',
  'Date of Birth',
  'Locker Number',
  'Default Payment Method',
  'Send Invoice By',
  'Account Notes',
  'DD Account Name',
  'DD Account Number',
  'DD Sort Code',
  'DD Reference',
  'DD New Instruction Set Up',
  'Notes',
  'Electronic Communication Consent',
  'Date Communication Consent Changed',
  'Parental Consent',
  'Data Protection Notes',
  'Account ID'
];

// Format date from YYYY-MM-DD to DD/MM/YYYY (HandicapMaster format)
function formatDate(dateStr: string | null): string {
  if (!dateStr) return '';
  // Handle ISO date format YYYY-MM-DD
  const match = dateStr.match(/^(\d{4})-(\d{2})-(\d{2})/);
  if (match) {
    const [, year, month, day] = match;
    return `${day}/${month}/${year}`;
  }
  return dateStr;
}

// Format boolean to Yes/No
function formatBoolean(value: string | number | null | undefined): string {
  if (value === null || value === undefined || value === '') return '';
  if (value === 1 || value === '1' || value === true ||
      String(value).toLowerCase() === 'yes' || String(value).toLowerCase() === 'y') {
    return 'Yes';
  }
  if (value === 0 || value === '0' || value === false ||
      String(value).toLowerCase() === 'no' || String(value).toLowerCase() === 'n') {
    return 'No';
  }
  return String(value);
}

// Format Send Invoice By to Letter/Email
function formatSendInvoiceBy(value: string | null): string {
  if (!value) return '';
  const lower = value.toLowerCase();
  if (lower === 'email' || lower === 'e-mail' || lower === 'e' || lower === 'em') {
    return 'Email';
  }
  if (lower === 'letter' || lower === 'l' || lower === 'post') {
    return 'Letter';
  }
  return value;
}

// Sanitize text - remove newlines and carriage returns (HandicapMaster requirement)
function sanitizeText(value: string | null): string {
  if (!value) return '';
  // Replace newlines with space, trim, and limit to 4096 chars for notes fields
  return value.replace(/[\r\n]+/g, ' ').trim();
}

// Format account balance - HandicapMaster expects numeric format
function formatCurrency(value: number | string | null): string {
  if (value === null || value === undefined) return '0.00';
  const num = typeof value === 'string' ? parseFloat(value) : value;
  if (isNaN(num)) return '0.00';
  return num.toFixed(2);
}

// Map database fields to CSV columns
function mapMemberToRow(m: any): string[] {
  return [
    sanitizeText(m.surname) || '',
    sanitizeText(m.middle_initials) || '',
    sanitizeText(m.first_name) || '',
    m.gender || '',
    m.age_group || '',
    m.handicap_index !== null && m.handicap_index !== undefined ? m.handicap_index.toString() : '',
    m.home_away || 'H',
    sanitizeText(m.home_club) || 'Alnmouth Village',
    m.pin || '',
    m.title || '',
    sanitizeText(m.address_1) || '',
    sanitizeText(m.address_2) || '',
    sanitizeText(m.address_3) || '',
    sanitizeText(m.address_4) || '',
    sanitizeText(m.address_5) || '',
    m.telephone_1 || '',
    m.telephone_2 || '',
    m.telephone_3 || '',
    m.email || '',
    m.club_number || '',
    m.category || '',
    m.officer_title || 'Not on Committee',
    formatDate(m.date_joined),
    formatDate(m.date_renewed),
    formatDate(m.date_expires),
    formatDate(m.date_subscription_paid),
    m.national_id_country || '',
    m.national_id || '',
    m.card_number || '',
    formatDate(m.date_of_birth),
    m.locker_number || '',
    m.default_payment_method || '',
    formatSendInvoiceBy(m.send_invoice_by),
    sanitizeText(m.account_notes)?.substring(0, 4096) || '',
    sanitizeText(m.dd_account_name)?.substring(0, 20) || '',
    m.dd_account_number || '',
    m.dd_sort_code || '',
    sanitizeText(m.dd_reference)?.substring(0, 18) || '',
    formatBoolean(m.dd_new_instruction_set_up),
    sanitizeText(m.notes)?.substring(0, 4096) || '',
    formatBoolean(m.electronic_communication_consent),
    formatDate(m.date_communication_consent_changed),
    formatBoolean(m.parental_consent),
    sanitizeText(m.data_protection_notes)?.substring(0, 4096) || '',
    m.account_id || ''
  ];
}

// Escape CSV values - enclose in quotes if contains comma, quote, or special chars
function escapeCSV(value: string): string {
  // Always escape if contains comma, quote, or could cause issues
  if (value.includes(',') || value.includes('"') || value.includes('\n') || value.includes('\r')) {
    return `"${value.replace(/"/g, '""')}"`;
  }
  return value;
}

// Build CSV content - ASCII text
let csv = columns.join(',') + '\r\n';

for (const member of members.results) {
  const row = mapMemberToRow(member).map(escapeCSV);
  csv += row.join(',') + '\r\n';
}

// Build filename with filter info
let filenameParts = ['AVGC_Members_Export'];
if (subscriptionType) filenameParts.push(subscriptionType.replace(/\s+/g, '_'));
if (filter) filenameParts.push(filter);
if (eguCategory) filenameParts.push('EGU');
filenameParts.push(new Date().toISOString().split('T')[0]);
const filename = filenameParts.join('_') + '.csv';

return new Response(csv, {
  headers: {
    'Content-Type': 'text/csv; charset=ascii',
    'Content-Disposition': `attachment; filename="${filename}"`
  }
});
---
