---
// CSV Export endpoint - respects active filters
import { calculateEguCategory, type Member } from '../../lib/db';

const db = Astro.locals.runtime.env.DB;

// Get filter parameters (same as index page)
const url = Astro.url;
const search = url.searchParams.get('search') || '';
const subscriptionType = url.searchParams.get('subscription_type') || '';
const eguCategory = url.searchParams.get('egu_category') || '';
const filter = url.searchParams.get('filter') || '';

// For EGU category filtering, we need to get all members and filter in code
let filteredByEgu = false;
let eguFilteredIds: number[] = [];

if (eguCategory) {
  filteredByEgu = true;
  const allMembers = await db.prepare(
    `SELECT id, gender, date_of_birth, home_away, home_club
     FROM members
     WHERE category IS NOT NULL AND category != ''`
  ).all();

  eguFilteredIds = (allMembers.results || [])
    .filter((m: any) => calculateEguCategory(m as Pick<Member, 'gender' | 'date_of_birth' | 'home_away' | 'home_club'>) === eguCategory)
    .map((m: any) => m.id);
}

// Build query with filters
let whereClause = '1=1';
const params: any[] = [];

if (search) {
  whereClause += ` AND (
    surname LIKE ? OR
    first_name LIKE ? OR
    email LIKE ?
  )`;
  const searchTerm = `%${search}%`;
  params.push(searchTerm, searchTerm, searchTerm);
}

if (subscriptionType) {
  whereClause += ' AND category = ?';
  params.push(subscriptionType);
}

if (filter === 'expiring') {
  whereClause += ` AND date_expires BETWEEN date('now') AND date('now', '+30 days')`;
} else if (filter === 'expired') {
  whereClause += ` AND date_expires < date('now')`;
} else if (filter === 'active') {
  whereClause += ` AND (date_expires >= date('now') OR date_expires IS NULL)`;
}

if (filteredByEgu && eguFilteredIds.length > 0) {
  const placeholders = eguFilteredIds.map(() => '?').join(',');
  whereClause += ` AND id IN (${placeholders})`;
  params.push(...eguFilteredIds);
} else if (filteredByEgu && eguFilteredIds.length === 0) {
  whereClause += ' AND 1=0';
}

// Get filtered members
const members = await db.prepare(
  `SELECT * FROM members WHERE ${whereClause} ORDER BY surname, first_name`
).bind(...params).all();

if (!members.results || members.results.length === 0) {
  return new Response('No members to export', { status: 404 });
}

// Define CSV columns (matching original export format)
const columns = [
  'SURNAME', 'MIDDLE INITIALS', 'FIRST NAME', 'GENDER', 'AGE GROUP',
  'HANDICAP INDEX', 'HOME/AWAY/VISITOR', 'HOME CLUB', 'PIN', 'TITLE',
  'ADDRESS 1', 'ADDRESS 2', 'ADDRESS 3', 'ADDRESS 4', 'ADDRESS 5',
  'TELEPHONE 1', 'TELEPHONE 2', 'TELEPHONE 3', 'E-MAIL ADDRESS',
  'CLUB NUMBER', 'CATEGORY', 'OFFICER TITLE',
  'DATE JOINED', 'DATE RENEWED', 'DATE EXPIRES', 'DATE SUBSCRIPTION PAID',
  'NATIONAL ID COUNTRY', 'NATIONAL ID', 'CARD NUMBER', 'DATE OF BIRTH',
  'LOCKER NUMBER', 'DEFAULT PAYMENT METHOD', 'SUBSCRIPTION TEMPLATE',
  'ACCOUNT BALANCE', 'ACCOUNT NOTES', 'SEND INVOICE BY', 'COMPETITION FEE PURSE',
  'NOTES', 'ELECTRONIC COMMUNICATION CONSENT', 'DATE COMMUNICATION CONSENT CHANGED',
  'PARENTAL CONSENT', 'DATA PROTECTION NOTES', 'ADDITIONAL LOCKER',
  'USER FIELD 2', 'USER FIELD 3', 'ACCOUNT ID'
];

// Map database fields to CSV columns
function mapMemberToRow(m: any): string[] {
  return [
    m.surname || '',
    m.middle_initials || '',
    m.first_name || '',
    m.gender || '',
    m.age_group || '',
    m.handicap_index?.toString() || '',
    m.home_away || '',
    m.home_club || '',
    m.pin || '',
    m.title || '',
    m.address_1 || '',
    m.address_2 || '',
    m.address_3 || '',
    m.address_4 || '',
    m.address_5 || '',
    m.telephone_1 || '',
    m.telephone_2 || '',
    m.telephone_3 || '',
    m.email || '',
    m.club_number || '',
    m.category || '',
    m.officer_title || '',
    m.date_joined || '',
    m.date_renewed || '',
    m.date_expires || '',
    m.date_subscription_paid || '',
    m.national_id_country || '',
    m.national_id || '',
    m.card_number || '',
    m.date_of_birth || '',
    m.locker_number || '',
    m.default_payment_method || '',
    m.subscription_template || '',
    m.account_balance?.toString() || '0',
    m.account_notes || '',
    m.send_invoice_by || '',
    m.competition_fee_purse?.toString() || '0',
    m.notes || '',
    m.electronic_communication_consent || '',
    m.date_communication_consent_changed || '',
    m.parental_consent || '',
    m.data_protection_notes || '',
    m.additional_locker || '',
    m.user_field_2 || '',
    m.user_field_3 || '',
    m.account_id || ''
  ];
}

// Escape CSV values
function escapeCSV(value: string): string {
  if (value.includes(',') || value.includes('"') || value.includes('\n')) {
    return `"${value.replace(/"/g, '""')}"`;
  }
  return value;
}

// Build CSV content
let csv = columns.join(',') + '\n';

for (const member of members.results) {
  const row = mapMemberToRow(member).map(escapeCSV);
  csv += row.join(',') + '\n';
}

// Build filename with filter info
let filenameParts = ['AVGC_Members'];
if (subscriptionType) filenameParts.push(subscriptionType.replace(/\s+/g, '_'));
if (filter) filenameParts.push(filter);
if (eguCategory) filenameParts.push('EGU');
filenameParts.push(new Date().toISOString().split('T')[0]);
const filename = filenameParts.join('_') + '.csv';

return new Response(csv, {
  headers: {
    'Content-Type': 'text/csv; charset=utf-8',
    'Content-Disposition': `attachment; filename="${filename}"`
  }
});
---
