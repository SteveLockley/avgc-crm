---
import AdminLayout from '../../layouts/AdminLayout.astro';

const db = Astro.locals.runtime.env.DB;

let error = '';
let success = '';
let importedCount = 0;
let skippedCount = 0;

if (Astro.request.method === 'POST') {
  const formData = await Astro.request.formData();
  const file = formData.get('csvfile') as File;
  const mode = formData.get('mode') || 'skip'; // skip, update, replace

  if (!file || file.size === 0) {
    error = 'Please select a CSV file to import';
  } else {
    try {
      const text = await file.text();
      const lines = text.split('\n').filter(line => line.trim());

      if (lines.length < 2) {
        error = 'CSV file appears to be empty';
      } else {
        // Parse header
        const header = parseCSVLine(lines[0]);

        // Map CSV columns to database fields
        const columnMap: Record<string, string> = {
          'SURNAME': 'surname',
          'MIDDLE INITIALS': 'middle_initials',
          'FIRST NAME': 'first_name',
          'GENDER': 'gender',
          'AGE GROUP': 'age_group',
          'HANDICAP INDEX': 'handicap_index',
          'HOME/AWAY/VISITOR': 'home_away',
          'HOME CLUB': 'home_club',
          'PIN': 'pin',
          'TITLE': 'title',
          'ADDRESS 1': 'address_1',
          'ADDRESS 2': 'address_2',
          'ADDRESS 3': 'address_3',
          'ADDRESS 4': 'address_4',
          'ADDRESS 5': 'address_5',
          'TELEPHONE 1': 'telephone_1',
          'TELEPHONE 2': 'telephone_2',
          'TELEPHONE 3': 'telephone_3',
          'E-MAIL ADDRESS': 'email',
          'CLUB NUMBER': 'club_number',
          'CATEGORY': 'category',
          'OFFICER TITLE': 'officer_title',
          'DATE JOINED': 'date_joined',
          'DATE RENEWED': 'date_renewed',
          'DATE EXPIRES': 'date_expires',
          'DATE SUBSCRIPTION PAID': 'date_subscription_paid',
          'NATIONAL ID COUNTRY': 'national_id_country',
          'NATIONAL ID': 'national_id',
          'CARD NUMBER': 'card_number',
          'DATE OF BIRTH': 'date_of_birth',
          'LOCKER NUMBER': 'locker_number',
          'DEFAULT PAYMENT METHOD': 'default_payment_method',
          'SUBSCRIPTION TEMPLATE': 'subscription_template',
          'ACCOUNT BALANCE': 'account_balance',
          'ACCOUNT NOTES': 'account_notes',
          'SEND INVOICE BY': 'send_invoice_by',
          'COMPETITION FEE PURSE': 'competition_fee_purse',
          'NOTES': 'notes',
          'ELECTRONIC COMMUNICATION CONSENT': 'electronic_communication_consent',
          'DATE COMMUNICATION CONSENT CHANGED': 'date_communication_consent_changed',
          'PARENTAL CONSENT': 'parental_consent',
          'DATA PROTECTION NOTES': 'data_protection_notes',
          'ADDITIONAL LOCKER': 'additional_locker',
          'USER FIELD 2': 'user_field_2',
          'USER FIELD 3': 'user_field_3',
          'ACCOUNT ID': 'account_id'
        };

        // If replace mode, clear existing members
        if (mode === 'replace') {
          await db.prepare('DELETE FROM members').run();
        }

        // Process each row
        for (let i = 1; i < lines.length; i++) {
          const values = parseCSVLine(lines[i]);
          if (values.length < 3) continue; // Skip empty rows

          const member: Record<string, any> = {};

          for (let j = 0; j < header.length; j++) {
            const csvCol = header[j].trim();
            const dbCol = columnMap[csvCol];
            if (dbCol && values[j] !== undefined) {
              let value = values[j].trim();

              // Clean up currency values
              if (dbCol === 'account_balance' || dbCol === 'competition_fee_purse') {
                value = value.replace(/[Â£\-,]/g, '').trim();
                member[dbCol] = parseFloat(value) || 0;
              } else if (dbCol === 'handicap_index') {
                member[dbCol] = value ? parseFloat(value) : null;
              } else if (value) {
                // Convert date formats from DD/MM/YYYY to YYYY-MM-DD
                if (dbCol.startsWith('date_') && value.includes('/')) {
                  const parts = value.split('/');
                  if (parts.length === 3) {
                    value = `${parts[2]}-${parts[1].padStart(2, '0')}-${parts[0].padStart(2, '0')}`;
                  }
                }
                member[dbCol] = value;
              }
            }
          }

          // Skip if no surname or first_name
          if (!member.surname || !member.first_name) {
            skippedCount++;
            continue;
          }

          // Check for existing member (by email or name+dob)
          let existingId = null;
          if (member.email) {
            const existing = await db.prepare(
              'SELECT id FROM members WHERE email = ?'
            ).bind(member.email).first();
            existingId = existing?.id;
          }

          if (!existingId && member.surname && member.first_name) {
            const existing = await db.prepare(
              'SELECT id FROM members WHERE surname = ? AND first_name = ? AND (date_of_birth = ? OR date_of_birth IS NULL)'
            ).bind(member.surname, member.first_name, member.date_of_birth || null).first();
            existingId = existing?.id;
          }

          if (existingId && mode === 'skip') {
            skippedCount++;
            continue;
          }

          if (existingId && mode === 'update') {
            // Update existing member
            const setClauses = Object.keys(member).map(k => `${k} = ?`).join(', ');
            const updateValues = Object.values(member);
            await db.prepare(
              `UPDATE members SET ${setClauses}, updated_at = datetime('now') WHERE id = ?`
            ).bind(...updateValues, existingId).run();
            importedCount++;
          } else {
            // Insert new member
            const columns = Object.keys(member);
            const placeholders = columns.map(() => '?').join(', ');
            const insertValues = Object.values(member);
            await db.prepare(
              `INSERT INTO members (${columns.join(', ')}) VALUES (${placeholders})`
            ).bind(...insertValues).run();
            importedCount++;
          }
        }

        success = `Import complete: ${importedCount} members imported, ${skippedCount} skipped`;

        // Log the import
        await db.prepare(
          `INSERT INTO audit_log (user_email, action, entity_type, details)
           VALUES (?, 'import', 'member', ?)`
        ).bind(
          Astro.locals.user?.email || 'system',
          JSON.stringify({ imported: importedCount, skipped: skippedCount, mode })
        ).run();
      }
    } catch (e: any) {
      error = `Import failed: ${e.message}`;
    }
  }
}

// Simple CSV line parser
function parseCSVLine(line: string): string[] {
  const result: string[] = [];
  let current = '';
  let inQuotes = false;

  for (let i = 0; i < line.length; i++) {
    const char = line[i];

    if (char === '"') {
      if (inQuotes && line[i + 1] === '"') {
        current += '"';
        i++;
      } else {
        inQuotes = !inQuotes;
      }
    } else if (char === ',' && !inQuotes) {
      result.push(current);
      current = '';
    } else {
      current += char;
    }
  }
  result.push(current);

  return result;
}
---

<AdminLayout title="Import Members">
  <div style="display: flex; gap: 1rem; margin-bottom: 1.5rem;">
    <a href="/members" class="btn btn-secondary">&larr; Back to Members</a>
  </div>

  {error && <div class="alert alert-error">{error}</div>}
  {success && <div class="alert alert-success">{success}</div>}

  <div class="card">
    <div class="card-header">
      <h3 class="card-title">Import Members from CSV</h3>
    </div>

    <p style="margin-bottom: 1rem; color: #666;">
      Upload a CSV file in the same format as your member export.
      The file should have a header row with column names.
    </p>

    <form method="POST" enctype="multipart/form-data">
      <div class="form-group">
        <label class="form-label" for="csvfile">CSV File</label>
        <input type="file" name="csvfile" id="csvfile" accept=".csv" class="form-input" required />
      </div>

      <div class="form-group">
        <label class="form-label" for="mode">Import Mode</label>
        <select name="mode" id="mode" class="form-input">
          <option value="skip">Skip existing members (match by email or name+DOB)</option>
          <option value="update">Update existing members with new data</option>
          <option value="replace">Replace all members (delete existing first)</option>
        </select>
        <p style="font-size: 0.75rem; color: #666; margin-top: 0.25rem;">
          Warning: "Replace all" will permanently delete all existing member records!
        </p>
      </div>

      <button type="submit" class="btn btn-primary">Import Members</button>
    </form>
  </div>

  <div class="card">
    <div class="card-header">
      <h3 class="card-title">Expected CSV Format</h3>
    </div>

    <p style="font-size: 0.875rem; color: #666;">
      The CSV should have these columns (order doesn't matter, not all are required):
    </p>

    <div style="font-family: monospace; font-size: 0.75rem; background: #f4f4f4; padding: 1rem; border-radius: 4px; overflow-x: auto; margin-top: 1rem;">
      SURNAME, FIRST NAME, GENDER, AGE GROUP, HANDICAP INDEX, HOME/AWAY/VISITOR,
      HOME CLUB, PIN, TITLE, ADDRESS 1-5, TELEPHONE 1-3, E-MAIL ADDRESS,
      CLUB NUMBER, CATEGORY, DATE JOINED, DATE EXPIRES, NATIONAL ID, etc.
    </div>

    <p style="font-size: 0.875rem; color: #666; margin-top: 1rem;">
      <strong>Required columns:</strong> SURNAME, FIRST NAME
    </p>
  </div>
</AdminLayout>
