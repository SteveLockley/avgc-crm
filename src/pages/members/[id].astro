---
import AdminLayout from '../../layouts/AdminLayout.astro';
import { formatDate, formatCurrency, getFullName, getFullAddress, isExpired, expiresSoon } from '../../lib/db';

const { id } = Astro.params;
const db = Astro.locals.runtime.env.DB;

// Get member details
const member = await db.prepare(
  'SELECT * FROM members WHERE id = ?'
).bind(id).first();

if (!member) {
  return Astro.redirect('/members');
}

// Get payment history
const payments = await db.prepare(
  `SELECT * FROM payments WHERE member_id = ? ORDER BY payment_date DESC LIMIT 20`
).bind(id).all();

// Get subscription history
const subscriptions = await db.prepare(
  `SELECT * FROM subscription_history WHERE member_id = ? ORDER BY start_date DESC`
).bind(id).all();

const expired = isExpired(member.date_expires as string);
const expiring = expiresSoon(member.date_expires as string);
---

<AdminLayout title={`${member.first_name} ${member.surname}`}>
  <div style="display: flex; gap: 1rem; margin-bottom: 1.5rem;">
    <button type="button" onclick="history.back()" class="btn btn-secondary">&larr; Back</button>
    <a href={`/members/${id}/edit`} class="btn btn-primary">Edit Member</a>
    <a href={`/payments/new?member_id=${id}`} class="btn btn-secondary">Record Payment</a>
  </div>

  <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 1.5rem;">
    <!-- Main details -->
    <div>
      <div class="card">
        <div class="card-header">
          <h3 class="card-title">Member Details</h3>
          <span class={`badge ${expired ? 'badge-danger' : expiring ? 'badge-warning' : 'badge-success'}`}>
            {expired ? 'Expired' : expiring ? 'Expiring Soon' : 'Active'}
          </span>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Name</label>
            <div>{getFullName(member as any)}</div>
          </div>
          <div class="form-group">
            <label class="form-label">Gender</label>
            <div>{member.gender === 'M' ? 'Male' : member.gender === 'F' ? 'Female' : '-'}</div>
          </div>
          <div class="form-group">
            <label class="form-label">Date of Birth</label>
            <div>{formatDate(member.date_of_birth as string) || '-'}</div>
          </div>
          <div class="form-group">
            <label class="form-label">Age Group</label>
            <div>{member.age_group || '-'}</div>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Email</label>
            <div>
              {member.email ? (
                <a href={`mailto:${member.email}`}>{member.email}</a>
              ) : '-'}
            </div>
          </div>
          <div class="form-group">
            <label class="form-label">Phone</label>
            <div>
              {member.telephone_1 || member.telephone_2 || member.telephone_3 || '-'}
              {member.telephone_2 && member.telephone_1 && <span style="color: #666;"> / {member.telephone_2}</span>}
            </div>
          </div>
        </div>

        <div class="form-group">
          <label class="form-label">Address</label>
          <div>{getFullAddress(member as any) || '-'}</div>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <h3 class="card-title">Membership Information</h3>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Category</label>
            <div>{member.category || '-'}</div>
          </div>
          <div class="form-group">
            <label class="form-label">Subscription</label>
            <div>{member.subscription_template || '-'}</div>
          </div>
          <div class="form-group">
            <label class="form-label">Home/Away</label>
            <div>
              <span class={`badge ${member.home_away === 'H' ? 'badge-success' : 'badge-info'}`}>
                {member.home_away === 'H' ? 'Home' : member.home_away === 'A' ? 'Away' : member.home_away || '-'}
              </span>
            </div>
          </div>
          <div class="form-group">
            <label class="form-label">Home Club</label>
            <div>{member.home_club || '-'}</div>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Date Joined</label>
            <div>{formatDate(member.date_joined as string) || '-'}</div>
          </div>
          <div class="form-group">
            <label class="form-label">Date Renewed</label>
            <div>{formatDate(member.date_renewed as string) || '-'}</div>
          </div>
          <div class="form-group">
            <label class="form-label">Date Expires</label>
            <div class={expired ? 'badge badge-danger' : expiring ? 'badge badge-warning' : ''}>
              {formatDate(member.date_expires as string) || '-'}
            </div>
          </div>
          <div class="form-group">
            <label class="form-label">Subscription Paid</label>
            <div>{formatDate(member.date_subscription_paid as string) || '-'}</div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <h3 class="card-title">Golf Information</h3>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Handicap Index</label>
            <div style="font-size: 1.5rem; font-weight: 600; color: #1e5631;">
              {member.handicap_index ?? 'N/A'}
            </div>
          </div>
          <div class="form-group">
            <label class="form-label">WHS National ID</label>
            <div>{member.national_id || '-'}</div>
          </div>
          <div class="form-group">
            <label class="form-label">Country</label>
            <div>{member.national_id_country || '-'}</div>
          </div>
        </div>
      </div>

      <!-- Payment History -->
      <div class="card">
        <div class="card-header">
          <h3 class="card-title">Payment History</h3>
          <a href={`/payments/new?member_id=${id}`} class="btn btn-secondary btn-sm">Record Payment</a>
        </div>

        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>Date</th>
                <th>Type</th>
                <th>Method</th>
                <th>Reference</th>
                <th style="text-align: right;">Amount</th>
              </tr>
            </thead>
            <tbody>
              {payments.results?.map((payment) => (
                <tr>
                  <td>{formatDate(payment.payment_date as string)}</td>
                  <td>{payment.payment_type || '-'}</td>
                  <td>{payment.payment_method || '-'}</td>
                  <td>{payment.reference || '-'}</td>
                  <td style="text-align: right; font-weight: 500;">
                    {formatCurrency(payment.amount as number)}
                  </td>
                </tr>
              ))}
              {(!payments.results || payments.results.length === 0) && (
                <tr>
                  <td colspan="5" style="text-align: center; color: #666;">No payment records</td>
                </tr>
              )}
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Sidebar -->
    <div>
      <div class="card">
        <div class="card-header">
          <h3 class="card-title">Financial</h3>
        </div>

        <div class="form-group">
          <label class="form-label">Account Balance</label>
          <div style={`font-size: 1.5rem; font-weight: 600; ${(member.account_balance as number) < 0 ? 'color: #dc3545' : 'color: #28a745'}`}>
            {formatCurrency(member.account_balance as number)}
          </div>
        </div>

        <div class="form-group">
          <label class="form-label">Competition Fee Purse</label>
          <div style="font-size: 1.25rem;">
            {formatCurrency(member.competition_fee_purse as number)}
          </div>
        </div>

        <div class="form-group">
          <label class="form-label">Payment Method</label>
          <div>{member.default_payment_method || '-'}</div>
        </div>

        <div class="form-group">
          <label class="form-label">Invoice By</label>
          <div>{member.send_invoice_by || 'Email'}</div>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <h3 class="card-title">Admin</h3>
        </div>

        <div class="form-group">
          <label class="form-label">PIN</label>
          <div>{member.pin || '-'}</div>
        </div>

        <div class="form-group">
          <label class="form-label">Club Number</label>
          <div>{member.club_number || '-'}</div>
        </div>

        <div class="form-group">
          <label class="form-label">Locker</label>
          <div>
            {member.locker_number || '-'}
            {member.additional_locker && <span> + {member.additional_locker}</span>}
          </div>
        </div>

        <div class="form-group">
          <label class="form-label">Officer Title</label>
          <div>{member.officer_title || 'Not on Committee'}</div>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <h3 class="card-title">GDPR/Consent</h3>
        </div>

        <div class="form-group">
          <label class="form-label">Electronic Communication</label>
          <div>
            <span class={`badge ${member.electronic_communication_consent === 'Yes' ? 'badge-success' : 'badge-warning'}`}>
              {member.electronic_communication_consent || 'Unknown'}
            </span>
          </div>
          {member.date_communication_consent_changed && (
            <div style="font-size: 0.75rem; color: #666; margin-top: 0.25rem;">
              Changed: {formatDate(member.date_communication_consent_changed as string)}
            </div>
          )}
        </div>

        {member.parental_consent && (
          <div class="form-group">
            <label class="form-label">Parental Consent</label>
            <div>{member.parental_consent}</div>
          </div>
        )}
      </div>

      {(member.account_notes || member.notes) && (
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">Notes</h3>
          </div>

          {member.account_notes && (
            <div class="form-group">
              <label class="form-label">Account Notes</label>
              <div style="white-space: pre-wrap; font-size: 0.875rem;">{member.account_notes}</div>
            </div>
          )}

          {member.notes && (
            <div class="form-group">
              <label class="form-label">General Notes</label>
              <div style="white-space: pre-wrap; font-size: 0.875rem;">{member.notes}</div>
            </div>
          )}
        </div>
      )}
    </div>
  </div>
</AdminLayout>
