---
import MemberLayout from '../../layouts/MemberLayout.astro';

const member = Astro.locals.member;
const db = Astro.locals.runtime?.env?.DB;

// Check for payment status from redirect
const paymentStatus = Astro.url.searchParams.get('status');

// Fetch member details including category
interface MemberDetails {
  id: number;
  first_name: string;
  surname: string;
  category: string;
  club_number: string;
}

interface SubscriptionFee {
  name: string;
  fee: number;
}

let memberDetails: MemberDetails | null = null;
let subscriptionFee: SubscriptionFee | null = null;
let outstandingInvoices: any[] = [];

if (db && member?.id) {
  try {
    // Get full member details
    memberDetails = await db.prepare(
      `SELECT id, first_name, surname, category, club_number FROM members WHERE id = ?`
    ).bind(member.id).first<MemberDetails>();

    // Get subscription fee for this member's category
    if (memberDetails?.category) {
      subscriptionFee = await db.prepare(
        `SELECT name, fee FROM payment_items
         WHERE category = 'Subscription' AND name = ? AND active = 1`
      ).bind(memberDetails.category).first<SubscriptionFee>();
    }

    // Fetch outstanding invoices
    const result = await db.prepare(
      `SELECT i.*,
              (SELECT SUM(amount) FROM invoice_items WHERE invoice_id = i.id) as total_amount
       FROM invoices i
       WHERE i.member_id = ? AND i.status IN ('pending', 'sent', 'overdue')
       ORDER BY i.created_at DESC`
    ).bind(member.id).all();
    outstandingInvoices = result.results || [];
  } catch (e) {
    console.error('Error fetching member data:', e);
  }
}

function formatCurrency(amount: number | null): string {
  if (amount === null || amount === undefined) return '£0.00';
  return new Intl.NumberFormat('en-GB', {
    style: 'currency',
    currency: 'GBP'
  }).format(amount / 100);
}

function formatCurrencyPounds(amount: number | null): string {
  if (amount === null || amount === undefined) return '£0.00';
  return new Intl.NumberFormat('en-GB', {
    style: 'currency',
    currency: 'GBP'
  }).format(amount);
}

function formatDate(dateStr: string | null): string {
  if (!dateStr) return '';
  const date = new Date(dateStr);
  return date.toLocaleDateString('en-GB', {
    day: 'numeric',
    month: 'long',
    year: 'numeric'
  });
}

const memberId = memberDetails?.id || member?.id;
const memberNumber = memberDetails?.club_number || memberId;
const memberName = memberDetails ? `${memberDetails.first_name} ${memberDetails.surname}` : `${member?.firstName} ${member?.surname}`;
const memberCategory = memberDetails?.category || 'Member';
const annualFee = subscriptionFee?.fee || null;
const currentYear = new Date().getFullYear();
---

<MemberLayout title="Make a Payment">
  <div class="payments-page">
    {paymentStatus === 'complete' && (
      <div class="alert alert-success">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
          <polyline points="22 4 12 14.01 9 11.01"/>
        </svg>
        <div>
          <strong>Payment Submitted</strong>
          <p>Thank you! Your payment has been submitted for processing. You will receive a confirmation email shortly.</p>
        </div>
      </div>
    )}

    <div class="payments-intro">
      <p>Make secure online payments for your membership subscriptions and other club fees using our DOJO payment system.</p>
    </div>

    {outstandingInvoices.length > 0 && (
      <div class="outstanding-section">
        <h2>Outstanding Invoices</h2>
        <div class="invoice-list">
          {outstandingInvoices.map(invoice => (
            <div class="invoice-card">
              <div class="invoice-info">
                <span class="invoice-number">Invoice #{invoice.invoice_number || invoice.id}</span>
                <span class="invoice-period">{invoice.period}</span>
                {invoice.due_date && (
                  <span class="invoice-due">Due: {formatDate(invoice.due_date)}</span>
                )}
              </div>
              <div class="invoice-actions">
                <span class="amount">{formatCurrency(invoice.total_amount)}</span>
                <button
                  type="button"
                  class="btn btn-pay"
                  data-amount={invoice.total_amount}
                  data-reference={`INV-${invoice.invoice_number || invoice.id}`}
                  data-description={`Invoice ${invoice.invoice_number || invoice.id} - ${invoice.period || 'Payment'}`}
                >
                  Pay Now
                </button>
              </div>
            </div>
          ))}
        </div>
      </div>
    )}

    <div class="payment-options">
      <div class="payment-card primary">
        <div class="payment-icon">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="1" y="4" width="22" height="16" rx="2" ry="2"/>
            <line x1="1" y1="10" x2="23" y2="10"/>
          </svg>
        </div>
        <h2>Pay Online with DOJO</h2>
        <p>Make a secure payment online using your debit or credit card. All major cards accepted.</p>

        {annualFee && (
          <div class="subscription-payment">
            <div class="subscription-details">
              <span class="subscription-label">Annual Subscription</span>
              <span class="subscription-type">{memberCategory} Membership {currentYear}/{currentYear + 1}</span>
              <span class="subscription-member">{memberName} (#{memberNumber})</span>
            </div>
            <div class="subscription-amount">{formatCurrencyPounds(annualFee)}</div>
            <button
              type="button"
              class="btn btn-primary btn-pay-subscription"
              data-amount={Math.round(annualFee * 100)}
              data-reference={`SUB-${memberNumber}-${currentYear}`}
              data-description={`${memberCategory} Subscription ${currentYear}/${currentYear + 1} - ${memberName} (#${memberNumber})`}
            >
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="1" y="4" width="22" height="16" rx="2" ry="2"/>
                <line x1="1" y1="10" x2="23" y2="10"/>
              </svg>
              Pay Subscription
            </button>
          </div>
        )}

        <div class="custom-payment">
          <label for="custom-description">What is this payment for?</label>
          <input
            type="text"
            id="custom-description"
            placeholder="e.g. Competition entry, Bar tab, Locker rental"
            class="description-input"
            maxlength="100"
          />
          <label for="custom-amount">Amount:</label>
          <div class="amount-input-group">
            <span class="currency-symbol">£</span>
            <input
              type="number"
              id="custom-amount"
              min="1"
              step="0.01"
              placeholder="0.00"
              class="amount-input"
            />
          </div>
          <button
            type="button"
            id="pay-custom-btn"
            class="btn btn-secondary"
          >
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="1" y="4" width="22" height="16" rx="2" ry="2"/>
              <line x1="1" y1="10" x2="23" y2="10"/>
            </svg>
            Pay Custom Amount
          </button>
        </div>

        <div class="payment-features">
          <span class="feature">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
              <polyline points="22 4 12 14.01 9 11.01"/>
            </svg>
            Visa & Mastercard
          </span>
          <span class="feature">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
              <polyline points="22 4 12 14.01 9 11.01"/>
            </svg>
            Secure & Encrypted
          </span>
          <span class="feature">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
              <polyline points="22 4 12 14.01 9 11.01"/>
            </svg>
            Instant Confirmation
          </span>
        </div>

        <div class="payment-legal">
          By making a payment you agree to our <a href="/terms">Terms &amp; Conditions</a> and <a href="/refund-policy">Refund Policy</a>. See our <a href="/privacy-policy">Privacy Policy</a> for how we handle your data. Payments are processed securely by DOJO (Paymentsense Ltd.).
        </div>
      </div>

      <div class="payment-card">
        <div class="payment-icon">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 4H3a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h18a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2z"/>
            <path d="M7 15h4"/>
            <path d="M15 15h2"/>
            <path d="M7 11h10"/>
          </svg>
        </div>
        <h2>Bank Transfer</h2>
        <p>Pay directly via bank transfer using the details below. Please use your membership number as the reference.</p>
        <div class="bank-details">
          <div class="detail-row">
            <span class="label">Bank:</span>
            <span class="value">HSBC UK Bank Plc</span>
          </div>
          <div class="detail-row">
            <span class="label">Account Name:</span>
            <span class="value">Alnmouth Village Golf Club Ltd</span>
          </div>
          <div class="detail-row">
            <span class="label">Sort Code:</span>
            <span class="value">40-34-18</span>
          </div>
          <div class="detail-row">
            <span class="label">Account Number:</span>
            <span class="value">94323203</span>
          </div>
          <div class="detail-row">
            <span class="label">Reference:</span>
            <span class="value">{memberId} {memberName}</span>
          </div>
        </div>
      </div>

      <div class="payment-card">
        <div class="payment-icon">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
            <polyline points="9 22 9 12 15 12 15 22"/>
          </svg>
        </div>
        <h2>Pay at the Clubhouse</h2>
        <p>Visit the clubhouse to make a payment in person. We accept cash, card, and cheque payments.</p>
        <div class="clubhouse-info">
          <p><strong>Opening Hours:</strong></p>
          <p>Daily: 8am - Dusk</p>
          <p class="note">Card payments available during staffed hours</p>
        </div>
      </div>
    </div>

    <div class="payment-help">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="12" cy="12" r="10"/>
        <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/>
        <line x1="12" y1="17" x2="12.01" y2="17"/>
      </svg>
      <div>
        <h4>Need Help with Payments?</h4>
        <p>If you have questions about your invoice or need assistance with payments, please contact the club office.</p>
        <div class="contact-options">
          <a href="mailto:Manager@AlnmouthVillage.Golf">Manager@AlnmouthVillage.Golf</a>
          <span>|</span>
          <a href="tel:01665830370">01665 830370</a>
        </div>
      </div>
    </div>
  </div>

  <!-- Loading overlay -->
  <div id="payment-loading" class="loading-overlay" style="display: none;">
    <div class="loading-content">
      <div class="spinner"></div>
      <p>Preparing your payment...</p>
    </div>
  </div>

  <!-- M3 Dialog -->
  <div id="m3-dialog" class="m3-dialog-overlay" style="display: none;">
    <div class="m3-dialog">
      <div class="m3-dialog-icon" id="dialog-icon">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="10"/>
          <line x1="12" y1="8" x2="12" y2="12"/>
          <line x1="12" y1="16" x2="12.01" y2="16"/>
        </svg>
      </div>
      <h3 id="dialog-title">Notice</h3>
      <p id="dialog-message"></p>
      <div class="m3-dialog-actions">
        <button type="button" class="btn btn-primary" id="dialog-ok-btn">OK</button>
      </div>
    </div>
  </div>

  <script is:inline define:vars={{ memberId, memberNumber, memberName, memberCategory }}>
    // M3 Dialog functions
    function showDialog(title, message, type = 'warning') {
      const dialog = document.getElementById('m3-dialog');
      const titleEl = document.getElementById('dialog-title');
      const messageEl = document.getElementById('dialog-message');
      const iconEl = document.getElementById('dialog-icon');

      titleEl.textContent = title;
      messageEl.textContent = message;

      // Update icon based on type
      iconEl.className = 'm3-dialog-icon ' + type;
      if (type === 'error') {
        iconEl.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>';
      } else if (type === 'success') {
        iconEl.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>';
      } else {
        iconEl.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>';
      }

      dialog.style.display = 'flex';
    }

    function closeDialog() {
      document.getElementById('m3-dialog').style.display = 'none';
    }

    async function initiatePayment(amount, reference, description) {
      const loadingEl = document.getElementById('payment-loading');
      if (loadingEl) loadingEl.style.display = 'flex';

      try {
        const response = await fetch('/api/dojo-payment', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            amount: amount,
            reference: reference || `AVGC-${memberNumber}-${Date.now()}`,
            description: description || `Payment from ${memberName} (#${memberNumber})`
          })
        });

        const data = await response.json();

        if (!response.ok) {
          throw new Error(data.error || 'Failed to create payment');
        }

        // Redirect to DOJO checkout
        window.location.href = data.checkoutUrl;
      } catch (error) {
        if (loadingEl) loadingEl.style.display = 'none';
        showDialog('Payment Error', error.message, 'error');
      }
    }

    function payWithData(button) {
      const amount = parseInt(button.dataset.amount, 10);
      const reference = button.dataset.reference;
      const description = button.dataset.description;
      initiatePayment(amount, reference, description);
    }

    function payCustomAmount() {
      const descInput = document.getElementById('custom-description');
      const amountInput = document.getElementById('custom-amount');
      const description = descInput.value.trim();
      const pounds = parseFloat(amountInput.value);

      if (!description) {
        showDialog('Description Required', 'Please enter what this payment is for', 'warning');
        descInput.focus();
        return;
      }

      if (!pounds || pounds < 1) {
        showDialog('Invalid Amount', 'Please enter an amount of at least £1.00', 'warning');
        amountInput.focus();
        return;
      }

      const pence = Math.round(pounds * 100);
      const year = new Date().getFullYear();
      initiatePayment(pence, `AVGC-${memberNumber}-${year}`, `${description} - £${pounds.toFixed(2)} - ${memberName} (#${memberNumber})`);
    }

    // Attach event listeners when DOM is ready
    document.addEventListener('DOMContentLoaded', function() {
      // Custom amount button
      const payBtn = document.getElementById('pay-custom-btn');
      if (payBtn) {
        payBtn.addEventListener('click', payCustomAmount);
      }

      // Subscription pay button
      const subBtn = document.querySelector('.btn-pay-subscription');
      if (subBtn) {
        subBtn.addEventListener('click', function() {
          payWithData(this);
        });
      }

      // Invoice pay buttons
      document.querySelectorAll('.btn-pay').forEach(function(btn) {
        btn.addEventListener('click', function() {
          payWithData(this);
        });
      });

      // Dialog close button
      const dialogOkBtn = document.getElementById('dialog-ok-btn');
      if (dialogOkBtn) {
        dialogOkBtn.addEventListener('click', closeDialog);
      }

      // Close dialog on overlay click
      const dialogOverlay = document.getElementById('m3-dialog');
      if (dialogOverlay) {
        dialogOverlay.addEventListener('click', function(e) {
          if (e.target === dialogOverlay) closeDialog();
        });
      }
    });
  </script>

  <style>
    .payments-page {
      max-width: 900px;
    }

    .alert {
      display: flex;
      gap: 1rem;
      padding: 1rem 1.25rem;
      border-radius: 12px;
      margin-bottom: 1.5rem;
    }

    .alert svg {
      width: 24px;
      height: 24px;
      flex-shrink: 0;
    }

    .alert strong {
      display: block;
      margin-bottom: 0.25rem;
    }

    .alert p {
      margin: 0;
      font-size: 0.9rem;
    }

    .alert-success {
      background: #d1fae5;
      border: 1px solid #10b981;
      color: #065f46;
    }

    .alert-success svg {
      color: #10b981;
    }

    .payments-intro {
      margin-bottom: 2rem;
    }

    .payments-intro p {
      font-size: 1.1rem;
      color: var(--text-light);
      margin: 0;
    }

    .outstanding-section {
      margin-bottom: 2rem;
    }

    .outstanding-section h2 {
      font-size: 1.1rem;
      margin: 0 0 1rem 0;
      color: var(--primary);
    }

    .invoice-list {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    .invoice-card {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem 1.25rem;
      background: #fef3c7;
      border: 1px solid #f59e0b;
      border-radius: 10px;
      flex-wrap: wrap;
      gap: 1rem;
    }

    .invoice-info {
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
    }

    .invoice-number {
      font-weight: 600;
      font-size: 0.95rem;
    }

    .invoice-period,
    .invoice-due {
      font-size: 0.85rem;
      color: #92400e;
    }

    .invoice-actions {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .amount {
      font-size: 1.25rem;
      font-weight: 700;
      color: #92400e;
    }

    .btn-pay {
      background: #1e5631;
      color: white;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 8px;
      font-weight: 600;
      font-size: 0.9rem;
      cursor: pointer;
    }

    .btn-pay:hover {
      background: #164024;
    }

    .payment-options {
      display: grid;
      grid-template-columns: 1fr;
      gap: 1.5rem;
      margin-bottom: 2rem;
    }

    @media (min-width: 768px) {
      .payment-options {
        grid-template-columns: repeat(3, 1fr);
      }
    }

    .payment-card {
      background: var(--white);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 1.5rem;
    }

    .payment-card.primary {
      background: var(--primary-light);
      border-color: var(--primary);
    }

    .payment-icon {
      width: 56px;
      height: 56px;
      background: var(--surface);
      border-radius: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 1.25rem;
    }

    .payment-card.primary .payment-icon {
      background: var(--primary);
    }

    .payment-icon svg {
      width: 28px;
      height: 28px;
      color: var(--primary);
    }

    .payment-card.primary .payment-icon svg {
      color: white;
    }

    .payment-card h2 {
      margin: 0 0 0.75rem 0;
      font-size: 1.1rem;
    }

    .payment-card > p {
      margin: 0 0 1.25rem 0;
      font-size: 0.9rem;
      color: var(--text-light);
      line-height: 1.5;
    }

    /* Subscription Payment */
    .subscription-payment {
      background: white;
      border-radius: 12px;
      padding: 1.25rem;
      margin-bottom: 1.5rem;
    }

    .subscription-details {
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
      margin-bottom: 1rem;
    }

    .subscription-label {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--text-muted);
      font-weight: 600;
    }

    .subscription-type {
      font-size: 1.1rem;
      font-weight: 600;
      color: var(--text);
    }

    .subscription-member {
      font-size: 0.9rem;
      color: var(--text-light);
    }

    .subscription-amount {
      font-size: 1.75rem;
      font-weight: 700;
      color: var(--primary);
      margin-bottom: 1rem;
    }

    .btn-pay-subscription {
      width: 100%;
      justify-content: center;
    }

    .custom-payment {
      margin-bottom: 1.25rem;
      padding-top: 1rem;
      border-top: 1px solid var(--border);
    }

    .custom-payment label {
      display: block;
      font-size: 0.9rem;
      font-weight: 500;
      margin-bottom: 0.5rem;
      color: var(--text-light);
    }

    .description-input {
      width: 100%;
      padding: 0.75rem;
      border: 1px solid var(--border);
      border-radius: 8px;
      font-size: 0.95rem;
      margin-bottom: 1rem;
    }

    .description-input:focus {
      outline: none;
      border-color: var(--primary);
    }

    .amount-input-group {
      display: flex;
      align-items: center;
      background: white;
      border: 1px solid var(--border);
      border-radius: 8px;
      margin-bottom: 0.75rem;
      overflow: hidden;
    }

    .currency-symbol {
      padding: 0.75rem;
      background: var(--surface);
      color: var(--text-light);
      font-weight: 500;
    }

    .amount-input {
      flex: 1;
      border: none;
      padding: 0.75rem;
      font-size: 1rem;
      outline: none;
    }

    .amount-input:focus {
      box-shadow: none;
    }

    .payment-features {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      margin-top: 1rem;
      padding-top: 1rem;
      border-top: 1px solid var(--border);
    }

    .feature {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.85rem;
      color: var(--text);
    }

    .feature svg {
      width: 16px;
      height: 16px;
      color: var(--primary);
    }

    .payment-legal {
      font-size: 0.8rem;
      color: var(--text-light);
      line-height: 1.6;
      margin-top: 1rem;
      padding-top: 1rem;
      border-top: 1px solid var(--border);
    }

    .payment-legal a {
      color: var(--primary);
      text-decoration: underline;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      padding: 0.875rem 1.5rem;
      border-radius: 10px;
      font-size: 0.95rem;
      font-weight: 600;
      text-decoration: none;
      width: 100%;
      border: none;
      cursor: pointer;
    }

    .btn svg {
      width: 20px;
      height: 20px;
    }

    .btn-primary {
      background: var(--primary);
      color: white;
    }

    .btn-primary:hover {
      background: var(--primary-dark);
    }

    .bank-details {
      background: var(--surface);
      border-radius: 8px;
      padding: 1rem;
    }

    .detail-row {
      display: flex;
      justify-content: space-between;
      padding: 0.5rem 0;
      border-bottom: 1px solid var(--border);
      font-size: 0.9rem;
    }

    .detail-row:last-child {
      border-bottom: none;
      padding-bottom: 0;
    }

    .detail-row:first-child {
      padding-top: 0;
    }

    .detail-row .label {
      color: var(--text-light);
    }

    .detail-row .value {
      font-weight: 500;
    }

    .clubhouse-info {
      background: var(--surface);
      border-radius: 8px;
      padding: 1rem;
      font-size: 0.9rem;
    }

    .clubhouse-info p {
      margin: 0 0 0.5rem 0;
    }

    .clubhouse-info .note {
      font-size: 0.85rem;
      color: var(--text-light);
      margin: 0;
    }

    .payment-help {
      display: flex;
      gap: 1rem;
      background: var(--surface);
      border-radius: 16px;
      padding: 1.5rem;
    }

    .payment-help > svg {
      width: 24px;
      height: 24px;
      color: var(--primary);
      flex-shrink: 0;
      margin-top: 2px;
    }

    .payment-help h4 {
      margin: 0 0 0.5rem 0;
      font-size: 1rem;
    }

    .payment-help p {
      margin: 0 0 0.75rem 0;
      font-size: 0.9rem;
      color: var(--text-light);
    }

    .contact-options {
      display: flex;
      gap: 0.75rem;
      font-size: 0.9rem;
    }

    .contact-options a {
      color: var(--primary);
      text-decoration: none;
    }

    .contact-options a:hover {
      text-decoration: underline;
    }

    .contact-options span {
      color: var(--text-light);
    }

    /* Loading overlay */
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .loading-content {
      background: white;
      padding: 2rem;
      border-radius: 16px;
      text-align: center;
    }

    .spinner {
      width: 48px;
      height: 48px;
      border: 4px solid var(--surface);
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 1rem;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .loading-content p {
      margin: 0;
      color: var(--text);
      font-weight: 500;
    }

    /* M3 Dialog */
    .m3-dialog-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1001;
      padding: 1rem;
    }

    .m3-dialog {
      background: white;
      border-radius: 28px;
      padding: 1.5rem;
      max-width: 320px;
      width: 100%;
      text-align: center;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
      animation: dialogEnter 0.2s ease-out;
    }

    @keyframes dialogEnter {
      from {
        opacity: 0;
        transform: scale(0.95);
      }
      to {
        opacity: 1;
        transform: scale(1);
      }
    }

    .m3-dialog-icon {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 1rem;
    }

    .m3-dialog-icon.warning {
      background: #fef3c7;
      color: #d97706;
    }

    .m3-dialog-icon.error {
      background: #fee2e2;
      color: #dc2626;
    }

    .m3-dialog-icon.success {
      background: #d1fae5;
      color: #059669;
    }

    .m3-dialog-icon svg {
      width: 24px;
      height: 24px;
    }

    .m3-dialog h3 {
      margin: 0 0 0.5rem 0;
      font-size: 1.25rem;
      color: var(--text);
    }

    .m3-dialog p {
      margin: 0 0 1.5rem 0;
      font-size: 0.95rem;
      color: var(--text-light);
      line-height: 1.5;
    }

    .m3-dialog-actions {
      display: flex;
      justify-content: center;
      gap: 0.75rem;
    }

    .m3-dialog-actions .btn {
      min-width: 100px;
    }
  </style>
</MemberLayout>
